---
phase: 16-per-creation-actions
plan: 16-01
title: Action dropdown with save, delete, and rerun actions
wave: 1
depends_on: []
started: null
completed: null
---

## Overview

Add a per-generation action dropdown menu to the feed with save-to-library, delete, and rerun capabilities. This requires:
1. Installing `@radix-ui/react-dropdown-menu` and creating the shadcn wrapper
2. Adding a `generations.remove` mutation (the only missing backend piece)
3. Creating the `GenerationRowActions` component (dropdown + delete confirmation dialog)
4. Restructuring `GenerationRow` from `<button>` to `<div>` (HTML spec forbids nested buttons)
5. Adding action triggers to `VariationGrid` per-variation
6. Wiring action callbacks through `GenerationFeed` into `CreatePageClient`

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/components/ui/dropdown-menu.tsx` | CREATE | shadcn/ui DropdownMenu wrapper around `@radix-ui/react-dropdown-menu` |
| `convex/generations.ts` | MODIFY | Add `remove` mutation (follows `clips.remove` pattern) |
| `src/components/generation/generation-row-actions.tsx` | CREATE | DropdownMenu + AlertDialog for delete confirmation |
| `src/components/generation/generation-row.tsx` | MODIFY | `<button>` to `<div>` restructure, add GenerationRowActions |
| `src/components/generation/variation-grid.tsx` | MODIFY | Add GenerationRowActions per-variation thumbnail |
| `src/components/generation/generation-feed.tsx` | MODIFY | Accept and pass action callbacks to rows/grids |
| `src/app/(app)/create/create-page-client.tsx` | MODIFY | Implement save, delete, rerun handlers; pass to feed |

## Implementation Steps

### Step 1: Install @radix-ui/react-dropdown-menu

```bash
npm install @radix-ui/react-dropdown-menu
```

### Step 2: Create `src/components/ui/dropdown-menu.tsx`

Create the standard shadcn/ui dropdown-menu wrapper. This is the standard shadcn dropdown-menu component that wraps `@radix-ui/react-dropdown-menu`. Use the same pattern as the existing `src/components/ui/alert-dialog.tsx` -- function components with `data-slot` attributes, `cn()` for className merging.

Export these named components:
- `DropdownMenu` (Root)
- `DropdownMenuTrigger`
- `DropdownMenuContent` -- with `sideOffset={4}` default, classes for animation, bg-popover, border, rounded-md, shadow-md, min-w-[8rem], z-50, portal-rendered
- `DropdownMenuItem` -- with classes for cursor-default, select-none, rounded-sm, px-2 py-1.5, text-sm, outline-none, focus:bg-accent, focus:text-accent-foreground, data-disabled opacity/pointer-events
- `DropdownMenuSeparator` -- -mx-1 my-1 h-px bg-muted
- `DropdownMenuLabel` -- px-2 py-1.5 text-sm font-semibold
- `DropdownMenuGroup`
- `DropdownMenuPortal`
- `DropdownMenuSub`, `DropdownMenuSubTrigger`, `DropdownMenuSubContent` (for completeness)
- `DropdownMenuCheckboxItem`, `DropdownMenuRadioGroup`, `DropdownMenuRadioItem` (for completeness)
- `DropdownMenuShortcut` -- ml-auto text-xs tracking-widest opacity-60

Use the official shadcn/ui dropdown-menu source as reference. The key styling classes:

```tsx
// Content
"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2"

// Item
"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0"
```

The DropdownMenuContent must render inside a `DropdownMenuPortal` by default (prevents clipping issues inside scrollable containers).

### Step 3: Add `generations.remove` mutation to `convex/generations.ts`

Add to existing imports at top: `mutation` (currently only imports `query, internalMutation`).

Add this mutation at the bottom of the file:

```typescript
/**
 * Remove a generation. Only the owning user can delete their generations.
 * Follows the same pattern as clips.remove.
 */
export const remove = mutation({
  args: {
    id: v.id("generations"),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Not authenticated");
    }

    const generation = await ctx.db.get(args.id);
    if (!generation || generation.userId !== identity.tokenIdentifier) {
      throw new Error("Generation not found");
    }

    await ctx.db.delete(args.id);
  },
});
```

Important: Update the import line from:
```typescript
import { query, internalMutation } from "./_generated/server";
```
to:
```typescript
import { query, mutation, internalMutation } from "./_generated/server";
```

### Step 4: Create `src/components/generation/generation-row-actions.tsx`

This is the core action dropdown component. It renders a three-dot menu trigger button (MoreHorizontal icon from lucide-react) and a dropdown menu with Save, Rerun, and Delete actions. The delete action opens an AlertDialog for confirmation.

**CRITICAL: AlertDialog must be a sibling of DropdownMenu, NOT nested inside DropdownMenuContent.** Radix renders DropdownMenuContent inside a portal. If AlertDialog is inside the portal too, the two portals conflict and the dialog may not render correctly.

**CRITICAL: Use `onSelect` (not `onClick`) on DropdownMenuItem for proper keyboard accessibility.** The `onSelect` handler fires on both click and keyboard Enter/Space, then auto-closes the menu.

Props interface:

```typescript
interface Generation {
  _id: string;
  prompt: string;
  code?: string;
  rawCode?: string;
  durationInFrames?: number;
  fps?: number;
  aspectRatio?: string;
  durationInSeconds?: number;
  status: "success" | "failed";
  errorMessage?: string;
  createdAt: number;
  batchId?: string;
  variationIndex?: number;
  variationCount?: number;
}

interface GenerationRowActionsProps {
  generation: Generation;
  onSave: (generation: Generation) => void;
  onDelete: (generation: Generation) => void;
  onRerun: (generation: Generation) => void;
}
```

Component structure:

```tsx
"use client";

import { useState } from "react";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Button } from "@/components/ui/button";
import { MoreHorizontal, Save, RotateCcw, Trash2 } from "lucide-react";

export function GenerationRowActions({
  generation,
  onSave,
  onDelete,
  onRerun,
}: GenerationRowActionsProps) {
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const isFailed = generation.status === "failed";

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button
            variant="ghost"
            size="icon"
            className="h-8 w-8 shrink-0"
            onClick={(e) => e.stopPropagation()}
          >
            <MoreHorizontal className="h-4 w-4" />
            <span className="sr-only">Actions</span>
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem
            onSelect={() => onSave(generation)}
            disabled={isFailed || !generation.code}
          >
            <Save className="h-4 w-4 mr-2" />
            Save to Library
          </DropdownMenuItem>
          <DropdownMenuItem onSelect={() => onRerun(generation)}>
            <RotateCcw className="h-4 w-4 mr-2" />
            Rerun
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem
            className="text-destructive focus:text-destructive"
            onSelect={() => setShowDeleteConfirm(true)}
          >
            <Trash2 className="h-4 w-4 mr-2" />
            Delete
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>

      <AlertDialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete generation?</AlertDialogTitle>
            <AlertDialogDescription>
              This will permanently delete this generation. This cannot be undone.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
              onClick={() => {
                onDelete(generation);
                setShowDeleteConfirm(false);
              }}
            >
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

The `onClick={(e) => e.stopPropagation()}` on the trigger button prevents the click from propagating to the row's click handler (which selects the generation for preview).

### Step 5: Modify `src/components/generation/generation-row.tsx`

Two changes:

**A) Restructure wrapper from `<button>` to `<div>` with inner clickable area:**

The current component wraps everything in a single `<button>`. Since `GenerationRowActions` contains buttons, this creates invalid HTML (button-inside-button). Change the outer `<button>` to a `<div>`, and make the content area clickable instead.

Replace the outer `<button>` with:

```tsx
<div className="w-full flex flex-row gap-4 p-3 rounded-lg border hover:bg-muted/50 transition-colors text-left">
```

Wrap the thumbnail and metadata sections (everything except the actions) in a clickable `<button>`:

```tsx
<button
  type="button"
  className="flex flex-row gap-4 flex-1 min-w-0 text-left"
  onClick={() => onSelect(generation)}
>
  {/* Thumbnail */}
  ...
  {/* Metadata */}
  ...
</button>
```

**B) Add GenerationRowActions next to the metadata:**

Add the action menu as the last child inside the outer `<div>`, AFTER the clickable button area:

```tsx
<div className="flex items-start pt-1">
  <GenerationRowActions
    generation={generation}
    onSave={onSave}
    onDelete={onDelete}
    onRerun={onRerun}
  />
</div>
```

**C) Update props interface to accept action callbacks:**

```typescript
interface GenerationRowProps {
  generation: { /* existing type unchanged */ };
  onSelect: (generation: GenerationRowProps["generation"]) => void;
  onSave: (generation: GenerationRowProps["generation"]) => void;
  onDelete: (generation: GenerationRowProps["generation"]) => void;
  onRerun: (generation: GenerationRowProps["generation"]) => void;
}
```

Import `GenerationRowActions` from `./generation-row-actions`.

### Step 6: Modify `src/components/generation/variation-grid.tsx`

Add per-variation action buttons. Each variation thumbnail in the grid gets a small action trigger overlaid in the top-right corner (opposite the V{n} badge which is top-left).

**A) Update `VariationGridProps` to accept action callbacks:**

```typescript
interface VariationGridProps {
  variations: Generation[];
  onSelectVariation: (generation: Generation) => void;
  onSave: (generation: Generation) => void;
  onDelete: (generation: Generation) => void;
  onRerun: (generation: Generation) => void;
}
```

**B) Add an action trigger to each variation thumbnail:**

Inside the `.map()` for each variation, after the V{n} badge span, add:

```tsx
{/* Action menu - top right corner */}
<div
  className="absolute top-1 right-1 opacity-0 group-hover/variation:opacity-100 transition-opacity"
  onClick={(e) => e.stopPropagation()}
>
  <GenerationRowActions
    generation={variation}
    onSave={onSave}
    onDelete={onDelete}
    onRerun={onRerun}
  />
</div>
```

Also add `group/variation` class to each variation's `<button>` element so the hover detection works:

```tsx
<button
  key={variation._id}
  type="button"
  className="relative rounded-md overflow-hidden bg-black hover:ring-2 hover:ring-primary/50 transition-all group/variation"
  ...
>
```

**C) Also add a batch-level action row.** In the metadata row (above the grid), add an action dropdown for the first variation (acting as the batch-level action). Place it in the top-right area where the timestamp currently is:

```tsx
<div className="flex items-center gap-2">
  <p className="text-xs text-muted-foreground whitespace-nowrap">
    {formatRelativeTime(firstVariation.createdAt)}
  </p>
  <GenerationRowActions
    generation={firstVariation}
    onSave={onSave}
    onDelete={onDelete}
    onRerun={onRerun}
  />
</div>
```

Import `GenerationRowActions` from `./generation-row-actions`.

### Step 7: Modify `src/components/generation/generation-feed.tsx`

**A) Expand the props interface:**

```typescript
interface GenerationFeedProps {
  onSelectGeneration: (generation: any) => void;
  onSaveGeneration: (generation: any) => void;
  onDeleteGeneration: (generation: any) => void;
  onRerunGeneration: (generation: any) => void;
}
```

**B) Destructure new props:**

```typescript
export function GenerationFeed({
  onSelectGeneration,
  onSaveGeneration,
  onDeleteGeneration,
  onRerunGeneration,
}: GenerationFeedProps) {
```

**C) Pass callbacks to GenerationRow and VariationGrid:**

For single generation rows:
```tsx
<GenerationRow
  key={gen._id}
  generation={gen}
  onSelect={onSelectGeneration}
  onSave={onSaveGeneration}
  onDelete={onDeleteGeneration}
  onRerun={onRerunGeneration}
/>
```

For variation grids:
```tsx
<VariationGrid
  key={batch.batchId!}
  variations={batch.generations}
  onSelectVariation={onSelectGeneration}
  onSave={onSaveGeneration}
  onDelete={onDeleteGeneration}
  onRerun={onRerunGeneration}
/>
```

### Step 8: Wire action handlers in `src/app/(app)/create/create-page-client.tsx`

Add three new handler functions inside `CreateContent` and pass them to `GenerationFeed`.

**A) Add imports at top:**

```typescript
import { useMutation, useAction } from "convex/react";  // already imported
// Add to lucide imports if needed: RotateCcw (but likely not needed in this file)
```

**B) Add the delete mutation hook (near other hooks at top of CreateContent):**

```typescript
const removeGeneration = useMutation(api.generations.remove);
const saveClip = useMutation(api.clips.save);
```

Note: `saveClip` may already be available if `SaveClipDialog` doesn't handle its own mutation. Check -- `SaveClipDialog` manages its own `useMutation(api.clips.save)` internally. For the feed "Save to Library" action we need our own hook since we bypass the dialog for a quicker save (auto-name from prompt).

**C) Add handler: `handleSaveGeneration`**

This does a direct save without showing the SaveClipDialog -- auto-names from prompt text (truncated to 50 chars).

```typescript
const handleSaveGeneration = useCallback(async (generation: any) => {
  if (!generation.code || !generation.rawCode) {
    toast.error("Cannot save: generation has no code");
    return;
  }
  try {
    await saveClip({
      name: generation.prompt.slice(0, 50) || "Untitled",
      code: generation.code,
      rawCode: generation.rawCode,
      durationInFrames: generation.durationInFrames ?? 90,
      fps: generation.fps ?? 30,
    });
    toast.success("Saved to clip library!");
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to save clip");
  }
}, [saveClip]);
```

**D) Add handler: `handleDeleteGeneration`**

```typescript
const handleDeleteGeneration = useCallback(async (generation: any) => {
  try {
    await removeGeneration({ id: generation._id as any });
    toast.success("Generation deleted");
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to delete generation");
  }
}, [removeGeneration]);
```

**E) Add handler: `handleRerunGeneration`**

Rerun must preserve ALL original settings. Detect batch generations via `variationCount` field. If `variationCount > 1`, use `generateVariationsAction`; otherwise use `generate`.

```typescript
const handleRerunGeneration = useCallback(async (generation: any) => {
  const prompt = generation.prompt;
  if (!prompt) {
    toast.error("Cannot rerun: no prompt found");
    return;
  }

  // Clear current view state to show generating UI
  setLastGeneration(null);
  setError(null);
  setIsGenerating(true);
  setIsEditing(false);
  setEditedCode(null);
  setSkipValidation(true);
  validation.resetToValid();
  setChatMessages([]);

  setCurrentStep("analyzing");
  await new Promise((r) => setTimeout(r, 500));
  setCurrentStep("generating");

  try {
    const aspectRatio = generation.aspectRatio ?? "16:9";
    const durationInSeconds = generation.durationInSeconds ?? 3;
    const fps = generation.fps ?? 30;
    const variationCount = generation.variationCount ?? 1;
    const referenceImageIds = generation.referenceImageIds;

    if (variationCount > 1) {
      const result = await generateVariationsAction({
        prompt,
        variationCount,
        aspectRatio,
        durationInSeconds,
        fps,
        ...(referenceImageIds ? { referenceImageIds } : {}),
      });

      setCurrentStep("validating");
      await new Promise((r) => setTimeout(r, 300));

      const firstSuccess = result.variations[0];
      if (firstSuccess) {
        setLastGeneration({
          id: firstSuccess.id,
          rawCode: firstSuccess.rawCode,
          code: firstSuccess.code,
          durationInFrames: firstSuccess.durationInFrames,
          fps: firstSuccess.fps,
        });
        setLastPrompt(prompt);
        toast.success(`Rerun complete: ${result.variations.length} variation(s) generated!`);
      } else {
        throw new Error("All variations failed");
      }
    } else {
      const result = await generate({
        prompt,
        aspectRatio,
        durationInSeconds,
        fps,
        ...(referenceImageIds ? { referenceImageIds } : {}),
      });

      setCurrentStep("validating");
      await new Promise((r) => setTimeout(r, 300));

      if (!result?.code) throw new Error("Rerun did not return code");

      setLastGeneration({
        id: String(result.id),
        rawCode: result.rawCode,
        code: result.code,
        durationInFrames: result.durationInFrames ?? 90,
        fps: result.fps ?? 30,
      });
      setLastPrompt(prompt);
      toast.success("Rerun complete!");
    }
  } catch (e) {
    const msg = e instanceof Error ? e.message : "Rerun failed";
    setError({ message: msg, retryCount: 0 });
    toast.error("Rerun failed");
  } finally {
    setIsGenerating(false);
    setCurrentStep(null);
  }
}, [generate, generateVariationsAction, validation]);
```

**F) Update GenerationFeed usage in JSX:**

Change:
```tsx
<GenerationFeed onSelectGeneration={handleSelectGeneration} />
```
To:
```tsx
<GenerationFeed
  onSelectGeneration={handleSelectGeneration}
  onSaveGeneration={handleSaveGeneration}
  onDeleteGeneration={handleDeleteGeneration}
  onRerunGeneration={handleRerunGeneration}
/>
```

## Verification

1. **TypeScript compilation**: Run `npx tsc --noEmit` -- must pass with zero errors
2. **Convex codegen**: Run `npx convex dev` (or check that `convex/_generated/api.d.ts` includes `generations.remove`) -- the new mutation must appear in the generated API types
3. **Visual check**: Open the create page, see past generations in the feed. Each row should show a three-dot menu on the right. Clicking it should show Save to Library, Rerun, and Delete options.
4. **Save action**: Click "Save to Library" on a successful generation. Should see "Saved to clip library!" toast. Check Library page -- clip should appear with auto-generated name from prompt.
5. **Delete action**: Click "Delete" on a generation. Should see confirmation dialog "Delete generation?". Clicking "Delete" should remove it from the feed and show "Generation deleted" toast.
6. **Rerun action**: Click "Rerun" on a generation. Should trigger a new generation with the same prompt and settings (aspect ratio, duration, fps, variation count). The generating state should appear, then the result.

## Commit Message Template

```
feat(16-01): add per-generation action dropdown with save, delete, and rerun

- Install @radix-ui/react-dropdown-menu, create shadcn dropdown-menu.tsx
- Add generations.remove mutation (mirrors clips.remove pattern)
- Create GenerationRowActions component (dropdown + delete confirmation)
- Restructure GenerationRow from <button> to <div> for valid HTML nesting
- Add per-variation action triggers in VariationGrid
- Wire save/delete/rerun handlers through feed into create page
```
