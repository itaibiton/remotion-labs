---
phase: 16-per-creation-actions
plan: 16-02
title: Extend-next action wiring (continuation from feed)
wave: 2
depends_on: ["16-01"]
started: null
completed: null
---

## Overview

Add "Extend Next" as a menu item in the `GenerationRowActions` dropdown. When clicked, it auto-saves the generation as a clip (via `clips.save` mutation), then navigates to `/create?sourceClipId=<clipId>` to enter continuation mode. This reuses the existing continuation generation infrastructure built in Phase 12.

"Extend Previous" is NOT added in this plan. Phase 17 builds the prequel generation backend -- the button will be added there when there is actual functionality to wire to. A disabled placeholder adds visual noise for no benefit.

## Files to Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/components/generation/generation-row-actions.tsx` | MODIFY | Add "Extend Next" menu item |
| `src/components/generation/generation-row.tsx` | MODIFY | Pass `onExtendNext` callback to actions |
| `src/components/generation/variation-grid.tsx` | MODIFY | Pass `onExtendNext` callback to actions |
| `src/components/generation/generation-feed.tsx` | MODIFY | Accept and pass `onExtendNextGeneration` callback |
| `src/app/(app)/create/create-page-client.tsx` | MODIFY | Implement extend-next handler (save-then-navigate) |

## Implementation Steps

### Step 1: Modify `src/components/generation/generation-row-actions.tsx`

**A) Add `onExtendNext` to the props interface:**

```typescript
interface GenerationRowActionsProps {
  generation: Generation;
  onSave: (generation: Generation) => void;
  onDelete: (generation: Generation) => void;
  onRerun: (generation: Generation) => void;
  onExtendNext: (generation: Generation) => void;
}
```

**B) Add the "Extend Next" menu item.**

Import `FastForward` from `lucide-react` (add to existing import).

Add the menu item AFTER the "Save to Library" item and BEFORE the "Rerun" item:

```tsx
<DropdownMenuItem
  onSelect={() => onExtendNext(generation)}
  disabled={isFailed || !generation.code}
>
  <FastForward className="h-4 w-4 mr-2" />
  Extend Next
</DropdownMenuItem>
```

The full menu order becomes:
1. Save to Library
2. Extend Next
3. Rerun
4. --- (separator)
5. Delete

### Step 2: Modify `src/components/generation/generation-row.tsx`

**A) Add `onExtendNext` to props interface:**

```typescript
interface GenerationRowProps {
  generation: { /* existing type */ };
  onSelect: (generation: GenerationRowProps["generation"]) => void;
  onSave: (generation: GenerationRowProps["generation"]) => void;
  onDelete: (generation: GenerationRowProps["generation"]) => void;
  onRerun: (generation: GenerationRowProps["generation"]) => void;
  onExtendNext: (generation: GenerationRowProps["generation"]) => void;
}
```

**B) Destructure and pass to `GenerationRowActions`:**

```tsx
export function GenerationRow({
  generation,
  onSelect,
  onSave,
  onDelete,
  onRerun,
  onExtendNext,
}: GenerationRowProps) {
  // ...
  <GenerationRowActions
    generation={generation}
    onSave={onSave}
    onDelete={onDelete}
    onRerun={onRerun}
    onExtendNext={onExtendNext}
  />
}
```

### Step 3: Modify `src/components/generation/variation-grid.tsx`

**A) Add `onExtendNext` to props interface:**

```typescript
interface VariationGridProps {
  variations: Generation[];
  onSelectVariation: (generation: Generation) => void;
  onSave: (generation: Generation) => void;
  onDelete: (generation: Generation) => void;
  onRerun: (generation: Generation) => void;
  onExtendNext: (generation: Generation) => void;
}
```

**B) Pass to all `GenerationRowActions` instances (both per-variation and batch-level):**

```tsx
<GenerationRowActions
  generation={variation}
  onSave={onSave}
  onDelete={onDelete}
  onRerun={onRerun}
  onExtendNext={onExtendNext}
/>
```

### Step 4: Modify `src/components/generation/generation-feed.tsx`

**A) Add `onExtendNextGeneration` to props interface:**

```typescript
interface GenerationFeedProps {
  onSelectGeneration: (generation: any) => void;
  onSaveGeneration: (generation: any) => void;
  onDeleteGeneration: (generation: any) => void;
  onRerunGeneration: (generation: any) => void;
  onExtendNextGeneration: (generation: any) => void;
}
```

**B) Destructure and pass through:**

```tsx
export function GenerationFeed({
  onSelectGeneration,
  onSaveGeneration,
  onDeleteGeneration,
  onRerunGeneration,
  onExtendNextGeneration,
}: GenerationFeedProps) {
```

Pass to `GenerationRow`:
```tsx
<GenerationRow
  key={gen._id}
  generation={gen}
  onSelect={onSelectGeneration}
  onSave={onSaveGeneration}
  onDelete={onDeleteGeneration}
  onRerun={onRerunGeneration}
  onExtendNext={onExtendNextGeneration}
/>
```

Pass to `VariationGrid`:
```tsx
<VariationGrid
  key={batch.batchId!}
  variations={batch.generations}
  onSelectVariation={onSelectGeneration}
  onSave={onSaveGeneration}
  onDelete={onDeleteGeneration}
  onRerun={onRerunGeneration}
  onExtendNext={onExtendNextGeneration}
/>
```

### Step 5: Implement extend-next handler in `src/app/(app)/create/create-page-client.tsx`

**A) The `saveClip` mutation hook should already exist from 16-01.** Confirm it is present:

```typescript
const saveClip = useMutation(api.clips.save);
```

The `router` from `useRouter()` is already imported and available.

**B) Add the handler:**

The extend-next flow is: auto-save generation as clip -> toast with feedback -> navigate to continuation mode.

```typescript
const handleExtendNextGeneration = useCallback(async (generation: any) => {
  if (!generation.code || !generation.rawCode) {
    toast.error("Cannot extend: generation has no code");
    return;
  }
  try {
    const clipId = await saveClip({
      name: generation.prompt.slice(0, 50) || "Untitled",
      code: generation.code,
      rawCode: generation.rawCode,
      durationInFrames: generation.durationInFrames ?? 90,
      fps: generation.fps ?? 30,
    });
    toast.success("Saved as clip -- opening continuation...");
    router.push(`/create?sourceClipId=${clipId}`);
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to start continuation");
  }
}, [saveClip, router]);
```

**C) Pass to GenerationFeed:**

```tsx
<GenerationFeed
  onSelectGeneration={handleSelectGeneration}
  onSaveGeneration={handleSaveGeneration}
  onDeleteGeneration={handleDeleteGeneration}
  onRerunGeneration={handleRerunGeneration}
  onExtendNextGeneration={handleExtendNextGeneration}
/>
```

## Verification

1. **TypeScript compilation**: Run `npx tsc --noEmit` -- must pass with zero errors
2. **Extend Next in menu**: Open the feed, click the three-dot menu on any successful generation. "Extend Next" should appear between "Save to Library" and "Rerun", with a FastForward icon.
3. **Extend Next disabled on failed generations**: For a failed generation, "Extend Next" should be grayed out / non-clickable (same as "Save to Library").
4. **Extend Next flow**: Click "Extend Next" on a successful generation. Should see:
   - "Saved as clip -- opening continuation..." toast
   - Page navigates to `/create?sourceClipId=<clipId>`
   - Continuation context banner appears ("Generating continuation from: <clip name>")
   - Typing a prompt and pressing Enter generates a continuation scene
5. **Clip in library**: After clicking "Extend Next", check the Library page. The auto-saved clip should appear with the generation's prompt text (truncated to 50 chars) as its name.
6. **No "Extend Previous" button**: Confirm no "Extend Previous" appears anywhere in the dropdown menu (Phase 17 responsibility).

## Commit Message Template

```
feat(16-02): wire extend-next action for continuation from feed

- Add "Extend Next" menu item to GenerationRowActions dropdown
- Implement save-then-navigate handler (auto-save as clip, navigate to continuation mode)
- Show toast feedback: "Saved as clip -- opening continuation..."
- Extend-previous deferred to Phase 17 (no backend yet)
```
