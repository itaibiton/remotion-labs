---
phase: 13-generation-feed-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/generations.ts
  - convex/generateAnimation.ts
autonomous: true

must_haves:
  truths:
    - "Existing generations still load correctly with new optional schema fields"
    - "Paginated query returns generations newest-first with cursor-based pagination"
    - "Generate action accepts aspectRatio, durationInSeconds, and fps arguments"
    - "Claude receives dimension and timing context in the system prompt"
    - "Generated animations are stored with their aspect ratio and settings metadata"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Updated generations table with batchId, variationIndex, variationCount, aspectRatio, durationInSeconds fields and by_batchId index"
      contains: "batchId"
    - path: "convex/generations.ts"
      provides: "listPaginated query with paginationOptsValidator and updated store mutation accepting new fields"
      exports: ["listPaginated", "store", "list", "get"]
    - path: "convex/generateAnimation.ts"
      provides: "Updated generate action accepting aspectRatio, durationInSeconds, fps args with dimension injection into Claude prompt"
      contains: "ASPECT_RATIO_MAP"
  key_links:
    - from: "convex/generateAnimation.ts"
      to: "convex/generations.ts store mutation"
      via: "ctx.runMutation with new fields (aspectRatio, durationInSeconds)"
      pattern: "aspectRatio.*durationInSeconds"
    - from: "convex/generations.ts listPaginated"
      to: "convex/schema.ts generations table"
      via: "by_user_created index with paginate()"
      pattern: "paginationOptsValidator"
---

<objective>
Add schema fields for generation settings and batch tracking, create a paginated query for the feed, and update the generate action to accept and pass through aspect ratio, duration, and FPS settings.

Purpose: This is the data foundation for the entire phase. Without these schema fields, settings, and the paginated query, neither the settings panel nor the feed UI can function.
Output: Updated schema.ts, generations.ts (with listPaginated query), and generateAnimation.ts (accepting settings args).
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-generation-feed-settings/13-RESEARCH.md

@convex/schema.ts
@convex/generations.ts
@convex/generateAnimation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema fields and paginated query</name>
  <files>convex/schema.ts, convex/generations.ts</files>
  <action>
In convex/schema.ts, add the following v.optional() fields to the generations table definition (after the existing `createdAt` field):

```
// v0.2 Phase 13: batch/variation tracking
batchId: v.optional(v.string()),
variationIndex: v.optional(v.number()),
variationCount: v.optional(v.number()),
// v0.2 Phase 13: generation settings
aspectRatio: v.optional(v.string()),  // "16:9" | "1:1" | "9:16"
durationInSeconds: v.optional(v.number()),
// v0.2 Phase 15: image upload (placeholder)
referenceImageIds: v.optional(v.array(v.string())),
// v0.2 Phase 12: continuation tracking
continuationType: v.optional(v.string()),
```

Add a new index after the existing indexes:
```
.index("by_batchId", ["batchId"])
```

All fields are v.optional() for backward compatibility -- existing documents will return undefined for these fields.

In convex/generations.ts:

1. Update the `store` internalMutation args to accept the new optional fields:
   - Add: `batchId: v.optional(v.string())`, `variationIndex: v.optional(v.number())`, `variationCount: v.optional(v.number())`, `aspectRatio: v.optional(v.string())`, `durationInSeconds: v.optional(v.number())`, `continuationType: v.optional(v.string())`
   - Update the handler's ctx.db.insert call to spread all args (or add each new field individually)

2. Add a new `listPaginated` query:
   ```typescript
   import { paginationOptsValidator } from "convex/server";

   export const listPaginated = query({
     args: {
       paginationOpts: paginationOptsValidator,
     },
     handler: async (ctx, args) => {
       const identity = await ctx.auth.getUserIdentity();
       if (!identity) {
         throw new Error("Must be logged in to view generations");
       }

       return await ctx.db
         .query("generations")
         .withIndex("by_user_created", (q) =>
           q.eq("userId", identity.tokenIdentifier)
         )
         .order("desc")
         .paginate(args.paginationOpts);
     },
   });
   ```

Keep the existing `list` and `get` queries unchanged.
  </action>
  <verify>Run `npx convex dev --once` from the project root. It should succeed without errors, confirming the schema is valid and the new query/mutation compiles.</verify>
  <done>Schema has 7 new optional fields on generations table, by_batchId index exists, listPaginated query is exported, store mutation accepts all new fields.</done>
</task>

<task type="auto">
  <name>Task 2: Update generate action to accept settings and inject dimensions into Claude prompt</name>
  <files>convex/generateAnimation.ts</files>
  <action>
1. Add an ASPECT_RATIO_MAP constant at the top of the file (after imports, before SYSTEM_PROMPT):
```typescript
const ASPECT_RATIO_MAP: Record<string, { width: number; height: number }> = {
  "16:9": { width: 1920, height: 1080 },
  "1:1": { width: 1080, height: 1080 },
  "9:16": { width: 1080, height: 1920 },
};
```

2. Update the `generate` action args to add:
```typescript
aspectRatio: v.optional(v.string()),
durationInSeconds: v.optional(v.number()),
fps: v.optional(v.number()),
```

3. In the generate handler, BEFORE the Claude API call, resolve settings:
```typescript
const aspectRatio = args.aspectRatio ?? "16:9";
const dimensions = ASPECT_RATIO_MAP[aspectRatio] ?? { width: 1920, height: 1080 };
const targetDuration = args.durationInSeconds ?? 3;
const targetFps = args.fps ?? 30;
const targetFrames = Math.round(targetDuration * targetFps);
```

4. Inject settings into the system prompt by appending to SYSTEM_PROMPT:
```typescript
const enhancedPrompt = SYSTEM_PROMPT +
  `\n\nIMPORTANT COMPOSITION SETTINGS:\n` +
  `- Dimensions: ${dimensions.width}x${dimensions.height} (${aspectRatio})\n` +
  `- Duration: ${targetFrames} frames at ${targetFps} FPS\n` +
  `- Use // DURATION: ${targetFrames} and // FPS: ${targetFps} in your output\n` +
  `- Design your layout for ${aspectRatio} aspect ratio`;
```
Use `enhancedPrompt` in the `system` field of `client.messages.create()` instead of `SYSTEM_PROMPT`.

5. Update the fps assignment to use `targetFps` instead of hardcoded 30:
```typescript
const fps = targetFps; // Was: const fps = 30;
```

6. Update the `ctx.runMutation(internal.generations.store, {...})` call to include the new fields:
```typescript
aspectRatio,
durationInSeconds: targetDuration,
```

7. Update the return statement to include fps from targetFps (it already returns fps, just ensure it uses the variable).

Do NOT change the `refine` or `generateContinuation` actions -- those will be updated in later phases.
  </action>
  <verify>Run `npx convex dev --once` from the project root. It should succeed. Then verify the generate action's TypeScript compiles by checking for no type errors in the file.</verify>
  <done>Generate action accepts aspectRatio, durationInSeconds, fps args. Claude receives dimension context in system prompt. Generated animations are stored with aspectRatio and durationInSeconds metadata. Existing callers (passing no settings args) still work due to defaults.</done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds with no errors
2. Schema shows new optional fields in the generations table
3. `listPaginated` query is exported from generations.ts
4. `generate` action accepts 3 new optional args
5. Existing code that calls `generate({ prompt })` without settings args still compiles (all new args are optional)
</verification>

<success_criteria>
- Schema evolution is backward-compatible (all new fields are v.optional)
- Paginated query works with by_user_created index, returns newest-first
- Generate action injects dimensions into Claude prompt
- Store mutation persists aspectRatio and durationInSeconds per generation
- No breaking changes to existing callers
</success_criteria>

<output>
After completion, create `.planning/phases/13-generation-feed-settings/13-01-SUMMARY.md`
</output>
