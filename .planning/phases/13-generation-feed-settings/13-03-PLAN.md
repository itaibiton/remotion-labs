---
phase: 13-generation-feed-settings
plan: 03
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - src/components/generation/generation-feed.tsx
  - src/components/generation/generation-row.tsx
  - src/app/(app)/create/create-page-client.tsx
autonomous: true

must_haves:
  truths:
    - "User opens the create page and sees all past generations listed newest-first as a scrolling feed"
    - "Each generation row displays the prompt text, aspect ratio, duration, and timestamp alongside a thumbnail"
    - "User can open the settings panel and choose aspect ratio, duration, and FPS before generating"
    - "Settings persist across page refresh via localStorage"
    - "Newly generated animations use the configured aspect ratio, duration, and FPS"
    - "Load More button appears when there are more generations to fetch"
  artifacts:
    - path: "src/components/generation/generation-feed.tsx"
      provides: "Feed container using usePaginatedQuery with load-more button"
      exports: ["GenerationFeed"]
    - path: "src/components/generation/generation-row.tsx"
      provides: "Single generation row with Remotion Thumbnail and metadata display"
      exports: ["GenerationRow"]
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Refactored create page integrating feed, settings panel, and settings-aware generation"
      contains: "useGenerationSettings"
  key_links:
    - from: "src/components/generation/generation-feed.tsx"
      to: "convex/generations.ts listPaginated"
      via: "usePaginatedQuery(api.generations.listPaginated)"
      pattern: "usePaginatedQuery.*listPaginated"
    - from: "src/components/generation/generation-row.tsx"
      to: "@remotion/player Thumbnail"
      via: "Remotion Thumbnail component rendering mid-frame"
      pattern: "Thumbnail.*DynamicCode"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "convex/generateAnimation.ts generate action"
      via: "Passes settings (aspectRatio, durationInSeconds, fps) to generate action call"
      pattern: "generate.*aspectRatio.*durationInSeconds"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "src/hooks/use-generation-settings.ts"
      via: "useGenerationSettings hook for settings state"
      pattern: "useGenerationSettings"
---

<objective>
Create the generation feed UI with paginated loading and thumbnail previews, and wire the settings panel and feed into the create page so that all past generations are visible and new generations respect configured settings.

Purpose: This is the user-facing integration that delivers the core phase value: a scrolling feed of past generations and settings-aware generation. Without this plan, the schema changes and settings components sit unused.
Output: generation-feed.tsx, generation-row.tsx, refactored create-page-client.tsx
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-generation-feed-settings/13-RESEARCH.md

@.planning/phases/13-generation-feed-settings/13-01-SUMMARY.md
@.planning/phases/13-generation-feed-settings/13-02-SUMMARY.md

@src/app/(app)/create/create-page-client.tsx
@src/components/preview/preview-player.tsx
@src/components/library/clip-card.tsx
@convex/generations.ts
@src/hooks/use-generation-settings.ts
@src/lib/aspect-ratios.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generation feed and row components</name>
  <files>src/components/generation/generation-feed.tsx, src/components/generation/generation-row.tsx</files>
  <action>
1. Create `src/components/generation/generation-row.tsx` as a "use client" component:

Props:
```typescript
interface GenerationRowProps {
  generation: {
    _id: string;
    prompt: string;
    code?: string;
    rawCode?: string;
    durationInFrames?: number;
    fps?: number;
    aspectRatio?: string;
    durationInSeconds?: number;
    status: "success" | "failed";
    errorMessage?: string;
    createdAt: number;
  };
  onSelect: (generation: GenerationRowProps["generation"]) => void;
}
```

Layout -- horizontal row with:
- Left: Thumbnail preview (or error/loading placeholder if no code)
  - Use Remotion `Thumbnail` from `@remotion/player` with `DynamicCode` component
  - Import `ASPECT_RATIO_PRESETS` from `@/lib/aspect-ratios` to resolve dimensions from `generation.aspectRatio ?? "16:9"`
  - Set `frameToDisplay` to `Math.floor((generation.durationInFrames ?? 90) / 2)` (mid-frame)
  - Thumbnail container: fixed width ~200px with aspect ratio matching the generation's ratio
  - Wrap in `isMounted` check (useState + useEffect pattern, same as clip-card.tsx) since Remotion needs browser APIs
  - For failed generations (status === "failed"), show a red-tinted placeholder with error icon instead of Thumbnail

- Right: Metadata
  - Prompt text (truncated to 2 lines with line-clamp-2)
  - Row of metadata badges: aspect ratio (e.g., "16:9"), duration (e.g., "3.0s"), FPS (e.g., "30fps")
  - Relative timestamp (e.g., "2 hours ago") -- use a simple helper: `new Date(generation.createdAt).toLocaleDateString()` for now (keep it simple)
  - For failed generations, show error message in red text

The entire row is clickable (calls onSelect).

Use Tailwind: flex row, gap-4, p-3, rounded-lg border, hover:bg-muted/50 transition.

2. Create `src/components/generation/generation-feed.tsx` as a "use client" component:

```typescript
import { usePaginatedQuery } from "convex/react";
import { api } from "../../../../convex/_generated/api";
```

Uses `usePaginatedQuery(api.generations.listPaginated, {}, { initialNumItems: 10 })`.

Layout:
- Loading state (status === "LoadingFirstPage"): show 3 skeleton rows (div with animate-pulse)
- Empty state (results.length === 0 and status === "Exhausted"): show centered message "No generations yet. Enter a prompt above to create your first animation."
- Results: map over results, render `GenerationRow` for each
- Load More: if status === "CanLoadMore", show a "Load More" button calling `loadMore(10)`
- Loading More: if status === "LoadingMore", show small loading indicator
- Exhausted: if status === "Exhausted" and results.length > 0, show "All generations loaded" text

Props:
```typescript
interface GenerationFeedProps {
  onSelectGeneration: (generation: any) => void;
}
```

The feed does NOT manage selection state -- it delegates to the parent via onSelectGeneration callback.
  </action>
  <verify>Run `npx tsc --noEmit` from the project root. Both components should compile without type errors. Verify that the import paths for convex API, Remotion Thumbnail, and aspect-ratios resolve correctly.</verify>
  <done>GenerationFeed renders a paginated list of generations with load-more. GenerationRow shows a Remotion Thumbnail with prompt text and metadata. Failed generations show error state. Empty state shows helpful message.</done>
</task>

<task type="auto">
  <name>Task 2: Wire feed and settings into create page</name>
  <files>src/app/(app)/create/create-page-client.tsx</files>
  <action>
Refactor create-page-client.tsx to integrate the generation feed and settings panel. This is the most significant change in the phase.

**Add imports:**
```typescript
import { GenerationFeed } from "@/components/generation/generation-feed";
import { GenerationSettingsPanel } from "@/components/generation/generation-settings";
import { useGenerationSettings } from "@/hooks/use-generation-settings";
import { Settings2 } from "lucide-react";
```

**Add settings state** in CreateContent component (near the top, after existing state):
```typescript
const { settings, updateSetting, resetSettings } = useGenerationSettings();
const [showSettings, setShowSettings] = useState(false);
```

**Update handleGenerate** to pass settings to the generate action:
Change `const result = await generate({ prompt });` to:
```typescript
const result = await generate({
  prompt,
  aspectRatio: settings.aspectRatio,
  durationInSeconds: settings.durationInSeconds,
  fps: settings.fps,
});
```

**Add feed selection handler** that loads a generation into the editor:
```typescript
const handleSelectGeneration = useCallback((generation: any) => {
  if (generation.status === "failed" || !generation.code) return;
  setLastGeneration({
    id: String(generation._id),
    rawCode: generation.rawCode ?? "",
    code: generation.code,
    durationInFrames: generation.durationInFrames ?? 90,
    fps: generation.fps ?? 30,
  });
  setLastPrompt(generation.prompt);
  setEditedCode(null);
  setIsEditing(false);
  setSkipValidation(true);
  setChatMessages([]);
  setSavedClipId(null);
}, []);
```

**Restructure the JSX layout** of CreateContent's return:
The new layout should be (from top to bottom):
1. Context banners (continuation, template) -- keep existing
2. Error state -- keep existing
3. Generating state -- keep existing
4. **Selected generation view** (the existing preview+code+actions block) -- keep existing but only show when lastGeneration is set
5. **Prompt input area** with settings toggle button:
   - Add a settings toggle button (Settings2 icon) next to or near the PromptInput
   - When showSettings is true, render GenerationSettingsPanel above/below the prompt input
   - The settings panel receives: settings, onUpdateSetting={updateSetting}, onReset={resetSettings}
6. **Generation Feed** -- render GenerationFeed below the prompt area with onSelectGeneration={handleSelectGeneration}

The key structural change: the page now shows the feed BELOW the prompt input, making the create page a scrolling experience where past generations are always visible.

Specific layout approach:
```tsx
{/* Settings toggle + panel */}
{!isGenerating && (
  <div className="w-full max-w-2xl mb-4">
    <div className="flex items-center justify-end mb-2">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowSettings(!showSettings)}
      >
        <Settings2 className="h-4 w-4 mr-2" />
        Settings
      </Button>
    </div>
    {showSettings && (
      <div className="p-4 border rounded-lg mb-4">
        <GenerationSettingsPanel
          settings={settings}
          onUpdateSetting={updateSetting}
          onReset={resetSettings}
        />
      </div>
    )}
  </div>
)}

{/* Prompt input */}
{!isGenerating && (
  <PromptInput ... />
)}

{/* Generation Feed */}
{!isGenerating && !lastGeneration && (
  <div className="w-full max-w-2xl mt-8">
    <h3 className="text-sm font-medium text-muted-foreground mb-4">Past Generations</h3>
    <GenerationFeed onSelectGeneration={handleSelectGeneration} />
  </div>
)}
```

Show the feed when there's no selected generation (user is on the "home" state of create page). When a generation is selected (from feed click or fresh generation), show the preview/editor instead. The user can get back to the feed by starting over.

Do NOT remove any existing functionality (continuation mode, template mode, clip loading, save dialog, add-to-movie dialog). All existing features must continue to work.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- should pass with no type errors
2. Run `npx next build` -- should build successfully (or run `npx convex dev --once && npx next dev` and check the create page loads without errors)
3. Verify the create page shows:
   - Settings toggle button
   - Settings panel (when toggled open) with aspect ratio, duration, FPS controls
   - Generation feed below the prompt input showing past generations
   - Clicking a generation in the feed loads it into the preview
  </verify>
  <done>Create page shows settings panel with localStorage persistence, generation feed with paginated loading, and passes configured settings to the generate action. Clicking a feed item loads the generation into the preview. All existing create page features (continuation, template, editing, save, export) still work.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Create page renders without hydration errors
3. Feed shows generations newest-first with thumbnails and metadata
4. "Load More" button fetches additional generations
5. Settings panel toggles open/close
6. Changing aspect ratio persists after page refresh
7. New generation uses selected settings (visible in the stored generation's metadata)
8. Clicking a feed row loads that generation into the preview/editor
9. Existing features unbroken: continuation mode, template mode, clip loading, save/export
</verification>

<success_criteria>
- FEED-01: Create page displays all past generations as a scrolling feed (newest first)
- FEED-02: Each generation row shows thumbnail and prompt text with metadata
- SET-01: User can configure aspect ratio (9:16, 1:1, 16:9) from settings panel
- SET-02: User can configure duration and FPS; settings persist via localStorage
- Generated animations receive the configured settings
</success_criteria>

<output>
After completion, create `.planning/phases/13-generation-feed-settings/13-03-SUMMARY.md`
</output>
