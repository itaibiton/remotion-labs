---
phase: 10-movie-data-timeline-ui
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - src/components/movie/timeline.tsx
  - src/components/movie/timeline-scene.tsx
  - src/components/movie/add-scene-panel.tsx
  - src/components/movie/movie-editor.tsx
  - src/remotion/compositions/MovieComposition.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Add Scene' to see a panel of available clips and add one to the movie"
    - "User sees scenes displayed as blocks on a horizontal timeline with thumbnails and durations"
    - "User can drag scenes to reorder them on the timeline"
    - "User can remove a scene from the timeline via an X button"
    - "Reordering is optimistic (no flicker) and persists to the database"
    - "Adding and removing scenes updates the timeline and movie stats reactively"
  artifacts:
    - path: "src/components/movie/timeline.tsx"
      provides: "Horizontal DnD timeline with SortableContext"
      min_lines: 60
    - path: "src/components/movie/timeline-scene.tsx"
      provides: "Sortable scene block with thumbnail, duration, remove button"
      min_lines: 50
    - path: "src/components/movie/add-scene-panel.tsx"
      provides: "Clip picker dialog/panel to add scenes from library"
      min_lines: 40
    - path: "src/components/movie/movie-editor.tsx"
      provides: "Updated editor wiring timeline, add-scene, and mutations"
      min_lines: 80
    - path: "src/remotion/compositions/MovieComposition.tsx"
      provides: "Series-based multi-scene Remotion composition"
      min_lines: 30
  key_links:
    - from: "src/components/movie/timeline.tsx"
      to: "convex/movies.ts"
      via: "onReorder callback triggers reorderScenes mutation"
      pattern: "reorderScenes"
    - from: "src/components/movie/timeline-scene.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable hook for drag behavior"
      pattern: "useSortable"
    - from: "src/components/movie/add-scene-panel.tsx"
      to: "convex/movies.ts"
      via: "addScene mutation when clip is selected"
      pattern: "addScene"
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/timeline.tsx"
      via: "renders Timeline with scenes and mutation callbacks"
      pattern: "<Timeline"
    - from: "src/components/movie/timeline-scene.tsx"
      to: "@remotion/player"
      via: "Thumbnail component for scene preview"
      pattern: "<Thumbnail"
---

<objective>
Install @dnd-kit, build the horizontal drag-to-reorder timeline with scene blocks, add-scene clip picker, and MovieComposition for future preview.

Purpose: This plan delivers the core timeline interaction -- users can add clips as scenes, see them as draggable blocks with thumbnails and durations, reorder them by dragging, and remove scenes. This completes all Phase 10 success criteria.
Output: Timeline component with DnD, scene blocks with thumbnails, add-scene panel, updated movie editor wiring, and MovieComposition for Phase 11.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-movie-data-timeline-ui/10-RESEARCH.md
@.planning/phases/10-movie-data-timeline-ui/10-01-SUMMARY.md
@.planning/phases/10-movie-data-timeline-ui/10-02-SUMMARY.md
@src/components/movie/movie-editor.tsx
@src/components/library/clip-card.tsx
@src/remotion/compositions/DynamicCode.tsx
@convex/movies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @dnd-kit packages and create timeline + scene components</name>
  <files>
    src/components/movie/timeline.tsx
    src/components/movie/timeline-scene.tsx
  </files>
  <action>
**Step 1: Install @dnd-kit packages:**
```bash
npm install @dnd-kit/core@^6.3.1 @dnd-kit/sortable@^10.0.0 @dnd-kit/modifiers@^9.0.0 @dnd-kit/utilities@^3.2.2 --legacy-peer-deps
```
The `--legacy-peer-deps` flag is REQUIRED because @dnd-kit declares React 16-18 peer deps but works fine at runtime with React 19. The project's `tsconfig.json` already has `skipLibCheck: true` to suppress type declaration mismatches.

**Step 2: Create `src/components/movie/timeline.tsx`:**

"use client" component. This is the horizontal DnD timeline container.

Props:
```typescript
interface TimelineProps {
  scenes: Array<{
    clipId: string;
    clip: {
      _id: string;
      code: string;
      name: string;
      durationInFrames: number;
      fps: number;
    } | null;
  }>;
  onReorder: (newScenes: Array<{ clipId: string }>) => void;
  onRemove: (sceneIndex: number) => void;
}
```

Implementation:
- Use `DndContext` from `@dnd-kit/core` with `closestCenter` collision detection and `restrictToHorizontalAxis` modifier from `@dnd-kit/modifiers`.
- Configure sensors: `PointerSensor` with `activationConstraint: { distance: 8 }` (prevents accidental drags) and `KeyboardSensor`.
- Use `SortableContext` with `horizontalListSortingStrategy` from `@dnd-kit/sortable`.
- Generate stable IDs: `scenes.map((_, i) => \`scene-${i}\`)`. These IDs are used for BOTH the `items` prop on SortableContext AND the `id` prop on each TimelineScene. This prevents the SortableContext items order mismatch pitfall.

**Optimistic reorder pattern:**
- Maintain local state: `const [localScenes, setLocalScenes] = useState(scenes)`.
- Sync from props: `useEffect(() => { setLocalScenes(scenes); }, [scenes])` (use JSON.stringify comparison to avoid unnecessary syncs).
- On drag end: compute new order using `arrayMove` from `@dnd-kit/sortable`, update `localScenes` immediately (optimistic), then call `onReorder(newOrder)` to persist.
- This prevents the flicker-back issue described in Research pitfall #6.

Layout: `flex flex-row gap-2 overflow-x-auto p-4 min-h-[140px] bg-muted/20 rounded-lg border border-dashed`. Render TimelineScene for each scene in localScenes. Show a subtle "Drag to reorder" hint text below the timeline.

**Step 3: Create `src/components/movie/timeline-scene.tsx`:**

"use client" component. Individual sortable scene block.

Props:
```typescript
interface TimelineSceneProps {
  id: string;
  clip: {
    _id: string;
    code: string;
    name: string;
    durationInFrames: number;
    fps: number;
  } | null;
  index: number;
  onRemove: (index: number) => void;
}
```

Implementation:
- Use `useSortable({ id })` from `@dnd-kit/sortable`.
- Apply `CSS.Transform.toString(transform)` from `@dnd-kit/utilities` for the drag transform style.
- Set `transition` from useSortable for smooth animation.
- Set `opacity: isDragging ? 0.5 : 1`.

Visual layout (each scene block):
- Fixed width: `w-[160px]` (consistent block size, not proportional to duration for MVP).
- Height: `h-[110px]`.
- Rounded border card (`rounded-lg border bg-card overflow-hidden`).
- Top area: Remotion `<Thumbnail>` component showing the middle frame of the clip (same pattern as `clip-card.tsx`). Use `isMounted` guard with `useState(false)` + `useEffect(() => setIsMounted(true), [])` to prevent SSR issues (exactly as clip-card.tsx does).
  - If clip is null (deleted reference): show a red/muted placeholder with "Missing clip" text.
  - Thumbnail props: `component={DynamicCode}`, `inputProps={{ code: clip.code, durationInFrames: clip.durationInFrames, fps: clip.fps }}`, `compositionWidth={1920}`, `compositionHeight={1080}`, `frameToDisplay={Math.floor(clip.durationInFrames / 2)}`, `durationInFrames={clip.durationInFrames}`, `fps={clip.fps}`, `style={{ width: "100%" }}`.
- Bottom area: Flex row with clip name (truncated, text-xs font-medium) and duration (text-xs text-muted-foreground, formatted as Xs).
- Remove button: Absolute positioned X icon (lucide-react) in top-right corner, opacity-0 group-hover:opacity-100 transition. On click: call `onRemove(index)`. Use `e.stopPropagation()` to prevent drag activation.
- Cursor: `cursor-grab active:cursor-grabbing`.
- Spread `{...attributes}` and `{...listeners}` from useSortable onto the root div.

Import Thumbnail from `@remotion/player`, DynamicCode from `@/remotion/compositions/DynamicCode`, X from `lucide-react`.
  </action>
  <verify>Run `npm run build` to verify @dnd-kit imports resolve and TypeScript compiles. Check that `node_modules/@dnd-kit/core` exists after install.</verify>
  <done>@dnd-kit packages installed. Timeline component renders a horizontal scrollable row with DndContext and SortableContext. TimelineScene renders sortable blocks with thumbnails, names, durations, and remove buttons. Optimistic local state prevents reorder flicker.</done>
</task>

<task type="auto">
  <name>Task 2: Create add-scene panel, MovieComposition, and wire everything into the editor</name>
  <files>
    src/components/movie/add-scene-panel.tsx
    src/remotion/compositions/MovieComposition.tsx
    src/components/movie/movie-editor.tsx
  </files>
  <action>
**1. Create `src/components/movie/add-scene-panel.tsx`:**

"use client" component. A Dialog that shows the user's clip library for adding scenes to the movie.

Props:
```typescript
interface AddScenePanelProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onAddClip: (clipId: string) => void;
}
```

Implementation:
- Use `useQuery(api.clips.list)` to fetch user's clips.
- Render as a Dialog with DialogHeader title "Add Scene" and description "Select a clip from your library to add as a scene."
- Inside: Grid of clips (`grid-cols-2 sm:grid-cols-3 gap-3 max-h-[400px] overflow-y-auto`).
- Each clip renders as a clickable card with:
  - Thumbnail preview using the same Remotion `<Thumbnail>` pattern (with isMounted guard).
  - Clip name (text-sm font-medium truncate).
  - Duration (text-xs text-muted-foreground).
  - On click: call `onAddClip(clip._id)`, close dialog via `onOpenChange(false)`.
- Loading state: skeleton grid (3 placeholder cards).
- Empty state: "No clips in your library" with a link to `/create`.

Import Dialog components from `@/components/ui/dialog`. Import `useQuery` from `convex/react`, `api` from generated path, `Thumbnail` from `@remotion/player`, `DynamicCode` from compositions.

**2. Create `src/remotion/compositions/MovieComposition.tsx`:**

This composition sequences N DynamicCode instances using Remotion's `<Series>`. It will be used by Phase 11 for preview and render. Creating it now establishes the composition contract.

```tsx
"use client";

import React from "react";
import { Series } from "remotion";
import { DynamicCode } from "./DynamicCode";

export interface MovieScene {
  code: string;
  durationInFrames: number;
  fps: number;
}

export interface MovieCompositionProps {
  scenes: MovieScene[];
}

export const MovieComposition: React.FC<MovieCompositionProps> = ({
  scenes,
}) => {
  return (
    <Series>
      {scenes.map((scene, index) => (
        <Series.Sequence
          key={index}
          durationInFrames={scene.durationInFrames}
        >
          <DynamicCode
            code={scene.code}
            durationInFrames={scene.durationInFrames}
            fps={scene.fps}
          />
        </Series.Sequence>
      ))}
    </Series>
  );
};
```

Key: `<Series.Sequence>` auto-resets `useCurrentFrame()` to 0 for each child, so clip code works unchanged inside the Series.

**3. Update `src/components/movie/movie-editor.tsx`:**

Replace the placeholder timeline area from Plan 02 with the real Timeline and AddScenePanel. Wire up all mutations.

Add imports:
- `useMutation` from "convex/react"
- `api` from generated path
- `Timeline` from "./timeline"
- `AddScenePanel` from "./add-scene-panel"
- `Button` from "@/components/ui/button"
- `Plus` from "lucide-react"
- `toast` from "sonner"

Add state and mutations:
```typescript
const [showAddScene, setShowAddScene] = useState(false);
const addScene = useMutation(api.movies.addScene);
const removeScene = useMutation(api.movies.removeScene);
const reorderScenes = useMutation(api.movies.reorderScenes);
```

Wire handlers:
```typescript
const handleAddClip = async (clipId: string) => {
  try {
    await addScene({ movieId: movie._id as any, clipId: clipId as any });
    toast.success("Scene added");
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to add scene");
  }
};

const handleRemoveScene = async (sceneIndex: number) => {
  try {
    await removeScene({ movieId: movie._id as any, sceneIndex });
    toast.success("Scene removed");
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to remove scene");
  }
};

const handleReorder = async (newScenes: Array<{ clipId: string }>) => {
  try {
    await reorderScenes({
      movieId: movie._id as any,
      sceneOrder: newScenes.map(s => ({ clipId: s.clipId as any })),
    });
  } catch (error) {
    toast.error(error instanceof Error ? error.message : "Failed to reorder");
  }
};
```

**Prepare scenes data for Timeline:**
Map the movie's scenes array with their corresponding clip data from `sceneClips`:
```typescript
const scenesWithClips = movie.scenes.map((scene, index) => ({
  clipId: scene.clipId,
  clip: movie.sceneClips[index] ?? null,
}));
```
Note: `sceneClips` is the filtered array from `getWithClips`. If a clip was deleted, the corresponding entry is null. The TimelineScene handles null clips with a "Missing clip" placeholder.

**Update the layout:**

In the header, add an "Add Scene" button (Plus icon + "Add Scene" text) that opens the AddScenePanel dialog: `<Button onClick={() => setShowAddScene(true)}><Plus className="h-4 w-4 mr-2" />Add Scene</Button>`.

Replace the empty state placeholder: When `movie.scenes.length === 0`, show the empty state with the Film icon AND an "Add Scene" button that opens the panel.

Replace the timeline placeholder: When `movie.scenes.length > 0`, render:
```tsx
<Timeline
  scenes={scenesWithClips}
  onReorder={handleReorder}
  onRemove={handleRemoveScene}
/>
```

Render the AddScenePanel dialog:
```tsx
<AddScenePanel
  open={showAddScene}
  onOpenChange={setShowAddScene}
  onAddClip={handleAddClip}
/>
```
  </action>
  <verify>
Run `npm run build` to verify all imports resolve and TypeScript compiles.

Full integration test:
1. Navigate to /movie, create a new movie
2. In the editor, click "Add Scene" -- clip library dialog should appear
3. Click a clip to add it -- scene appears on timeline with thumbnail and duration
4. Add 2-3 more scenes -- all appear as blocks on the horizontal timeline
5. Drag a scene to reorder -- it moves smoothly without flicker
6. Click the X on a scene to remove it -- scene disappears and stats update
7. Refresh the page -- all changes persist
  </verify>
  <done>
- AddScenePanel dialog shows clip library and adds selected clips as scenes
- Timeline renders scenes as horizontal draggable blocks with thumbnails and durations
- Drag-to-reorder works with optimistic updates (no flicker)
- Remove button removes scenes from the timeline
- Movie editor header shows updated scene count and total duration
- MovieComposition exists for Phase 11 preview/render integration
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes with no TypeScript errors
- @dnd-kit packages installed in node_modules
- User can add clips as scenes via the Add Scene dialog
- Timeline displays scenes as horizontal blocks with thumbnails, names, durations
- Drag-to-reorder works smoothly with optimistic local state
- Remove button removes scenes and updates movie stats
- All changes persist across page refresh (Convex mutations work)
- MovieComposition.tsx exists and exports MovieComposition with Series-based sequencing
</verification>

<success_criteria>
All 5 Phase 10 success criteria are met:
1. User can create a new movie from the Movie page -- (Plan 02)
2. User can add clips from the library as scenes in a movie -- AddScenePanel
3. User sees scenes displayed as blocks on a horizontal timeline with durations -- Timeline + TimelineScene
4. User can drag scenes to reorder them on the timeline -- DnD with @dnd-kit
5. User can remove a scene from the timeline -- Remove button on TimelineScene
</success_criteria>

<output>
After completion, create `.planning/phases/10-movie-data-timeline-ui/10-03-SUMMARY.md`
</output>
