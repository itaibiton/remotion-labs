---
phase: 10-movie-data-timeline-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/movies.ts
autonomous: true

must_haves:
  truths:
    - "movies table exists in Convex with scenes array, totalDurationInFrames, fps, userId, name"
    - "create mutation inserts empty movie with name and returns ID"
    - "list query returns current user's movies ordered by updatedAt desc"
    - "get query returns a single movie by ID"
    - "getWithClips query returns movie plus all referenced clip documents"
    - "addScene mutation appends a clip to the movie's scenes array and recomputes totalDurationInFrames"
    - "removeScene mutation removes a scene by index and recomputes totalDurationInFrames"
    - "reorderScenes mutation replaces the scenes array with a new order"
    - "All mutations enforce authentication and ownership"
  artifacts:
    - path: "convex/schema.ts"
      provides: "movies table definition with scenes array, indexes"
      contains: "movies: defineTable"
    - path: "convex/movies.ts"
      provides: "Movie CRUD mutations and queries"
      exports: ["create", "list", "get", "getWithClips", "addScene", "removeScene", "reorderScenes"]
  key_links:
    - from: "convex/movies.ts"
      to: "convex/schema.ts"
      via: "movies table definition"
      pattern: "ctx\\.db\\.insert\\(\"movies\""
    - from: "convex/movies.ts"
      to: "convex/schema.ts"
      via: "clips table reference for getWithClips"
      pattern: "ctx\\.db\\.get\\(scene\\.clipId\\)"
---

<objective>
Create the Convex movies table and all backend mutations/queries for movie CRUD, scene management, and clip resolution.

Purpose: Establish the data layer that the movie list page and timeline editor will consume. Movies store an ordered array of scenes (clip references) with computed total duration.
Output: `convex/schema.ts` with movies table, `convex/movies.ts` with 7 exports (create, list, get, getWithClips, addScene, removeScene, reorderScenes).
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-movie-data-timeline-ui/10-RESEARCH.md
@convex/schema.ts
@convex/clips.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add movies table to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a `movies` table definition to the existing schema in `convex/schema.ts`. Place it after the `clips` table.

Schema for the movies table:
```typescript
movies: defineTable({
  userId: v.string(),
  name: v.string(),
  scenes: v.array(v.object({
    clipId: v.id("clips"),
    durationOverride: v.optional(v.number()),
  })),
  totalDurationInFrames: v.number(),
  fps: v.number(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_user_updated", ["userId", "updatedAt"]),
```

Key design decisions:
- `scenes` is an inline array of objects (not a join table). Each scene has a `clipId` referencing the clips table and an optional `durationOverride`.
- `totalDurationInFrames` is a cached computed value, recomputed on every scene mutation.
- `fps` is uniform across all clips in a movie (30fps). Set when first scene is added.
- Two indexes: `by_user` for ownership checks, `by_user_updated` for sorted listing.

Do NOT modify any existing table definitions (users, generations, clips, renders).
  </action>
  <verify>Run `npx convex dev --once` (or check that the Convex dev server picks up the schema change without errors). The schema should deploy successfully with the new movies table.</verify>
  <done>movies table exists in convex/schema.ts with scenes array, totalDurationInFrames, fps, userId, name, createdAt, updatedAt fields plus by_user and by_user_updated indexes.</done>
</task>

<task type="auto">
  <name>Task 2: Create movies.ts with all mutations and queries</name>
  <files>convex/movies.ts</files>
  <action>
Create `convex/movies.ts` following the exact auth pattern from `convex/clips.ts` (getUserIdentity, tokenIdentifier ownership check).

**Helper function (internal, not exported):**
```typescript
async function computeTotalDuration(
  ctx: { db: { get: (id: any) => Promise<any> } },
  scenes: Array<{ clipId: any; durationOverride?: number }>
): Promise<number> {
  let total = 0;
  for (const scene of scenes) {
    if (scene.durationOverride) {
      total += scene.durationOverride;
    } else {
      const clip = await ctx.db.get(scene.clipId);
      total += clip?.durationInFrames ?? 0;
    }
  }
  return total;
}
```

**Exports (7 total):**

1. `create` (mutation) - Args: `{ name: v.string() }`. Auth required. Insert movie with empty scenes array, totalDurationInFrames: 0, fps: 30, current timestamps. Return the new movie ID.

2. `list` (query) - No args. Return empty array if unauthenticated (graceful, matches clips.list pattern). Query movies table using `by_user_updated` index, order desc, take 50.

3. `get` (query) - Args: `{ id: v.id("movies") }`. Return movie document or null. No auth check (matches clips.get pattern for URL-param loading).

4. `getWithClips` (query) - Args: `{ id: v.id("movies") }`. Get movie by ID, then fetch all referenced clips in parallel using `Promise.all(movie.scenes.map(s => ctx.db.get(s.clipId)))`. Return `{ ...movie, sceneClips: clips.filter(Boolean) }` so null clips (deleted) are filtered out. Return null if movie not found.

5. `addScene` (mutation) - Args: `{ movieId: v.id("movies"), clipId: v.id("clips") }`. Auth required + ownership check. Verify clip exists. Append `{ clipId }` to scenes array. Recompute totalDurationInFrames using helper. If this is the first scene, set fps from the clip. If not first, verify clip.fps matches movie.fps (throw "Clip fps must match movie fps" if mismatch). Update updatedAt.

6. `removeScene` (mutation) - Args: `{ movieId: v.id("movies"), sceneIndex: v.number() }`. Auth required + ownership check. Filter out the scene at the given index. Recompute totalDurationInFrames. Update updatedAt.

7. `reorderScenes` (mutation) - Args: `{ movieId: v.id("movies"), sceneOrder: v.array(v.object({ clipId: v.id("clips"), durationOverride: v.optional(v.number()) })) }`. Auth required + ownership check. Replace entire scenes array with sceneOrder. Recompute totalDurationInFrames. Update updatedAt.

**Auth pattern (copy from clips.ts):**
```typescript
const identity = await ctx.auth.getUserIdentity();
if (!identity) throw new Error("Not authenticated");
// For mutations that modify:
const movie = await ctx.db.get(args.movieId);
if (!movie || movie.userId !== identity.tokenIdentifier)
  throw new Error("Movie not found");
```

Import `v` from "convex/values" and `mutation`, `query` from "./_generated/server".
  </action>
  <verify>Run `npx convex dev --once` to verify all functions compile and deploy. Check that the Convex dashboard shows 7 new functions under the movies module (create, list, get, getWithClips, addScene, removeScene, reorderScenes).</verify>
  <done>convex/movies.ts exists with 7 exported functions. All mutations enforce auth and ownership. computeTotalDuration helper correctly resolves clip durations. getWithClips returns movie with populated sceneClips array.</done>
</task>

</tasks>

<verification>
- `npx convex dev --once` succeeds with no errors
- Schema shows movies table with correct fields and indexes
- All 7 functions (create, list, get, getWithClips, addScene, removeScene, reorderScenes) are deployed
- TypeScript compiles without errors
</verification>

<success_criteria>
- movies table is defined in convex/schema.ts with scenes array, indexes, and all required fields
- convex/movies.ts exports 7 functions with proper auth, ownership checks, and totalDuration recomputation
- Convex dev server deploys successfully with the new table and functions
</success_criteria>

<output>
After completion, create `.planning/phases/10-movie-data-timeline-ui/10-01-SUMMARY.md`
</output>
