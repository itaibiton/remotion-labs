---
phase: 12-continuation-generation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/app/(app)/create/page.tsx
  - src/app/(app)/create/create-page-client.tsx
  - src/components/library/add-to-movie-dialog.tsx
  - src/components/library/save-clip-dialog.tsx
  - src/components/movie/timeline-scene.tsx
  - src/components/library/clip-card.tsx
autonomous: false

must_haves:
  truths:
    - "User can click 'Generate next scene' from a timeline scene and be taken to the create page in continuation mode"
    - "User can click 'Generate next scene' from a clip card in the library and be taken to the create page in continuation mode"
    - "Create page in continuation mode shows the source clip context and calls generateContinuation instead of generate"
    - "After generating a continuation and saving it as a clip, user sees 'Add to Movie' and 'Generate Next Scene' contextual actions"
    - "User can add a saved clip to a movie via the 'Add to Movie' dialog on the create page"
  artifacts:
    - path: "src/app/(app)/create/page.tsx"
      provides: "sourceClipId search param extraction"
      contains: "sourceClipId"
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Continuation mode UI, contextual actions, Add to Movie dialog integration"
      contains: "generateContinuation"
    - path: "src/components/library/add-to-movie-dialog.tsx"
      provides: "Dialog listing user's movies to add a clip as a scene"
      exports: ["AddToMovieDialog"]
    - path: "src/components/library/save-clip-dialog.tsx"
      provides: "SaveClipDialog with onSaved callback"
      contains: "onSaved"
    - path: "src/components/movie/timeline-scene.tsx"
      provides: "Generate next scene button on hover"
      contains: "sourceClipId"
    - path: "src/components/library/clip-card.tsx"
      provides: "Generate next scene action in clip actions"
      contains: "sourceClipId"
  key_links:
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "convex/generateAnimation.ts (generateContinuation)"
      via: "useAction(api.generateAnimation.generateContinuation)"
      pattern: "api\\.generateAnimation\\.generateContinuation"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "src/components/library/add-to-movie-dialog.tsx"
      via: "AddToMovieDialog component"
      pattern: "AddToMovieDialog"
    - from: "src/components/movie/timeline-scene.tsx"
      to: "/create?sourceClipId="
      via: "router.push navigation"
      pattern: "sourceClipId"
    - from: "src/components/library/add-to-movie-dialog.tsx"
      to: "convex/movies.ts (addScene)"
      via: "useMutation(api.movies.addScene)"
      pattern: "api\\.movies\\.addScene"
    - from: "src/components/library/save-clip-dialog.tsx"
      to: "src/app/(app)/create/create-page-client.tsx"
      via: "onSaved callback with new clipId"
      pattern: "onSaved"
---

<objective>
Wire the continuation generation UI: add "Generate next scene" entry points on timeline scenes and clip cards, implement continuation mode on the create page (sourceClipId param triggers continuation flow), add contextual actions (Save, Add to Movie, Generate Next Scene), and create an Add to Movie dialog.

Purpose: This connects the backend action from Plan 01 to user-facing UI surfaces, completing the full continuation generation workflow from trigger to preview.

Output: Modified create page with continuation mode, new AddToMovieDialog component, updated timeline-scene and clip-card with "Generate next scene" buttons, SaveClipDialog enhanced with onSaved callback.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-continuation-generation/12-RESEARCH.md
@.planning/phases/12-continuation-generation/12-01-SUMMARY.md

@src/app/(app)/create/page.tsx
@src/app/(app)/create/create-page-client.tsx
@src/components/movie/timeline-scene.tsx
@src/components/library/clip-card.tsx
@src/components/library/save-clip-dialog.tsx
@src/components/movie/add-scene-panel.tsx
@convex/movies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddToMovieDialog, enhance SaveClipDialog, and add "Generate next scene" buttons</name>
  <files>
    src/components/library/add-to-movie-dialog.tsx
    src/components/library/save-clip-dialog.tsx
    src/components/movie/timeline-scene.tsx
    src/components/library/clip-card.tsx
  </files>
  <action>
**1a. Create `src/components/library/add-to-movie-dialog.tsx`:**

A dialog that lists the user's movies and lets them add a clip to a selected movie. Pattern: follow `add-scene-panel.tsx` but simpler (no thumbnails needed, just movie names).

```typescript
interface AddToMovieDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  clipId: string;
}
```

Implementation:
- Use `useQuery(api.movies.list)` to fetch user's movies
- Use `useMutation(api.movies.addScene)` to add the clip
- Display a Dialog (from `@/components/ui/dialog`) with:
  - Title: "Add to Movie"
  - Description: "Select a movie to add this clip as a scene."
  - Loading skeleton (3 items) while movies load
  - Empty state: "No movies yet" with link to "/movies" to create one
  - Movie list: each movie as a clickable button showing movie name and scene count (e.g., "My Movie (3 scenes)")
- On movie click: call `addScene({ movieId: movie._id, clipId: clipId as any })`, show `toast.success("Added to movie!")`, close dialog
- Handle error with `toast.error`
- Import: Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription from `@/components/ui/dialog`, useMutation/useQuery from convex/react, api, toast from sonner, Film from lucide-react

**1b. Enhance `src/components/library/save-clip-dialog.tsx`:**

Add an `onSaved` optional callback prop so the create page can capture the new clip ID after saving.

- Add to the interface: `onSaved?: (clipId: string) => void`
- Add to destructured props
- In `handleSave`, capture the return value of `saveClip()` (it returns the new clip ID) and call `onSaved`:
  ```typescript
  const newClipId = await saveClip({ ... });
  toast.success("Clip saved!");
  onSaved?.(newClipId);
  onOpenChange(false);
  ```
  Note: `saveClip` is a mutation that returns the inserted ID. The current code does `await saveClip(...)` without capturing the return. Change to `const newClipId = await saveClip(...)` and call `onSaved?.(String(newClipId))` before closing.

**1c. Modify `src/components/movie/timeline-scene.tsx`:**

Add a "Generate next scene" button that appears on hover, positioned at bottom-right (opposite corner from the existing remove button at top-right).

- Import `FastForward` from `lucide-react` and `useRouter` from `next/navigation`
- Add `const router = useRouter();` inside the component
- Add a new button element AFTER the existing remove button, inside the same outer div (which has `className="group relative ..."` and thus supports `group-hover`):
  ```tsx
  {clip && (
    <button
      className="absolute bottom-1 right-1 z-10 rounded-full bg-primary/80 text-primary-foreground p-0.5 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-primary"
      onClick={(e) => {
        e.stopPropagation();
        e.preventDefault();
        router.push(`/create?sourceClipId=${clip._id}`);
      }}
      onPointerDown={(e) => e.stopPropagation()}
      title="Generate next scene"
    >
      <FastForward className="h-3 w-3" />
    </button>
  )}
  ```
- The `onPointerDown` stopPropagation prevents drag activation (same pattern as the existing remove button)

**1d. Modify `src/components/library/clip-card.tsx`:**

Add a "Generate Next" button to the existing button row (alongside Open and Delete).

- Import `FastForward` from `lucide-react` and `useRouter` from `next/navigation`
- Add `const router = useRouter();` inside the component
- In the `<div className="flex items-center gap-2">` section (the button row), add a new button between Open and Delete:
  ```tsx
  <Button
    variant="outline"
    size="sm"
    className="text-xs"
    onClick={(e) => {
      e.stopPropagation();
      router.push(`/create?sourceClipId=${clip._id}`);
    }}
    title="Generate next scene"
  >
    <FastForward className="h-3 w-3" />
  </Button>
  ```
- Keep Open as `flex-1` and have the FastForward and Delete buttons as fixed-width icon-only buttons.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify `add-to-movie-dialog.tsx` exists and exports `AddToMovieDialog`. Verify `save-clip-dialog.tsx` contains "onSaved". Verify `timeline-scene.tsx` contains "sourceClipId". Verify `clip-card.tsx` contains "FastForward".
  </verify>
  <done>
AddToMovieDialog component exists and lists movies for clip insertion. SaveClipDialog has onSaved callback. Timeline scene shows "Generate next scene" button on hover. Clip card shows "Generate next scene" button in actions row.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire continuation mode into create page</name>
  <files>
    src/app/(app)/create/page.tsx
    src/app/(app)/create/create-page-client.tsx
  </files>
  <action>
**2a. Modify `src/app/(app)/create/page.tsx`:**

Add `sourceClipId` to the search params extraction and pass it to `CreatePageClient`.

Current searchParams type: `{ template?: string; clipId?: string }`
Updated: `{ template?: string; clipId?: string; sourceClipId?: string }`

Pass `sourceClipId={params.sourceClipId}` to `<CreatePageClient>`.

**2b. Modify `src/app/(app)/create/create-page-client.tsx`:**

This is the main modification. Add continuation mode and contextual actions.

**Props changes:**
- Add `sourceClipId?: string` to `CreateContentProps` and `CreatePageClientProps`
- Pass through from `CreatePageClient` to `CreateContent`

**New imports (add to existing imports):**
- Add `FastForward, Film` to the existing `lucide-react` import (which already has `Save`)
- `import { AddToMovieDialog } from "@/components/library/add-to-movie-dialog"`
- `import { useRouter } from "next/navigation"`

**Inside CreateContent component, add these state and hooks:**

1. **Source clip query** (for continuation mode context display):
   ```typescript
   const sourceClipData = useQuery(
     api.clips.get,
     sourceClipId ? { id: sourceClipId as any } : "skip"
   );
   ```

2. **generateContinuation action hook:**
   ```typescript
   const continuationAction = useAction(api.generateAnimation.generateContinuation);
   ```

3. **Router for navigation:**
   ```typescript
   const router = useRouter();
   ```

4. **New state variables:**
   ```typescript
   const [showAddToMovieDialog, setShowAddToMovieDialog] = useState(false);
   const [savedClipId, setSavedClipId] = useState<string | null>(null);
   ```

5. **Derived value for contextual actions:**
   ```typescript
   const effectiveClipId = clipId ?? savedClipId;
   ```

6. **handleContinuationGenerate callback** -- follows the exact same structure as handleGenerate but calls continuationAction instead of generate:
   ```typescript
   const handleContinuationGenerate = useCallback(async (prompt: string) => {
     if (!sourceClipId) return;
     setError(null);
     setIsGenerating(true);
     setIsEditing(false);
     setEditedCode(null);
     setSkipValidation(true);
     validation.resetToValid();
     setChatMessages([]);
     setSavedClipId(null);

     setCurrentStep("analyzing");
     await new Promise((r) => setTimeout(r, 500));
     setCurrentStep("generating");

     try {
       const result = await continuationAction({
         sourceClipId: sourceClipId as any,
         prompt: prompt || undefined,
       });

       setCurrentStep("validating");
       await new Promise((r) => setTimeout(r, 300));

       setLastGeneration({
         id: "continuation",
         rawCode: result.rawCode,
         code: result.code,
         durationInFrames: result.durationInFrames,
         fps: result.fps,
       });
       setLastPrompt(prompt || "Continuation from previous scene");
       toast.success("Continuation generated!");
     } catch (e) {
       const errorMessage = e instanceof Error ? e.message : "Continuation failed";
       setError({ message: errorMessage, retryCount: (error?.retryCount ?? 0) + 1 });
       toast.error("Continuation generation failed");
     } finally {
       setIsGenerating(false);
       setCurrentStep(null);
     }
   }, [sourceClipId, continuationAction, error?.retryCount, validation]);
   ```

7. **Modify handleUnifiedSubmit** to route to continuation when in continuation mode:
   ```typescript
   const handleUnifiedSubmit = useCallback(async (text: string) => {
     if (sourceClipId && !lastGeneration) {
       // Continuation mode: first submission generates continuation
       await handleContinuationGenerate(text);
     } else if (!lastGeneration) {
       await handleGenerate(text);
     } else if (text.toLowerCase().startsWith("start over:")) {
       const newPrompt = text.replace(/^start over:\s*/i, "").trim();
       setChatMessages([]);
       setEditedCode(null);
       setLastGeneration(null);
       setIsEditing(false);
       setSkipValidation(true);
       validation.resetToValid();
       if (newPrompt) {
         await handleGenerate(newPrompt);
       }
     } else {
       await handleRefine(text);
     }
   }, [sourceClipId, lastGeneration, handleGenerate, handleContinuationGenerate, handleRefine, validation]);
   ```

8. **Update promptPlaceholder** to handle continuation mode:
   ```typescript
   const promptPlaceholder = sourceClipId
     ? "Describe what should happen next (or press Enter for automatic continuation)..."
     : selectedTemplate
       ? "Describe how you'd like to customize this template..."
       : undefined;
   ```

**JSX changes:**

9. **Add continuation context banner** BEFORE the existing template context banner:
   ```tsx
   {sourceClipId && sourceClipData && !isGenerating && !lastGeneration && (
     <div className="w-full max-w-2xl mb-6 p-4 bg-primary/5 border border-primary/20 rounded-lg">
       <p className="text-sm font-medium">
         Generating continuation from: {sourceClipData.name}
       </p>
       <p className="text-xs text-muted-foreground mt-1">
         The next scene will start where this clip&apos;s animation ends.
       </p>
     </div>
   )}
   ```
   The existing template banner condition should add `&& !sourceClipId` to avoid showing both.

10. **Replace the existing "Save clip" section** (the `<div className="pt-2 border-t">` containing just the Save as Clip button) with contextual actions:
    ```tsx
    {/* Contextual actions */}
    <div className="pt-2 border-t">
      <div className="flex items-center gap-2 flex-wrap">
        {/* Save as Clip -- always available */}
        <Button variant="outline" size="sm" onClick={() => setShowSaveDialog(true)}>
          <Save className="h-4 w-4 mr-2" />
          Save as Clip
        </Button>

        {/* Add to Movie -- available when clip is saved */}
        {effectiveClipId && (
          <Button variant="outline" size="sm" onClick={() => setShowAddToMovieDialog(true)}>
            <Film className="h-4 w-4 mr-2" />
            Add to Movie
          </Button>
        )}

        {/* Generate Next Scene -- available when clip is saved */}
        {effectiveClipId && (
          <Button variant="outline" size="sm" onClick={() => router.push(`/create?sourceClipId=${effectiveClipId}`)}>
            <FastForward className="h-4 w-4 mr-2" />
            Generate Next Scene
          </Button>
        )}
      </div>
    </div>
    ```

11. **Update SaveClipDialog** usage to capture saved clip ID:
    ```tsx
    <SaveClipDialog
      open={showSaveDialog}
      onOpenChange={setShowSaveDialog}
      rawCode={editorCode}
      code={previewCode}
      durationInFrames={lastGeneration?.durationInFrames ?? 90}
      fps={lastGeneration?.fps ?? 30}
      defaultName={lastPrompt.slice(0, 50) || "Untitled Clip"}
      onSaved={(newClipId) => setSavedClipId(newClipId)}
    />
    ```

12. **Add AddToMovieDialog** after SaveClipDialog:
    ```tsx
    {effectiveClipId && (
      <AddToMovieDialog
        open={showAddToMovieDialog}
        onOpenChange={setShowAddToMovieDialog}
        clipId={effectiveClipId}
      />
    )}
    ```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify `page.tsx` extracts sourceClipId. Verify `create-page-client.tsx` contains "generateContinuation", "AddToMovieDialog", "sourceClipId", "effectiveClipId", "savedClipId". Run `npm run build` or `npx tsc --noEmit` to ensure no build errors.
  </verify>
  <done>
Create page accepts `sourceClipId` search param and enters continuation mode. Shows source clip context banner, calls `generateContinuation` instead of `generate`, shows continuation-specific prompt placeholder. After generation and save, shows contextual actions: Save as Clip, Add to Movie, Generate Next Scene. AddToMovieDialog and SaveClipDialog onSaved callback are wired up.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify continuation generation flow end-to-end</name>
  <what-built>
Full continuation generation workflow:
- "Generate next scene" buttons on timeline scenes (hover) and clip cards
- Create page continuation mode (via sourceClipId param)
- generateContinuation backend action with specialized prompt
- Contextual actions: Save as Clip, Add to Movie, Generate Next Scene
- AddToMovieDialog for adding clips to movies from create page
  </what-built>
  <how-to-verify>
1. Open the app at http://localhost:3000
2. Navigate to Library -- pick any saved clip
3. Verify the clip card shows a "Generate next scene" button (FastForward icon) alongside Open and Delete
4. Click the FastForward button -- verify it navigates to /create?sourceClipId=XXX
5. On the create page, verify:
   a. A banner shows "Generating continuation from: [clip name]"
   b. The prompt placeholder mentions continuation
   c. Type a prompt (or leave empty) and press Enter
   d. Wait for generation -- should show analyzing/generating/validating steps
   e. Preview should show an animation that visually relates to the source clip
6. After generation, verify contextual actions:
   a. "Save as Clip" button is visible
   b. Click "Save as Clip" and save it
   c. After saving, "Add to Movie" and "Generate Next Scene" buttons appear
7. Test "Add to Movie":
   a. Click "Add to Movie"
   b. Dialog should list your movies
   c. Click a movie -- toast should confirm "Added to movie!"
8. Test "Generate Next Scene" from create page:
   a. Click "Generate Next Scene" button
   b. Should navigate to /create?sourceClipId=NEW_CLIP_ID (a fresh continuation page)
9. Navigate to a Movie editor page with scenes
10. Hover a timeline scene -- verify the FastForward button appears at bottom-right
11. Click it -- verify navigation to /create?sourceClipId=XXX
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `src/app/(app)/create/page.tsx` extracts `sourceClipId` from search params
2. `create-page-client.tsx` calls `generateContinuation` when `sourceClipId` is present
3. `create-page-client.tsx` shows contextual actions (Save, Add to Movie, Generate Next Scene) based on clip save state
4. `add-to-movie-dialog.tsx` exists and calls `movies.addScene`
5. `save-clip-dialog.tsx` has `onSaved` callback that returns new clip ID
6. `timeline-scene.tsx` has FastForward hover button navigating to `/create?sourceClipId=`
7. `clip-card.tsx` has FastForward button navigating to `/create?sourceClipId=`
8. `npx tsc --noEmit` passes
9. Full continuation flow works: trigger -> generate -> preview -> save -> contextual actions
</verification>

<success_criteria>
- User can trigger continuation from timeline scene hover button
- User can trigger continuation from clip card action button
- Create page shows continuation context and calls correct backend action
- Generated continuation is previewed in the existing PreviewPlayer
- After saving, Add to Movie and Generate Next Scene actions are available
- Add to Movie dialog lists user's movies and adds the clip as a scene
- The entire flow works without page refresh or manual navigation
</success_criteria>

<output>
After completion, create `.planning/phases/12-continuation-generation/12-02-SUMMARY.md`
</output>
