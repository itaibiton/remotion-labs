---
phase: 08-export-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/export-utils.ts
  - src/lib/export-single-file.ts
  - src/lib/export-project-zip.ts
autonomous: true

must_haves:
  truths:
    - "Export utilities correctly detect Remotion APIs used in rawCode"
    - "Single-file export produces valid .tsx with imports, Composition wrapper, and registerRoot"
    - "Project zip export produces a complete Remotion project scaffold (6 files)"
    - "Metadata comments (DURATION, FPS) are extracted as numbers and stripped from exported code"
  artifacts:
    - path: "src/lib/export-utils.ts"
      provides: "Import detection, metadata extraction, download trigger"
      exports: ["detectUsedAPIs", "extractMetadata", "downloadBlob", "downloadTextFile"]
    - path: "src/lib/export-single-file.ts"
      provides: "Single .tsx file content generation"
      exports: ["generateSingleFile"]
    - path: "src/lib/export-project-zip.ts"
      provides: "Full Remotion project zip generation"
      exports: ["generateProjectZip"]
  key_links:
    - from: "src/lib/export-single-file.ts"
      to: "src/lib/export-utils.ts"
      via: "import detectUsedAPIs, extractMetadata"
      pattern: "import.*from.*export-utils"
    - from: "src/lib/export-project-zip.ts"
      to: "src/lib/export-utils.ts"
      via: "import detectUsedAPIs, extractMetadata"
      pattern: "import.*from.*export-utils"
    - from: "src/lib/export-project-zip.ts"
      to: "jszip"
      via: "import JSZip from jszip"
      pattern: "import JSZip"
---

<objective>
Create the export utility library: shared helpers (API detection, metadata extraction, download trigger), single-file `.tsx` generator, and full project zip generator. Install JSZip for client-side zip creation.

Purpose: These are the pure-logic building blocks that power both export paths. They transform `rawCode` (import-free JSX) into standalone, runnable Remotion code.
Output: Three library files in `src/lib/` plus JSZip dependency installed.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-polish/08-RESEARCH.md

@src/lib/remotion-allowlist.ts
@src/components/render/download-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install JSZip and create export-utils.ts</name>
  <files>package.json, src/lib/export-utils.ts</files>
  <action>
1. Install JSZip: `npm install jszip` (JSZip 3.x ships its own TypeScript types, no @types needed).

2. Create `src/lib/export-utils.ts` with these exports:

**REMOTION_APIS map** — A `Record<string, string>` mapping API identifier names to their import source. Include all Remotion APIs from `remotion-allowlist.ts` ALLOWED_GLOBALS that are Remotion-specific (NOT JS globals like Math, Array, etc. and NOT React hooks like useState). The map must include at minimum: `AbsoluteFill`, `useCurrentFrame`, `useVideoConfig`, `interpolate`, `spring`, `Easing`, `Sequence`, `Audio`, `Img`, `Video`, `OffthreadVideo`, `Series`, `Loop`, `Freeze`, `Still`, `random`, `staticFile`, `interpolateColors`, `measureSpring`, `continueRender`, `delayRender`, `getInputProps`, `getRemotionEnvironment`, `useCurrentScale`. All map to `"remotion"`.

**detectUsedAPIs(code: string): string[]** — Scans code for Remotion API identifiers using word-boundary regex (`\b${api}\b`). Returns array of matched API names. Does NOT include React (handled separately). Does NOT include scaffold-only APIs (Composition, registerRoot) — those are added by the generators.

**extractMetadata(rawCode: string): { durationInFrames: number; fps: number; cleanedCode: string }** — Extracts `// DURATION: N` and `// FPS: N` from rawCode via regex. Returns parsed numeric values (defaults: 90 frames, 30 fps if not found). `cleanedCode` has these comment lines stripped and is trimmed.

**downloadBlob(blob: Blob, filename: string): void** — Creates Object URL, creates anchor element, triggers download, removes anchor, revokes URL. Follow the pattern from `download-button.tsx` but ADD `URL.revokeObjectURL(url)` after click (the existing code misses this).

**downloadTextFile(content: string, filename: string): void** — Creates Blob with `text/plain;charset=utf-8` type, calls downloadBlob.
  </action>
  <verify>
- `npm ls jszip` shows jszip installed
- File `src/lib/export-utils.ts` exists with all 5 exports
- `npx tsc --noEmit` passes (no TypeScript errors)
  </verify>
  <done>JSZip installed. export-utils.ts exports detectUsedAPIs, extractMetadata, downloadBlob, downloadTextFile, and REMOTION_APIS map. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create export-single-file.ts</name>
  <files>src/lib/export-single-file.ts</files>
  <action>
Create `src/lib/export-single-file.ts` with:

**ExportOptions interface:**
```typescript
interface ExportOptions {
  rawCode: string;
  prompt: string;
  durationInFrames: number;
  fps: number;
}
```

**generateSingleFile(options: ExportOptions): string** — Produces a complete, standalone `.tsx` file string:

1. Call `detectUsedAPIs(rawCode)` to find used Remotion APIs
2. Call `extractMetadata(rawCode)` to get cleanedCode (metadata comments stripped)
3. Combine detected APIs with scaffold APIs: `["Composition", "registerRoot"]` (always needed). Deduplicate with `Set`.
4. Build the file content in this exact order:
   - Header comment: `// Generated by RemotionLab`
   - Prompt comment: `// Prompt: "{escaped prompt}"` (escape double quotes in prompt)
   - Blank line
   - `import React from "react";`
   - `import { ...detected + scaffold APIs... } from "remotion";` (one per line, sorted alphabetically for consistency)
   - Blank line
   - The cleanedCode (metadata stripped). If it contains `const MyComposition =`, do NOT modify. The raw JSX is preserved as-is.
   - Blank line
   - RemotionRoot component:
     ```tsx
     export const RemotionRoot: React.FC = () => {
       return (
         <Composition
           id="MyComposition"
           component={MyComposition}
           durationInFrames={N}
           fps={N}
           width={1920}
           height={1080}
         />
       );
     };
     ```
   - Blank line
   - `registerRoot(RemotionRoot);`
   - Trailing newline

Use the `durationInFrames` and `fps` from the ExportOptions (these come from the generation result, which already parsed metadata). Do NOT re-parse from rawCode — extractMetadata is only for stripping comments from the code body.

**Export both the interface and function.**
  </action>
  <verify>
- File `src/lib/export-single-file.ts` exists
- `npx tsc --noEmit` passes
- Exported function signature matches: `generateSingleFile(options: ExportOptions): string`
  </verify>
  <done>generateSingleFile produces a complete .tsx string with header comments, React + Remotion imports (auto-detected), cleaned component body, Composition wrapper with correct dimensions, and registerRoot call.</done>
</task>

<task type="auto">
  <name>Task 3: Create export-project-zip.ts</name>
  <files>src/lib/export-project-zip.ts</files>
  <action>
Create `src/lib/export-project-zip.ts` with:

Import JSZip and the shared utilities from export-utils.ts. Reuse ExportOptions from export-single-file.ts (re-export or duplicate the interface).

**generateProjectZip(options: ExportOptions): Promise&lt;Blob&gt;** — Creates a zip blob containing a complete Remotion project scaffold:

The zip root folder is `remotionlab-export/`. It contains 6 files:

1. **`src/MyComposition.tsx`** — The user's component WITH imports but WITHOUT registerRoot/Composition:
   - Header comments (Generated by RemotionLab + prompt)
   - `import React from "react";`
   - `import { ...detected APIs... } from "remotion";` (only APIs used in code, NOT Composition/registerRoot)
   - cleanedCode with `const MyComposition` replaced by `export const MyComposition` (add export keyword)
   - Trailing newline

2. **`src/Root.tsx`** — Composition setup:
   ```tsx
   import React from "react";
   import { Composition } from "remotion";
   import { MyComposition } from "./MyComposition";

   export const RemotionRoot: React.FC = () => {
     return (
       <Composition
         id="MyComposition"
         component={MyComposition}
         durationInFrames={N}
         fps={N}
         width={1920}
         height={1080}
       />
     );
   };
   ```

3. **`src/index.ts`** — Entry point:
   ```ts
   import { registerRoot } from "remotion";
   import { RemotionRoot } from "./Root";

   registerRoot(RemotionRoot);
   ```

4. **`package.json`** — Use the template from RESEARCH.md. Name: "remotionlab-export", private: true. Dependencies: `@remotion/cli: "^4.0.0"`, `react: "^19.0.0"`, `react-dom: "^19.0.0"`, `remotion: "^4.0.0"`. DevDependencies: `@types/react: "^19"`, `typescript: "^5"`. Scripts: dev (npx remotion studio), render (npx remotion render MyComposition out/video.mp4), build (npx remotion bundle).

5. **`tsconfig.json`** — Standard Remotion tsconfig from RESEARCH.md. Target ES2018, module commonjs, jsx react-jsx, strict true, noEmit true, lib es2015, esModuleInterop true, skipLibCheck true, forceConsistentCasingInFileNames true.

6. **`remotion.config.ts`** — Import Config from `@remotion/cli/config` (NOT from "remotion" -- v4 change). Call `Config.setVideoImageFormat("jpeg")` and `Config.setOverwriteOutput(true)`.

Use `JSZip` to create the zip:
```typescript
const zip = new JSZip();
const root = zip.folder("remotionlab-export")!;
const src = root.folder("src")!;
src.file("MyComposition.tsx", componentContent);
src.file("Root.tsx", rootContent);
src.file("index.ts", indexContent);
root.file("package.json", packageJsonContent);
root.file("tsconfig.json", tsconfigContent);
root.file("remotion.config.ts", remotionConfigContent);
return zip.generateAsync({ type: "blob" });
```

Export the function and reuse/re-export ExportOptions.
  </action>
  <verify>
- File `src/lib/export-project-zip.ts` exists
- `npx tsc --noEmit` passes
- Exported function signature: `generateProjectZip(options: ExportOptions): Promise<Blob>`
  </verify>
  <done>generateProjectZip produces a zip Blob containing 6 files in remotionlab-export/ folder: 3 source files (MyComposition.tsx with exports, Root.tsx with Composition, index.ts with registerRoot), package.json, tsconfig.json, and remotion.config.ts. The scaffold is a runnable Remotion project.</done>
</task>

</tasks>

<verification>
1. `npm ls jszip` confirms installation
2. `npx tsc --noEmit` passes with no errors across all 3 new files
3. All exports are properly typed (ExportOptions interface, function signatures)
4. REMOTION_APIS map covers all Remotion-specific identifiers from remotion-allowlist.ts
5. No circular dependencies between the 3 files
</verification>

<success_criteria>
- JSZip is installed as a production dependency
- Three new files exist in src/lib/ with correct exports
- TypeScript compilation succeeds
- detectUsedAPIs correctly maps Remotion identifiers
- extractMetadata parses DURATION/FPS comments and strips them
- generateSingleFile produces a complete standalone .tsx with imports + Composition + registerRoot
- generateProjectZip produces a zip Blob with 6-file scaffold
- Config import uses @remotion/cli/config (v4 pattern, not "remotion")
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-polish/08-01-SUMMARY.md`
</output>
