---
phase: 03-preview-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/remotion/compositions/TextAnimation.tsx
  - src/components/preview/preview-player.tsx
  - src/app/create/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees animation preview immediately after generation completes"
    - "Preview plays in browser without requiring render"
    - "User can replay preview as many times as desired"
    - "Preview displays correct text, style, colors from generation"
  artifacts:
    - path: "src/remotion/compositions/TextAnimation.tsx"
      provides: "Remotion composition for all 4 animation styles"
      exports: ["TextAnimation", "TextAnimationProps"]
    - path: "src/components/preview/preview-player.tsx"
      provides: "Client component wrapper for Remotion Player with controls"
      exports: ["PreviewPlayer"]
  key_links:
    - from: "src/app/create/page.tsx"
      to: "src/components/preview/preview-player.tsx"
      via: "PreviewPlayer component with animationProps"
      pattern: "<PreviewPlayer.*animationProps"
    - from: "src/components/preview/preview-player.tsx"
      to: "src/remotion/compositions/TextAnimation.tsx"
      via: "dynamic import for Player component"
      pattern: "dynamic.*TextAnimation"
    - from: "src/remotion/compositions/TextAnimation.tsx"
      to: "remotion"
      via: "useCurrentFrame, interpolate, spring hooks"
      pattern: "useCurrentFrame|interpolate|spring"
---

<objective>
Implement real-time browser preview of generated animations using Remotion Player.

Purpose: Users can immediately see their animation after generation, replay it, and verify it looks correct before proceeding to render (Phase 5).

Output: PreviewPlayer component displaying TextAnimation composition, integrated into create page success state.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-preview-system/03-RESEARCH.md
@convex/schema.ts
@src/app/create/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Remotion packages</name>
  <files>package.json, package-lock.json</files>
  <action>
Install Remotion core packages for browser preview:
```bash
npm install remotion @remotion/player @remotion/google-fonts
```

These packages provide:
- `remotion`: Core hooks (useCurrentFrame, interpolate, spring, Easing)
- `@remotion/player`: Browser-based Player component
- `@remotion/google-fonts`: Type-safe font loading (ensures fonts load before render)

Do NOT install `@remotion/cli` or `@remotion/bundler` - those are for Phase 5 rendering.
  </action>
  <verify>
Run `npm ls remotion @remotion/player @remotion/google-fonts` and confirm all three packages installed (version 4.x).
  </verify>
  <done>package.json includes remotion, @remotion/player, @remotion/google-fonts as dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create TextAnimation composition</name>
  <files>src/remotion/compositions/TextAnimation.tsx</files>
  <action>
Create the Remotion composition that renders text with one of four animation styles.

**File: `src/remotion/compositions/TextAnimation.tsx`**

Requirements:
1. Export `TextAnimationProps` interface matching Convex schema:
   - text: string
   - style: "fade-in" | "typewriter" | "slide-up" | "scale"
   - fontFamily: string
   - fontSize: number
   - color: string
   - backgroundColor?: string
   - durationInFrames: number
   - fps: 30

2. Use `useCurrentFrame()` and `useVideoConfig()` from remotion

3. Implement all four animation styles using `interpolate()` and `spring()`:
   - **fade-in**: Opacity 0->1 over first 30 frames, use `extrapolateRight: "clamp"`
   - **typewriter**: Reveal characters progressively over 80% of duration using `text.slice(0, charsToShow)`, add blinking cursor
   - **slide-up**: translateY 100->0 with opacity 0->1, use `Easing.out(Easing.cubic)` for smooth decel
   - **scale**: Use `spring({ frame, fps, config: { stiffness: 100, damping: 10 } })` for bouncy scale-in

4. Use `AbsoluteFill` for full-bleed container with centered flex layout

5. Load Inter font via `@remotion/google-fonts/Inter` as fallback (use loadFont())

6. IMPORTANT: Always use `extrapolateRight: "clamp"` to prevent values exceeding bounds

Export both the component and the props type (for use in PreviewPlayer).
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>TextAnimation.tsx exports TextAnimationProps interface and TextAnimation component with all 4 animation styles implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create PreviewPlayer component</name>
  <files>src/components/preview/preview-player.tsx</files>
  <action>
Create a client component that wraps Remotion Player with custom controls.

**File: `src/components/preview/preview-player.tsx`**

Requirements:
1. Add `"use client"` directive at top

2. Use `next/dynamic` with `ssr: false` for both Player and TextAnimation imports:
   - Player: `dynamic(() => import("@remotion/player").then(mod => mod.Player), { ssr: false, loading: () => <LoadingPlaceholder /> })`
   - TextAnimation: `dynamic(() => import("@/remotion/compositions/TextAnimation"), { ssr: false })`

   This prevents SSR hydration errors (Remotion uses browser APIs).

3. Create loading placeholder: `<div className="aspect-video bg-black rounded-lg animate-pulse" />`

4. Accept `animationProps` prop with type imported from TextAnimation

5. Use `useRef<PlayerRef>` for external control reference

6. Memoize inputProps with `useMemo()` to prevent unnecessary re-renders

7. Render Player with:
   - component={TextAnimation}
   - inputProps={memoizedProps}
   - durationInFrames, fps from props
   - compositionWidth={1920}, compositionHeight={1080}
   - style={{ width: "100%" }}
   - controls={false} (we provide custom controls)
   - loop={true}
   - autoPlay={true}

8. Add custom control buttons using shadcn Button:
   - Play/Pause toggle: Show Play icon when paused, Pause when playing
   - Replay button: seekTo(0) then play()
   - Use lucide-react icons: Play, Pause, RotateCcw

9. Track isPlaying state via player events:
   - player.addEventListener("play", onPlay)
   - player.addEventListener("pause", onPause)
   - Clean up listeners on unmount

10. Style container with rounded corners, shadow, centered controls below player

Do NOT use the built-in `controls` prop - custom controls match our design system.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Imports resolve correctly (no missing module errors).
  </verify>
  <done>PreviewPlayer component exists with Player wrapper, custom play/pause/replay controls, SSR disabled via next/dynamic</done>
</task>

<task type="auto">
  <name>Task 4: Wire preview into create page</name>
  <files>src/app/create/page.tsx</files>
  <action>
Replace the "Preview will be available in Phase 3" placeholder with the actual PreviewPlayer component.

Modifications to `src/app/create/page.tsx`:

1. Import PreviewPlayer:
   ```tsx
   import { PreviewPlayer } from "@/components/preview/preview-player";
   ```

2. In the success state section (around line 113-146), replace the entire success state block:

   OLD (remove):
   ```tsx
   {lastGeneration && !isGenerating && !error && (
     <div className="w-full max-w-2xl mb-6 p-4 bg-green-50 ...">
       ... "Preview will be available in Phase 3" ...
     </div>
   )}
   ```

   NEW (add):
   ```tsx
   {lastGeneration && !isGenerating && !error && (
     <div className="w-full max-w-2xl mb-6">
       <PreviewPlayer animationProps={lastGeneration.animationProps} />
       <div className="mt-4 flex items-center justify-between p-4 bg-muted/50 rounded-lg">
         <div className="text-sm text-muted-foreground">
           <p><span className="font-medium">Text:</span> {lastGeneration.animationProps.text}</p>
           <p><span className="font-medium">Style:</span> {lastGeneration.animationProps.style}</p>
         </div>
         <button
           onClick={handleRetry}
           className="text-sm text-primary underline hover:no-underline"
         >
           Regenerate
         </button>
       </div>
     </div>
   )}
   ```

3. The animationProps type should match - both use the same shape from Convex schema.

Keep the toast notification calls unchanged.
  </action>
  <verify>
Run dev server: `npm run dev`
Navigate to /create, generate an animation, verify PreviewPlayer renders without errors in browser console.
  </verify>
  <done>Create page displays PreviewPlayer with animation after successful generation, no console errors</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete preview system: Remotion Player displaying TextAnimation composition with all 4 styles (fade-in, typewriter, slide-up, scale), custom play/pause/replay controls, integrated into /create page success state.
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/create
3. Enter a prompt like "Hello World with fade animation"
4. Wait for generation to complete
5. Verify:
   - [ ] Preview player appears immediately after generation
   - [ ] Animation plays automatically
   - [ ] Play/Pause button toggles playback
   - [ ] Replay button restarts animation from beginning
   - [ ] Animation loops continuously
   - [ ] Text, colors, and style match what was generated
   - [ ] No console errors related to SSR or hydration
6. Try different prompts to test other styles:
   - "Typing effect for Welcome" (typewriter)
   - "Slide up Hello" (slide-up)
   - "Bouncy scale text" (scale)
7. Verify each animation style renders correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase-level verification (after all tasks complete):

1. **Package installation**: `npm ls remotion` shows version 4.x
2. **Composition exists**: `src/remotion/compositions/TextAnimation.tsx` exports component
3. **Player wrapper exists**: `src/components/preview/preview-player.tsx` uses next/dynamic with ssr: false
4. **Integration complete**: Create page imports and uses PreviewPlayer
5. **All styles work**: fade-in, typewriter, slide-up, scale all animate correctly
6. **No SSR errors**: No "window is not defined" or hydration mismatch errors
</verification>

<success_criteria>
- User sees animation preview immediately after generation completes
- Preview plays in browser without requiring backend render
- All 4 animation styles (fade-in, typewriter, slide-up, scale) render correctly
- User can play, pause, and replay the preview
- Animation loops automatically
- No console errors during preview playback
</success_criteria>

<output>
After completion, create `.planning/phases/03-preview-system/03-01-SUMMARY.md`
</output>
