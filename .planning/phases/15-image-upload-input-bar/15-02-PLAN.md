---
phase: 15-image-upload-input-bar
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/hooks/use-image-upload.ts
  - src/components/generation/image-attachment.tsx
autonomous: true

must_haves:
  truths:
    - "User can attach images via file picker click, drag-drop onto the input area, or clipboard paste"
    - "Attached images appear as thumbnail chips with visible remove buttons"
    - "Images are validated (type, size) with error toasts on rejection"
    - "Removing an image revokes its object URL to prevent memory leaks"
    - "Maximum 3 images enforced; additional attachments show a toast error"
    - "uploadAll returns Convex storage IDs after EXIF stripping and upload"
  artifacts:
    - path: "src/hooks/use-image-upload.ts"
      provides: "useImageUpload hook managing attached images state, add/remove/upload/clear"
      exports: ["useImageUpload", "AttachedImage"]
    - path: "src/components/generation/image-attachment.tsx"
      provides: "ImageAttachment component with thumbnail chips and remove buttons"
      exports: ["ImageAttachment"]
  key_links:
    - from: "src/hooks/use-image-upload.ts"
      to: "convex/files.ts"
      via: "useMutation(api.files.generateUploadUrl) for upload URL generation"
      pattern: "api\\.files\\.generateUploadUrl"
    - from: "src/hooks/use-image-upload.ts"
      to: "src/lib/image-utils.ts"
      via: "Calls stripExifAndResize and validateImageFile before upload"
      pattern: "stripExifAndResize|validateImageFile"
    - from: "src/components/generation/image-attachment.tsx"
      to: "src/hooks/use-image-upload.ts"
      via: "Receives images array and handlers from hook (not internal hook usage)"
      pattern: "AttachedImage"
---

<objective>
Build the image attachment UI components and upload hook for attaching reference images before generation.

Purpose: Creates the user-facing image attachment experience -- a custom hook managing the attached images lifecycle (add, validate, preview, remove, upload, clear) and a presentational component rendering thumbnail chips with remove buttons. These are composed into the input bar in plan 15-03.

Output: `src/hooks/use-image-upload.ts` (upload state management hook), `src/components/generation/image-attachment.tsx` (thumbnail chips UI).
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-image-upload-input-bar/15-RESEARCH.md
@.planning/phases/15-image-upload-input-bar/15-01-SUMMARY.md
@src/lib/image-utils.ts
@convex/files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: useImageUpload hook with full lifecycle management</name>
  <files>src/hooks/use-image-upload.ts</files>
  <action>
Create `src/hooks/use-image-upload.ts` with the following:

**Exported type:**
```typescript
export interface AttachedImage {
  id: string;              // crypto.randomUUID() client-side unique ID
  file: File;              // Original file for upload
  previewUrl: string;      // URL.createObjectURL for thumbnail display
  status: "pending" | "uploading" | "uploaded" | "error";
}
```

**Hook: `useImageUpload(maxImages: number = 3)`**

State: `images: AttachedImage[]` via useState.

Dependencies:
- `useMutation(api.files.generateUploadUrl)` from `convex/react`
- Import `validateImageFile`, `stripExifAndResize`, `MAX_IMAGES` from `@/lib/image-utils`
- Import `toast` from `sonner`

**Methods to return:**

1. `addImages(files: File[]): void` (synchronous, no await)
   - Filter files through `validateImageFile()`. For each invalid file, call `toast.error(validation.error)` and skip it.
   - Check if adding valid files would exceed `maxImages`. If so, toast.error `"Maximum ${maxImages} images allowed"` and only take as many as fit.
   - For each valid file: create `AttachedImage` with `id: crypto.randomUUID()`, `previewUrl: URL.createObjectURL(file)`, `status: "pending"`.
   - Append new images to state via `setImages(prev => [...prev, ...newImages])`.

2. `removeImage(id: string): void`
   - Find the image by id. Call `URL.revokeObjectURL(image.previewUrl)` to prevent memory leak.
   - Filter it out of state.

3. `uploadAll(): Promise<string[]>` (called at generation time, NOT on attach)
   - For each image with status "pending":
     a. Set its status to "uploading" via state update
     b. Call `stripExifAndResize(image.file)` to get a clean Blob
     c. Call `generateUploadUrl()` to get a fresh upload URL (IMPORTANT: generate URL right before POST, not earlier -- URLs expire after 1 hour)
     d. `fetch(postUrl, { method: "POST", headers: { "Content-Type": blob.type || "image/jpeg" }, body: blob })`
     e. Parse response JSON to get `storageId`
     f. Set status to "uploaded"
   - On per-image error: set that image's status to "error", toast.error the message, but continue uploading others.
   - Return array of all successfully uploaded storageId strings.
   - Use sequential uploads (not Promise.all) to avoid overwhelming the upload endpoint. A simple for-of loop is fine for 1-3 images.

4. `clear(): void`
   - Revoke ALL preview URLs: `images.forEach(img => URL.revokeObjectURL(img.previewUrl))`
   - Set images to empty array.

**Cleanup effect:**
```typescript
useEffect(() => {
  return () => {
    // Revoke all preview URLs on unmount
    images.forEach(img => URL.revokeObjectURL(img.previewUrl));
  };
}, []);  // Empty deps -- cleanup only on unmount
```

NOTE: The empty deps array is intentional. We only want to clean up URLs when the component unmounts, not on every images change (removeImage already handles individual cleanup). Store a ref to images for the cleanup: use `useRef` that tracks current images array, read from ref in cleanup.

Revised cleanup pattern:
```typescript
const imagesRef = useRef<AttachedImage[]>([]);
imagesRef.current = images;

useEffect(() => {
  return () => {
    imagesRef.current.forEach(img => URL.revokeObjectURL(img.previewUrl));
  };
}, []);
```

**Return value:**
```typescript
return { images, addImages, removeImage, uploadAll, clear };
```
  </action>
  <verify>
`npx tsc --noEmit` passes. Verify the hook file exports `useImageUpload` and `AttachedImage`. Confirm it imports from `@/lib/image-utils` (stripExifAndResize, validateImageFile) and `convex/react` (useMutation) and uses `api.files.generateUploadUrl`.
  </verify>
  <done>
useImageUpload hook exists with addImages (validates, creates previews), removeImage (revokes URL), uploadAll (EXIF strips, uploads to Convex, returns storageIds), clear (full cleanup), and unmount cleanup via ref.
  </done>
</task>

<task type="auto">
  <name>Task 2: ImageAttachment presentational component with thumbnail chips</name>
  <files>src/components/generation/image-attachment.tsx</files>
  <action>
Create `src/components/generation/image-attachment.tsx` as a **presentational component** (no internal hook usage -- receives data and handlers via props, consistent with GenerationSettingsPanel pattern).

**Props interface:**
```typescript
import type { AttachedImage } from "@/hooks/use-image-upload";

interface ImageAttachmentProps {
  images: AttachedImage[];
  onRemove: (id: string) => void;
  onAddFiles: (files: File[]) => void;
  disabled?: boolean;
  maxImages?: number;
}
```

**Component structure:**

The component renders when `images.length > 0` or can always render (parent controls visibility). It contains:

1. **Thumbnail chips row** -- horizontal flex wrap of attached image chips:
   - Each chip: a `div` with `relative group` classes, containing:
     - `<img src={image.previewUrl} alt="Reference" className="h-12 w-12 rounded-md object-cover" />`
     - Upload status overlay: if `image.status === "uploading"`, show a semi-transparent overlay with a `Loader2` spinner (from lucide-react).
     - Error overlay: if `image.status === "error"`, show a red-tinted overlay with `AlertCircle` icon.
     - Remove button: `<button>` with absolute positioning (-top-1.5 -right-1.5), circular, bg-destructive, contains `X` icon (h-3 w-3). Hidden by default, visible on group-hover via `opacity-0 group-hover:opacity-100 transition-opacity`. Calls `onRemove(image.id)` on click. Disabled when `disabled` prop is true.

2. **Add more button** (inline with chips) -- shown when `images.length < (maxImages ?? 3)` and not disabled:
   - A dashed-border button (h-12 w-12, rounded-md, border-dashed border-2, flex items-center justify-center) containing a `Plus` icon.
   - Clicking opens a hidden `<input type="file" accept="image/jpeg,image/png,image/webp,image/gif" multiple>` via ref click.
   - The input's onChange extracts `Array.from(e.target.files ?? [])` and calls `onAddFiles(files)`, then resets the input value so the same file can be re-selected.

**Styling:**
- Container: `flex flex-wrap gap-2 items-center`
- Chips use `rounded-md border bg-muted/30` for subtle containment
- Use `lucide-react` icons: `X`, `Loader2`, `AlertCircle`, `Plus`

**Export:** Named export `ImageAttachment`.

This component does NOT handle drag-drop or paste -- those events are handled at the input-bar level (plan 15-03) and call the same `onAddFiles` callback.
  </action>
  <verify>
`npx tsc --noEmit` passes. Verify the component exports `ImageAttachment`. Confirm it imports `AttachedImage` type from `@/hooks/use-image-upload` and icons from `lucide-react`. Verify it uses `onRemove` and `onAddFiles` callbacks (presentational pattern).
  </verify>
  <done>
ImageAttachment component renders thumbnail chips (12x12 with object-cover) for each attached image, with hover-reveal remove buttons, upload/error status overlays, and an inline add-more button triggering a hidden file input. Fully presentational -- no internal state or hooks.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `src/hooks/use-image-upload.ts` exports `useImageUpload` hook and `AttachedImage` type
3. Hook returns `{ images, addImages, removeImage, uploadAll, clear }`
4. Hook uses `api.files.generateUploadUrl` (Convex mutation)
5. Hook calls `stripExifAndResize` from image-utils before upload
6. Hook calls `validateImageFile` on addImages with toast errors for invalid files
7. `src/components/generation/image-attachment.tsx` exports `ImageAttachment`
8. Component renders thumbnail chips with remove buttons and upload status indicators
9. Component has hidden file input triggered by add-more button
10. No memory leak: removeImage revokes URL, clear revokes all, unmount cleanup via ref
</verification>

<success_criteria>
- useImageUpload hook manages the full image attachment lifecycle: validate, preview, upload, cleanup
- ImageAttachment component displays thumbnail chips with remove buttons, upload spinners, and error states
- Upload happens at generation time (uploadAll called externally), not on attach
- Memory management: all object URLs are properly revoked (remove, clear, unmount)
- Presentational component pattern maintained (no internal hooks, receives all data via props)
</success_criteria>

<output>
After completion, create `.planning/phases/15-image-upload-input-bar/15-02-SUMMARY.md`
</output>
