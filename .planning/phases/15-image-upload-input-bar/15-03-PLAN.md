---
phase: 15-image-upload-input-bar
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - src/components/generation/input-bar.tsx
  - src/app/(app)/create/create-page-client.tsx
autonomous: true

must_haves:
  truths:
    - "Input bar shows prompt textarea, image upload button, settings toggle, variation count, and generate button in one cohesive layout"
    - "User can drag-drop images onto the input bar and paste images from clipboard"
    - "Attached image thumbnails appear above the textarea within the input bar"
    - "Generate button triggers image upload (uploadAll) before calling the generation action"
    - "Settings panel toggles open/closed below the input bar when settings button is clicked"
    - "Variation count selector (1-4) is inline in the input bar toolbar"
    - "All existing create page functionality preserved (refine, continuation, template, feed selection)"
  artifacts:
    - path: "src/components/generation/input-bar.tsx"
      provides: "Unified InputBar component composing textarea, images, settings, generate"
      exports: ["InputBar"]
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Create page wired to InputBar with image upload integration"
      contains: "InputBar"
  key_links:
    - from: "src/components/generation/input-bar.tsx"
      to: "src/hooks/use-image-upload.ts"
      via: "Uses useImageUpload hook for image state and upload"
      pattern: "useImageUpload"
    - from: "src/components/generation/input-bar.tsx"
      to: "src/components/generation/image-attachment.tsx"
      via: "Renders ImageAttachment for thumbnail chips"
      pattern: "ImageAttachment"
    - from: "src/components/generation/input-bar.tsx"
      to: "src/components/generation/generation-settings.tsx"
      via: "Renders GenerationSettingsPanel in collapsible section"
      pattern: "GenerationSettingsPanel"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "src/components/generation/input-bar.tsx"
      via: "Replaces PromptInput + standalone settings with InputBar"
      pattern: "InputBar"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "convex/generateAnimation.ts"
      via: "Passes referenceImageIds from uploadAll() to generate/generateVariations"
      pattern: "referenceImageIds"
---

<objective>
Build the unified input bar component and wire it into the create page, replacing the separate PromptInput and settings toggle.

Purpose: Delivers the redesigned input bar that composes all generation controls (prompt textarea, image attachment, settings toggle, variation selector, generate button) into a single cohesive component. Also wires image upload into the generation flow so images are uploaded on submit and passed as referenceImageIds to the backend.

Output: `src/components/generation/input-bar.tsx` (new unified component), updated `src/app/(app)/create/create-page-client.tsx` (replaced PromptInput + settings with InputBar, added image upload flow).
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-image-upload-input-bar/15-RESEARCH.md
@.planning/phases/15-image-upload-input-bar/15-01-SUMMARY.md
@src/components/generation/prompt-input.tsx
@src/components/generation/generation-settings.tsx
@src/components/generation/image-attachment.tsx
@src/hooks/use-image-upload.ts
@src/hooks/use-generation-settings.ts
@src/app/(app)/create/create-page-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: InputBar unified component with drag-drop, paste, and all controls</name>
  <files>src/components/generation/input-bar.tsx</files>
  <action>
Create `src/components/generation/input-bar.tsx` -- a self-contained input bar that composes all generation controls.

**Props interface:**
```typescript
interface InputBarProps {
  onSubmit: (prompt: string, imageIds: string[]) => Promise<void>;
  isGenerating: boolean;
  isRefining?: boolean;
  hasExistingCode?: boolean;
  disabled?: boolean;
  placeholder?: string;
  settings: GenerationSettings;
  onUpdateSetting: <K extends keyof GenerationSettings>(key: K, value: GenerationSettings[K]) => void;
  onResetSettings: () => void;
}
```

**Internal state:**
- `prompt: string` via useState (text content)
- `showSettings: boolean` via useState (toggle settings panel)
- `isDragging: boolean` via useState (visual drag-over indicator)
- `isUploading: boolean` via useState (disable controls during upload)
- `useImageUpload()` hook for image management (images, addImages, removeImage, uploadAll, clear)

**Character count** (same as current PromptInput): MAX_CHARS = 2000, WARN_CHARS = 1500.

**Layout structure** (from top to bottom):

```
+----------------------------------------------------------+
| [ImageAttachment chips + add button] (if images.length>0)|
+----------------------------------------------------------+
| [Textarea: prompt input                                ] |
|                                                          |
|                                        [charCount/2000]  |
+----------------------------------------------------------+
| [ImageBtn] [SettingsBtn] [V: 1 2 3 4]      [GenerateBtn]|
+----------------------------------------------------------+
| [GenerationSettingsPanel] (collapsible, shown if toggle) |
+----------------------------------------------------------+
```

**Container div:**
- `w-full max-w-2xl mx-auto` (matches current PromptInput width)
- Apply drag-drop event handlers on this container:
  - `onDragOver`: `e.preventDefault(); e.stopPropagation(); setIsDragging(true);`
  - `onDragLeave`: `e.preventDefault(); e.stopPropagation(); setIsDragging(false);`
  - `onDrop`: `e.preventDefault(); e.stopPropagation(); setIsDragging(false);` then extract `Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"))` and call `addImages(files)` if any.
- When `isDragging`, add a visual indicator: `ring-2 ring-primary ring-offset-2` on the container border.

**Image chips section** (top, inside the bordered container):
- Render `<ImageAttachment images={images} onRemove={removeImage} onAddFiles={addImages} disabled={isGenerating || isUploading} maxImages={3} />` only when `images.length > 0`.
- Wrap in a div with `px-3 pt-3` padding (inside the border, above textarea).

**Textarea:**
- Use the shadcn `<Textarea>` component.
- `min-h-[100px]` (or `min-h-[80px]` if hasExistingCode), `resize-none`, no visible border on the textarea itself (the container provides the border).
- Add `border-0 focus-visible:ring-0 shadow-none` to make textarea borderless within the input bar container.
- `onPaste` handler: Check `e.clipboardData.files` for image files. If image files found, call `e.preventDefault()` and `addImages(Array.from(files).filter(f => f.type.startsWith("image/")))`. If no image files, let paste proceed normally (text paste).
- `onKeyDown`: Cmd/Ctrl+Enter triggers submit (same as current).
- Character count badge: absolute-positioned in bottom-right of textarea area.

**Toolbar row** (bottom of the bordered container):
- `flex items-center gap-2 px-3 pb-3 pt-1`
- Left side (flex items-center gap-2):
  - **Image button:** A small icon button (ghost variant, `ImagePlus` icon from lucide-react). Opens a hidden `<input type="file" accept="image/jpeg,image/png,image/webp,image/gif" multiple>` on click. Disabled when images.length >= 3 or isGenerating.
  - **Settings toggle:** Button (ghost, `Settings2` icon). Toggles `showSettings`. Highlighted when showSettings is true (use `variant={showSettings ? "secondary" : "ghost"}`).
  - **Variation selector:** Inline group of small buttons [1] [2] [3] [4]. Active = `variant="default"`, inactive = `variant="ghost"` with `h-7 w-7 text-xs` sizing. Updates `settings.variationCount` via `onUpdateSetting("variationCount", n)`. Hide in refinement mode (hasExistingCode).
- Right side (ml-auto):
  - **Generate button:** `Button` with appropriate text: "Generating..." / "Refining..." / "Send" (hasExistingCode) / "Generate". Disabled when: no prompt text, over char limit, isGenerating, isRefining, isUploading. Shows a `Loader2` spinner when isGenerating or isUploading.

**Outer container** applies the border: `rounded-xl border bg-background shadow-sm` with the drag indicator class when isDragging.

**Settings panel** (below the bordered container):
- Rendered conditionally when `showSettings && !hasExistingCode`.
- `<div className="mt-2 p-4 border rounded-lg">` containing `<GenerationSettingsPanel settings={settings} onUpdateSetting={onUpdateSetting} onReset={onResetSettings} />`.

**Example prompts** (below everything, generation mode only):
- Same as current PromptInput: show when `!hasExistingCode && !prompt`.
- Render the 4 example prompt chips. Clicking sets `prompt` to that text.

**Submit handler (handleSubmit):**
```typescript
const handleSubmit = useCallback(async () => {
  const trimmedPrompt = prompt.trim();
  if (!trimmedPrompt || isOverLimit || isGenerating || isRefining || disabled) return;

  try {
    let imageIds: string[] = [];
    if (images.length > 0) {
      setIsUploading(true);
      imageIds = await uploadAll();
      setIsUploading(false);
    }
    await onSubmit(trimmedPrompt, imageIds);
    setPrompt("");
    clear(); // Clear attached images after successful submit
  } catch {
    setIsUploading(false);
    // Keep prompt and images on failure so user can retry
  }
}, [prompt, isOverLimit, isGenerating, isRefining, disabled, images.length, uploadAll, onSubmit, clear]);
```

**Icons used:** `ImagePlus`, `Settings2`, `Loader2`, `X` from lucide-react.

**Do NOT** include the refinement hint or "start over:" text in this component -- that logic stays in the create page's submit handler.
  </action>
  <verify>
`npx tsc --noEmit` passes. Verify the component exports `InputBar`. Confirm it imports `useImageUpload` from hook, `ImageAttachment` from component, `GenerationSettingsPanel`, `GenerationSettings` type, and Textarea/Button from shadcn. Verify drag-drop handlers exist (onDragOver, onDragLeave, onDrop). Verify paste handler exists on the textarea. Verify submit handler calls `uploadAll()` then `onSubmit(prompt, imageIds)`.
  </verify>
  <done>
InputBar component renders a unified input area with: image thumbnails (top), borderless textarea (middle), toolbar with image button + settings toggle + variation selector + generate button (bottom), and collapsible settings panel. Supports drag-drop on container and paste on textarea for image attachment. Submit uploads images first then calls onSubmit with prompt and imageIds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire InputBar into create page, replacing PromptInput and standalone settings</name>
  <files>src/app/(app)/create/create-page-client.tsx</files>
  <action>
Update `src/app/(app)/create/create-page-client.tsx` to replace the current `PromptInput` + standalone settings toggle/panel with the new `InputBar`.

**Changes:**

1. **Update imports:**
   - Remove: `import { PromptInput } from "@/components/generation/prompt-input";`
   - Remove: `import { GenerationSettingsPanel } from "@/components/generation/generation-settings";`
   - Remove: `import { Settings2 } from "lucide-react";` (only if Settings2 is no longer used elsewhere in the file -- check other usages first; it's likely only used for the settings toggle which moves into InputBar)
   - Add: `import { InputBar } from "@/components/generation/input-bar";`

2. **Remove `showSettings` state:**
   - Delete: `const [showSettings, setShowSettings] = useState(false);`
   - Settings toggle is now internal to InputBar.

3. **Update `handleGenerate` to accept `referenceImageIds`:**
   Change signature of `handleGenerate` from `async (prompt: string)` to `async (prompt: string, referenceImageIds?: string[])`.

   In the `generateVariationsAction` call, add `referenceImageIds`:
   ```typescript
   const result = await generateVariationsAction({
     prompt,
     variationCount: settings.variationCount,
     aspectRatio: settings.aspectRatio,
     durationInSeconds: settings.durationInSeconds,
     fps: settings.fps,
     referenceImageIds: referenceImageIds as any, // Storage IDs from upload
   });
   ```

   In the single `generate` call, add `referenceImageIds`:
   ```typescript
   const result = await generate({
     prompt,
     aspectRatio: settings.aspectRatio,
     durationInSeconds: settings.durationInSeconds,
     fps: settings.fps,
     referenceImageIds: referenceImageIds as any,
   });
   ```

4. **Update `handleUnifiedSubmit` to accept `imageIds`:**
   Change from `async (text: string)` to `async (text: string, imageIds: string[])`.

   Pass imageIds through to `handleGenerate`:
   - `handleContinuationGenerate(text)` stays the same (continuations don't use images)
   - `handleGenerate(text)` becomes `handleGenerate(text, imageIds.length > 0 ? imageIds : undefined)`
   - `handleRefine(text)` stays the same (refinements don't use images)
   - The `start over:` branch: `handleGenerate(newPrompt)` becomes `handleGenerate(newPrompt, imageIds.length > 0 ? imageIds : undefined)`

5. **Replace the settings section and PromptInput in JSX:**

   Remove the entire `{/* Settings toggle + panel */}` block (lines ~578-601 in current file):
   ```jsx
   {!isGenerating && (
     <div className="w-full max-w-2xl mb-4">
       <div className="flex items-center justify-end mb-2">
         <Button variant="ghost" size="sm" onClick={() => setShowSettings(!showSettings)}>
           <Settings2 className="h-4 w-4 mr-2" />Settings
         </Button>
       </div>
       {showSettings && (
         <div className="p-4 border rounded-lg mb-4">
           <GenerationSettingsPanel ... />
         </div>
       )}
     </div>
   )}
   ```

   Remove the PromptInput block (~lines 603-613):
   ```jsx
   {!isGenerating && (
     <PromptInput onSubmit={handleUnifiedSubmit} ... />
   )}
   ```

   Replace both with a single `InputBar` block:
   ```jsx
   {!isGenerating && (
     <InputBar
       onSubmit={handleUnifiedSubmit}
       isGenerating={isGenerating}
       isRefining={isRefining}
       hasExistingCode={!!lastGeneration}
       disabled={false}
       placeholder={promptPlaceholder}
       settings={settings}
       onUpdateSetting={updateSetting}
       onResetSettings={resetSettings}
     />
   )}
   ```

6. **Update the `useCallback` dependency arrays** for `handleGenerate` and `handleUnifiedSubmit` to reflect the new signatures. No new state dependencies needed since imageIds flow through from onSubmit args.

7. **Do NOT remove `prompt-input.tsx`** -- it may be used elsewhere or useful as reference. Just stop importing it in create-page-client.

**Verify preserved functionality:**
- Template context banner still renders
- Continuation context banner still renders
- Error state still renders
- Generating state still renders
- Success state (preview + code + actions) still renders
- Feed still renders below input bar when no generation selected
- Refinement flow still works (hasExistingCode mode)
- Continuation flow still works
  </action>
  <verify>
`npx tsc --noEmit` passes. Run `npm run build` (or `next build`) to verify the page compiles. Verify `create-page-client.tsx` imports `InputBar` (not `PromptInput`). Verify `handleGenerate` passes `referenceImageIds` to both `generate` and `generateVariations`. Verify the page JSX contains exactly one `<InputBar>` and zero `<PromptInput>` instances. Verify `handleUnifiedSubmit` accepts `(text: string, imageIds: string[])`.
  </verify>
  <done>
Create page uses InputBar as the single input component. Settings toggle, variation selector, image upload button, and generate button are all composed within InputBar. Image upload flow: InputBar calls uploadAll on submit, passes storageIds to handleUnifiedSubmit, which passes to handleGenerate, which passes to generate/generateVariations actions. All existing functionality (refine, continuation, feed, template, error handling) preserved.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (page compiles)
3. `src/components/generation/input-bar.tsx` exports `InputBar`
4. InputBar has drag-drop handlers (onDragOver, onDragLeave, onDrop) on container
5. InputBar has paste handler on textarea that filters for image files
6. InputBar toolbar has: image button, settings toggle, variation buttons (1-4), generate button
7. InputBar submit handler calls `uploadAll()` before `onSubmit(prompt, imageIds)`
8. `create-page-client.tsx` uses `InputBar` (not `PromptInput`)
9. `handleGenerate` passes `referenceImageIds` to both `generate` and `generateVariations` actions
10. Settings panel renders inside InputBar, not as standalone section
11. No `showSettings` state in create-page-client (moved into InputBar)
12. Feed, continuation, template, error, generating, success states all still render correctly
</verification>

<success_criteria>
- Unified input bar displays all controls: prompt, image upload, settings, variations, generate
- Drag-drop onto input bar attaches images
- Clipboard paste in textarea attaches images (text paste still works)
- Image upload happens on generate (not on attach)
- Settings panel is collapsible within the input bar
- Variation count selector is inline in toolbar
- All existing create page flows preserved (generate, refine, continue, template, feed)
- referenceImageIds flow from upload through to backend generation actions
</success_criteria>

<output>
After completion, create `.planning/phases/15-image-upload-input-bar/15-03-SUMMARY.md`
</output>
