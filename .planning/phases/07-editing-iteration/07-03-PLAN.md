---
phase: 07-editing-iteration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - convex/generateAnimation.ts
  - src/components/generation/chat-messages.tsx
autonomous: true

must_haves:
  truths:
    - "User can send a refinement message and receive modified code from Claude"
    - "Chat conversation history is sent with each refinement request"
    - "Conversation history is capped at 10 exchanges to prevent token overflow"
    - "Chat messages display with visual distinction between user and assistant"
  artifacts:
    - path: "convex/generateAnimation.ts"
      provides: "refine action for multi-turn chat refinement"
      exports: ["refine"]
    - path: "src/components/generation/chat-messages.tsx"
      provides: "Chat message history display component"
      exports: ["ChatMessages"]
  key_links:
    - from: "convex/generateAnimation.ts (refine)"
      to: "@anthropic-ai/sdk"
      via: "messages.create with conversation history array"
      pattern: "client.messages.create"
    - from: "src/components/generation/chat-messages.tsx"
      to: "ChatMessage type"
      via: "renders array of user/assistant messages"
      pattern: "role.*user.*assistant"
---

<objective>
Add Claude multi-turn chat refinement action and chat message display component.

Purpose: Users need to refine animations through conversation ("make it faster", "change color to blue"). Claude receives the full conversation history and current code to produce modified code. The chat UI shows the conversation flow.

Output: Convex `refine` action that sends conversation history + current code to Claude and returns modified code. Chat messages component for displaying conversation history.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-editing-iteration/07-CONTEXT.md
@.planning/phases/07-editing-iteration/07-RESEARCH.md
@.planning/phases/07-editing-iteration/07-01-SUMMARY.md
@convex/generateAnimation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refine action to generateAnimation.ts</name>
  <files>convex/generateAnimation.ts</files>
  <action>
Add a new `refine` action export to `convex/generateAnimation.ts`. This action handles multi-turn chat refinement -- it takes the current code, a refinement prompt, and conversation history, then returns modified code from Claude.

1. **Add the refinement system prompt** as a constant, placed after the existing `SYSTEM_PROMPT`:

```typescript
const REFINEMENT_SYSTEM_PROMPT = `You are a Remotion animation code modifier. You receive existing Remotion code and a user request to modify it.

IMPORTANT: Output ONLY the complete modified code. No markdown, no explanations, no code blocks.

Your output must:
1. Be the complete, modified version of the code (not a diff or partial update)
2. Keep the component named "MyComposition"
3. Keep the // DURATION and // FPS comments (update values if the user requests timing changes)
4. Use only these APIs (already available, don't write import statements):
   - React, useState, useEffect, useMemo, useCallback
   - AbsoluteFill, useCurrentFrame, useVideoConfig, interpolate, spring, Sequence, Easing, random
   - Audio, Img, staticFile, Video, OffthreadVideo
   - Composition, Still, Series, Loop, Freeze

FORBIDDEN: import/require statements, eval, Function, fetch, document, window, process

Respond ONLY with the complete modified code. No explanations before or after.`;
```

2. **Export the refine action:**

```typescript
export const refine = action({
  args: {
    currentCode: v.string(),
    refinementPrompt: v.string(),
    conversationHistory: v.array(
      v.object({
        role: v.union(v.literal("user"), v.literal("assistant")),
        content: v.string(),
      })
    ),
  },
  handler: async (ctx, args): Promise<{
    rawCode: string;
    code: string;
    durationInFrames: number;
    fps: number;
  }> => {
    // Check authentication
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("You must be logged in to refine animations");
    }

    // Create Anthropic client
    const apiKey = process.env.ANTHROPIC_API_KEY;
    if (!apiKey) {
      throw new Error("ANTHROPIC_API_KEY not configured.");
    }

    const client = new Anthropic({ apiKey });

    // Build messages array: conversation history + new refinement request
    // Cap history at last 10 exchanges (20 messages) to prevent token overflow
    const maxHistoryMessages = 20;
    const trimmedHistory = args.conversationHistory.slice(-maxHistoryMessages);

    const messages: Array<{ role: "user" | "assistant"; content: string }> = [
      ...trimmedHistory,
      {
        role: "user" as const,
        content: `Current Remotion code:\n\n${args.currentCode}\n\nPlease modify it: ${args.refinementPrompt}`,
      },
    ];

    // Call Claude API with refinement system prompt
    const response = await client.messages.create({
      model: "claude-sonnet-4-5-20250929",
      max_tokens: 4096,
      system: REFINEMENT_SYSTEM_PROMPT,
      messages,
    });

    // Extract text content
    const textContent = response.content.find((block) => block.type === "text");
    if (!textContent || textContent.type !== "text") {
      throw new Error("Failed to refine animation: No response from AI.");
    }

    // Clean code (same logic as generate action)
    let rawCode = textContent.text.trim();
    if (rawCode.startsWith("```")) {
      rawCode = rawCode
        .replace(/^```(?:jsx|tsx|javascript|typescript)?\s*\n?/, "")
        .replace(/\n?```\s*$/, "")
        .trim();
    }

    // Extract metadata
    const durationMatch = rawCode.match(/\/\/\s*DURATION:\s*(\d+)/);
    const fpsMatch = rawCode.match(/\/\/\s*FPS:\s*(\d+)/);
    const rawDuration = durationMatch ? parseInt(durationMatch[1]) : 90;
    const durationInFrames = Math.min(Math.max(rawDuration, 30), 600);
    const fps = 30;

    // Validate the refined code (reuse existing inlined validation)
    const validation = validateRemotionCode(rawCode);
    if (!validation.valid) {
      throw new Error(
        `Refined code validation failed: ${validation.errors[0]?.message || "Invalid code"}`
      );
    }

    // Transform JSX to JavaScript
    const transformed = transformJSX(rawCode);
    if (!transformed.success || !transformed.code) {
      throw new Error(transformed.error || "Code transformation failed");
    }

    return {
      rawCode,
      code: transformed.code,
      durationInFrames,
      fps,
    };
  },
});
```

Note: The refine action does NOT store to the database -- it returns the code directly. The create page will update its local state. The user can trigger a new generation to persist.

Important: The `validateRemotionCode` and `transformJSX` functions are already inlined in this file from Phase 6. The refine action reuses them directly.
  </action>
  <verify>Run `npm run build` to verify TypeScript compilation. Grep for "export const refine" in `convex/generateAnimation.ts` to confirm the action exists. Grep for "REFINEMENT_SYSTEM_PROMPT" to confirm the prompt is defined.</verify>
  <done>Refine action accepts currentCode, refinementPrompt, and conversationHistory. Returns rawCode and code (transformed). Validates and transforms the refined output. Caps history at 10 exchanges.</done>
</task>

<task type="auto">
  <name>Task 2: Create chat messages display component</name>
  <files>src/components/generation/chat-messages.tsx</files>
  <action>
Create `src/components/generation/chat-messages.tsx` -- a component that displays the conversation history between user and Claude during refinement.

1. **Define and export the ChatMessage type:**
```typescript
export interface ChatMessage {
  role: "user" | "assistant";
  content: string;
}
```

2. **Create the ChatMessages component:**
```typescript
interface ChatMessagesProps {
  messages: ChatMessage[];
  isRefining?: boolean;  // Show loading indicator for pending response
}
```

3. **Render logic:**
   - If `messages` is empty, render nothing (return null)
   - Map over messages, rendering each with visual distinction:
     - **User messages:** Right-aligned, primary background color, rounded bubble. Show `User` icon from lucide-react. Display the content text.
     - **Assistant messages:** Left-aligned, muted background, rounded bubble. Show `Bot` icon from lucide-react. Display a summary of what was changed (the content for assistant messages will be a short description like "Updated animation speed and colors", NOT the full code).
   - Wrap in a scrollable container with `max-h-[200px] overflow-y-auto` so it doesn't take over the page.
   - Add a `ref` that scrolls to bottom when new messages arrive (useEffect with messages.length dependency, scrollIntoView on a bottom sentinel div).

4. **Loading state:**
   When `isRefining` is true, show a pulsing indicator at the bottom: "Claude is refining..." with a `Loader2` spinning icon from lucide-react.

5. **Styling (Tailwind):**
   - Container: `space-y-3 p-3`
   - User bubble: `ml-auto max-w-[80%] bg-primary text-primary-foreground rounded-lg rounded-tr-none px-3 py-2 text-sm`
   - Assistant bubble: `mr-auto max-w-[80%] bg-muted rounded-lg rounded-tl-none px-3 py-2 text-sm`
   - Icon: `h-4 w-4` inline with role label

Mark the file as `"use client"` since it uses refs and effects.

Import icons from lucide-react: `User`, `Bot`, `Loader2`.
  </action>
  <verify>Run `npm run build` to verify TypeScript compilation. Check that the file exports `ChatMessages` and `ChatMessage` type.</verify>
  <done>ChatMessages component renders conversation history with visual user/assistant distinction, auto-scrolls to latest message, shows refining indicator.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `refine` action exported from `convex/generateAnimation.ts`
3. `ChatMessages` component exported from `src/components/generation/chat-messages.tsx`
4. `ChatMessage` type exported for use by parent components
5. Refinement system prompt instructs Claude to output complete modified code
</verification>

<success_criteria>
- Refine action sends conversation history + current code to Claude and returns validated modified code
- Conversation history capped at 10 exchanges (20 messages)
- Chat messages component displays user/assistant messages with visual distinction
- Loading indicator shows during refinement
- Auto-scroll to latest message
</success_criteria>

<output>
After completion, create `.planning/phases/07-editing-iteration/07-03-SUMMARY.md`
</output>
