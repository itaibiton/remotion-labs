---
phase: 17-prequel-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/generateAnimation.ts
autonomous: true

must_haves:
  truths:
    - "PREQUEL_SYSTEM_PROMPT exists and instructs Claude to analyze frame-0 visual state and generate a composition whose final frame matches it"
    - "generatePrequel action accepts sourceClipId and optional prompt, fetches clip rawCode, calls Claude with PREQUEL_SYSTEM_PROMPT, validates, transforms, and returns result"
    - "generatePrequel follows identical post-processing pipeline as generateContinuation (markdown stripping, metadata extraction, validation, transformation)"
  artifacts:
    - path: "convex/generateAnimation.ts"
      provides: "PREQUEL_SYSTEM_PROMPT constant and generatePrequel exported action"
      contains: "PREQUEL_SYSTEM_PROMPT"
      exports: ["generatePrequel"]
  key_links:
    - from: "convex/generateAnimation.ts (generatePrequel)"
      to: "convex/clips.ts (internal.clips.getInternal)"
      via: "ctx.runQuery for fetching source clip rawCode"
      pattern: "ctx\\.runQuery\\(internal\\.clips\\.getInternal"
    - from: "convex/generateAnimation.ts (generatePrequel)"
      to: "convex/generateAnimation.ts (validateRemotionCode + transformJSX)"
      via: "shared validation and transformation pipeline"
      pattern: "validateRemotionCode.*transformJSX"
---

<objective>
Create the PREQUEL_SYSTEM_PROMPT and generatePrequel Convex action that enables generating animations whose final frame matches a target clip's opening frame (frame 0).

Purpose: This is the backend foundation for prequel generation -- the mirror image of Phase 12's continuation system. Without this, clicking "Extend Previous" in the UI has nothing to call.
Output: PREQUEL_SYSTEM_PROMPT constant and generatePrequel exported action in convex/generateAnimation.ts.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-prequel-generation/17-RESEARCH.md

Key reference: The existing CONTINUATION_SYSTEM_PROMPT (lines 358-439) and generateContinuation action (lines 931-1033) in convex/generateAnimation.ts are the exact templates. This plan creates their mirror images for prequel generation.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PREQUEL_SYSTEM_PROMPT constant</name>
  <files>convex/generateAnimation.ts</files>
  <action>
Add a new `PREQUEL_SYSTEM_PROMPT` constant immediately after the existing `CONTINUATION_SYSTEM_PROMPT` block (after line 439), with a section comment matching the existing style:

```
// ============================================================================
// Prequel System Prompt
// ============================================================================
```

The prompt follows the same three-step structure as CONTINUATION_SYSTEM_PROMPT but reversed:
- STEP 1: Analyze the target scene's INITIAL VISUAL STATE (frame 0), not final frame
- STEP 2: Add a comment block with `// PREQUEL FOR TARGET SCENE` and `// Start state (target frame 0): ...`
- STEP 3: Generate a new composition where the LAST FRAME matches the target's frame 0

Key differences from CONTINUATION_SYSTEM_PROMPT:
- Analysis direction: frame 0 instead of final frame
- `interpolate(frame, [0, ...], [startValue, ...])` outputs `startValue` at frame 0
- `spring({frame, fps, ...})` outputs `from` value (default 0) at frame 0
- Elements inside `<Sequence from={N}>` where N > 0 are NOT visible at frame 0
- Elements with `{frame > N && ...}` where N > 0 are NOT visible at frame 0
- Elements with opacity 0 at frame 0 are invisible
- Generated composition's LAST FRAME must match target's frame 0 (reverse of continuation)

Use the exact prompt text from the research file's Example 1 (17-RESEARCH.md lines 233-309). Keep identical CRITICAL RULES, component naming, API whitelist, and FORBIDDEN list as CONTINUATION_SYSTEM_PROMPT. Duration 60-180 frames, FPS 30.
  </action>
  <verify>
Grep for `PREQUEL_SYSTEM_PROMPT` in convex/generateAnimation.ts -- must find the constant declaration. Verify it contains "STEP 1", "STEP 2", "STEP 3", "frame 0", "LAST FRAME", "PREQUEL FOR TARGET SCENE", and the same CRITICAL RULES as CONTINUATION_SYSTEM_PROMPT.
  </verify>
  <done>PREQUEL_SYSTEM_PROMPT constant exists in convex/generateAnimation.ts with three-step analysis structure targeting frame-0 state extraction and prequel generation.</done>
</task>

<task type="auto">
  <name>Task 2: Add generatePrequel action</name>
  <files>convex/generateAnimation.ts</files>
  <action>
Add a `generatePrequel` exported action immediately after the existing `generateContinuation` action (after line 1033), with a section comment:

```
// ============================================================================
// Prequel Generation Action
// ============================================================================
```

The action mirrors `generateContinuation` exactly with these differences:
1. Args: `{ sourceClipId: v.id("clips"), prompt: v.optional(v.string()) }` (same)
2. Return type: `Promise<{ rawCode: string; code: string; durationInFrames: number; fps: number }>` (same)
3. Auth check: "You must be logged in to generate prequels"
4. Source clip fetch: same via `ctx.runQuery(internal.clips.getInternal, { id: args.sourceClipId })`
5. Error on missing rawCode: "Source clip has no raw code available for prequel generation"
6. User message framing (the KEY difference):
   - With prompt: `TARGET SCENE CODE:\n\`\`\`\n${sourceClip.rawCode}\n\`\`\`\n\nGenerate a prequel that leads into this scene: ${args.prompt}`
   - Without prompt: `TARGET SCENE CODE:\n\`\`\`\n${sourceClip.rawCode}\n\`\`\`\n\nGenerate a natural, visually interesting prequel that leads into this scene.`
7. System prompt: `PREQUEL_SYSTEM_PROMPT` (instead of `CONTINUATION_SYSTEM_PROMPT`)
8. Error messages: use "prequel" instead of "continuation" throughout
9. All post-processing (markdown stripping, duration extraction, clamping, validation, transformation) is identical to generateContinuation

Use model `"claude-sonnet-4-5-20250929"` and `max_tokens: 4096` (same as generateContinuation).

Add JSDoc comment matching generateContinuation's style:
```
/**
 * Generate a prequel scene that leads into an existing clip.
 * Fetches the source clip's rawCode, sends it to Claude with the prequel
 * system prompt, validates and transforms the output.
 * Does NOT persist to database -- returns result directly like refine.
 */
```
  </action>
  <verify>
Run `npx convex dev --typecheck=enable --once` (or check TypeScript compilation). The action must be exported and visible in the Convex API. Grep for `export const generatePrequel = action` in the file.
  </verify>
  <done>generatePrequel action is exported from convex/generateAnimation.ts, accepts sourceClipId + optional prompt, uses PREQUEL_SYSTEM_PROMPT, and returns validated/transformed code.</done>
</task>

</tasks>

<verification>
1. `grep -n "PREQUEL_SYSTEM_PROMPT" convex/generateAnimation.ts` finds both the constant declaration and its usage in generatePrequel
2. `grep -n "generatePrequel" convex/generateAnimation.ts` finds the exported action
3. `npx tsc --noEmit` passes (TypeScript compilation)
4. The generatePrequel action follows the identical pattern as generateContinuation -- same auth check, same clip fetch, same validation pipeline, same return type
</verification>

<success_criteria>
- PREQUEL_SYSTEM_PROMPT constant exists with frame-0 analysis instructions
- generatePrequel action is exported and callable from the frontend
- Both artifacts follow the exact same patterns as their continuation counterparts
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-prequel-generation/17-01-SUMMARY.md`
</output>
