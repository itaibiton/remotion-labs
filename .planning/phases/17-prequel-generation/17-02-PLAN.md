---
phase: 17-prequel-generation
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/components/generation/generation-row-actions.tsx
  - src/components/generation/generation-row.tsx
  - src/components/generation/variation-grid.tsx
  - src/components/generation/generation-feed.tsx
  - src/app/(app)/create/page.tsx
  - src/app/(app)/create/create-page-client.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks 'Extend Previous' on a generation dropdown and is navigated to prequel mode"
    - "Create page in prequel mode shows 'Generating prequel for: [clip name]' banner and calls generatePrequel instead of generateContinuation"
    - "User can preview, edit, and save the prequel just like any other generation"
  artifacts:
    - path: "src/components/generation/generation-row-actions.tsx"
      provides: "Extend Previous menu item with Rewind icon and onExtendPrevious callback"
      contains: "Extend Previous"
    - path: "src/app/(app)/create/page.tsx"
      provides: "mode search param extraction and forwarding to CreatePageClient"
      contains: "mode"
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Prequel mode handling: handlePrequelGenerate, handleExtendPreviousGeneration, mode-aware submit routing"
      contains: "generatePrequel"
  key_links:
    - from: "src/components/generation/generation-row-actions.tsx"
      to: "src/app/(app)/create/create-page-client.tsx"
      via: "onExtendPrevious callback threaded through generation-row -> variation-grid -> generation-feed -> create-page-client"
      pattern: "onExtendPrevious"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "convex/generateAnimation.ts (generatePrequel)"
      via: "useAction(api.generateAnimation.generatePrequel)"
      pattern: "api\\.generateAnimation\\.generatePrequel"
    - from: "src/app/(app)/create/create-page-client.tsx (handleExtendPreviousGeneration)"
      to: "/create?sourceClipId=X&mode=prequel"
      via: "save-then-navigate with mode=prequel URL param"
      pattern: "mode=prequel"
---

<objective>
Wire the "Extend Previous" button through the UI component chain and add prequel mode to the create page, completing the full prequel generation flow from user click to generated animation.

Purpose: This connects the generatePrequel backend (Plan 17-01) to the user-facing UI. Users click "Extend Previous" on any generation, which auto-saves as a clip and navigates to prequel mode where the create page calls generatePrequel.
Output: "Extend Previous" in dropdown menu, callback threading through 4 component layers, prequel mode in create page with banner, placeholder, and submit routing.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-prequel-generation/17-RESEARCH.md
@.planning/phases/17-prequel-generation/17-01-SUMMARY.md
@.planning/phases/16-per-creation-actions/16-02-SUMMARY.md

Key reference: Phase 16-02's extend-next wiring is the exact template. This plan adds onExtendPrevious through the identical 5-file chain (actions -> row -> grid -> feed -> create page). The create page adds a `mode` prop and prequel-specific handling alongside the existing continuation mode.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Extend Previous" to GenerationRowActions and thread callback through component chain</name>
  <files>
    src/components/generation/generation-row-actions.tsx
    src/components/generation/generation-row.tsx
    src/components/generation/variation-grid.tsx
    src/components/generation/generation-feed.tsx
  </files>
  <action>
Follow the EXACT same pattern as the extend-next wiring (Phase 16-02). Modify 4 files in sequence:

**1. generation-row-actions.tsx:**
- Add `Rewind` to the lucide-react import (alongside existing `MoreHorizontal, Save, RotateCcw, Trash2, FastForward`)
- Add `onExtendPrevious: (generation: Generation) => void` to `GenerationRowActionsProps` interface
- Add `onExtendPrevious` to the destructured props
- Add a new `DropdownMenuItem` for "Extend Previous" AFTER the "Extend Next" menu item and BEFORE "Rerun":
  ```tsx
  <DropdownMenuItem
    onSelect={() => onExtendPrevious(generation)}
    disabled={isFailed || !generation.code}
  >
    <Rewind className="h-4 w-4" />
    Extend Previous
  </DropdownMenuItem>
  ```

**2. generation-row.tsx:**
- Add `onExtendPrevious: (generation: GenerationRowProps["generation"]) => void` to `GenerationRowProps` interface
- Add `onExtendPrevious` to the destructured props in the component function
- Pass `onExtendPrevious={onExtendPrevious}` to the `<GenerationRowActions>` component (alongside existing `onExtendNext`)

**3. variation-grid.tsx:**
- Add `onExtendPrevious: (generation: Generation) => void` to `VariationGridProps` interface
- Add `onExtendPrevious` to the destructured props
- Pass `onExtendPrevious={onExtendPrevious}` to BOTH batch-level and per-variation `<GenerationRowActions>` instances (same places where `onExtendNext` is currently passed)

**4. generation-feed.tsx:**
- Add `onExtendPreviousGeneration: (generation: any) => void` to `GenerationFeedProps` interface
- Add `onExtendPreviousGeneration` to the destructured props
- Pass `onExtendPrevious={onExtendPreviousGeneration}` to both `<GenerationRow>` and `<VariationGrid>` components (same pattern as `onExtendNext={onExtendNextGeneration}`)
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`. Grep for "onExtendPrevious" in all 4 files to confirm the callback chain is complete. Grep for "Extend Previous" in generation-row-actions.tsx.
  </verify>
  <done>
"Extend Previous" menu item exists in GenerationRowActions dropdown. The onExtendPrevious callback is threaded through GenerationRow, VariationGrid, and GenerationFeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mode param to create page and implement prequel mode with extend-previous handler</name>
  <files>
    src/app/(app)/create/page.tsx
    src/app/(app)/create/create-page-client.tsx
  </files>
  <action>
**1. page.tsx -- Add `mode` search param:**
- Add `mode?: string` to the searchParams type: `Promise<{ template?: string; clipId?: string; sourceClipId?: string; mode?: string }>`
- Pass `mode={params.mode}` as a new prop to `<CreatePageClient>`

**2. create-page-client.tsx -- Add prequel mode (6 changes):**

**(a) Props:** Add `mode?: string` to both `CreateContentProps` and `CreatePageClientProps` interfaces. Pass `mode={mode}` through from `CreatePageClient` to `CreateContent`.

**(b) Action hook:** Add the prequel action hook alongside the existing continuation hook:
```tsx
const prequelAction = useAction(api.generateAnimation.generatePrequel);
```

**(c) handlePrequelGenerate callback:** Add a new callback that mirrors `handleContinuationGenerate` (lines 310-354) but:
- Uses `prequelAction` instead of `continuationAction`
- Sets `id: "prequel"` in the generation result (not "continuation")
- Sets `lastPrompt` to `prompt || "Prequel leading into target scene"`
- Toast messages say "prequel" not "continuation"
- Error messages say "prequel" not "continuation"
- Same state management (setError, setIsGenerating, setCurrentStep, etc.)

**(d) handleExtendPreviousGeneration callback:** Mirrors `handleExtendNextGeneration` (lines 438-456) exactly but:
- Toast message: `"Saved as clip -- opening prequel generation..."`
- Navigation URL: `` router.push(`/create?sourceClipId=${clipId}&mode=prequel`) `` (note the `&mode=prequel`)
- Error message: `"Failed to start prequel generation"`

**(e) handleUnifiedSubmit update:** Modify the existing submit routing logic (lines 357-381) to handle prequel mode. Replace:
```tsx
if (sourceClipId && !lastGeneration) {
  await handleContinuationGenerate(text);
}
```
With:
```tsx
if (sourceClipId && mode === "prequel" && !lastGeneration) {
  await handlePrequelGenerate(text);
} else if (sourceClipId && !lastGeneration) {
  await handleContinuationGenerate(text);
}
```
Add `mode`, `handlePrequelGenerate` to the dependency array.

**(f) Context banner and placeholder update:** Modify the continuation context banner (lines 556-566) to be mode-aware:
- When `mode === "prequel"`: Title says `"Generating prequel for: {name}"`, subtitle says `"The new scene will lead into this clip's opening frame."`
- When continuation (default): Keep existing text unchanged

Modify `promptPlaceholder` (lines 548-552) to be mode-aware:
- When `sourceClipId && mode === "prequel"`: `"Describe what should lead into this scene (or press Enter for automatic prequel)..."`
- When `sourceClipId` (no mode or continuation): Keep existing text

**(g) GenerationFeed wiring:** Add `onExtendPreviousGeneration={handleExtendPreviousGeneration}` to the `<GenerationFeed>` component (alongside existing `onExtendNextGeneration`).
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit`. Grep for "mode" in page.tsx -- must find it in searchParams type. Grep for "handlePrequelGenerate" and "handleExtendPreviousGeneration" and "prequelAction" and "mode.*prequel" in create-page-client.tsx.
  </verify>
  <done>
Create page accepts `mode` search param. When `mode=prequel`, the page shows a prequel-specific banner, uses prequel-specific placeholder text, and routes submit to generatePrequel. The handleExtendPreviousGeneration handler saves as clip and navigates to prequel mode. GenerationFeed receives the onExtendPreviousGeneration callback.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "Extend Previous" src/components/generation/` finds the menu item in generation-row-actions.tsx
2. `grep -rn "onExtendPrevious" src/components/generation/ src/app/` confirms callback chain through all 5 component files
3. `grep -n "mode.*prequel" src/app/(app)/create/create-page-client.tsx` finds mode-aware routing logic
4. `grep -n "generatePrequel" src/app/(app)/create/create-page-client.tsx` finds the action hook usage
5. `npx tsc --noEmit` passes
6. Full flow: "Extend Previous" click -> auto-save as clip -> navigate to /create?sourceClipId=X&mode=prequel -> prequel banner shown -> submit calls generatePrequel -> preview appears
</verification>

<success_criteria>
- "Extend Previous" appears in every generation's dropdown menu (disabled for failed or code-less generations)
- Clicking "Extend Previous" saves the generation as a clip and navigates to /create?sourceClipId=X&mode=prequel
- Create page in prequel mode shows correct banner, placeholder, and routes to generatePrequel on submit
- Preview, edit, and save work identically to any other generation (no special prequel handling needed -- existing infrastructure handles it)
- TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-prequel-generation/17-02-SUMMARY.md`
</output>
