---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/layout.tsx
  - src/components/providers.tsx
  - convex/auth.config.ts
  - convex/schema.ts
  - convex/users.ts
  - .env.local
  - .env.example
autonomous: true
user_setup:
  - service: clerk
    why: "Authentication provider"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API keys -> Publishable key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API keys -> Secret keys"
    dashboard_config:
      - task: "Enable Google OAuth"
        location: "Clerk Dashboard -> User & Authentication -> Social connections -> Google"
      - task: "Enable GitHub OAuth"
        location: "Clerk Dashboard -> User & Authentication -> Social connections -> GitHub"
      - task: "Set session lifetime to 30 days"
        location: "Clerk Dashboard -> Sessions -> Session lifetime"
      - task: "Create JWT template for Convex"
        location: "Clerk Dashboard -> JWT Templates -> Create template (name: convex)"
  - service: convex
    why: "Backend database"
    env_vars:
      - name: NEXT_PUBLIC_CONVEX_URL
        source: "Convex Dashboard -> Settings -> Deployment URL (or from npx convex dev output)"
      - name: CONVEX_DEPLOY_KEY
        source: "Convex Dashboard -> Settings -> Deploy key (for production)"

must_haves:
  truths:
    - "App loads without errors in browser"
    - "ClerkProvider wraps the entire app"
    - "ConvexProviderWithClerk is nested inside ClerkProvider"
    - "Convex backend accepts Clerk JWT tokens"
  artifacts:
    - path: "src/components/providers.tsx"
      provides: "Client-side provider wrapper with Clerk + Convex"
      contains: "ConvexProviderWithClerk"
    - path: "src/app/layout.tsx"
      provides: "Root layout with providers"
      contains: "Providers"
    - path: "convex/auth.config.ts"
      provides: "Clerk JWT configuration for Convex"
      contains: "providers"
    - path: "convex/schema.ts"
      provides: "Database schema with users table"
      contains: "defineTable"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/components/providers.tsx"
      via: "import and render"
      pattern: "import.*Providers"
    - from: "src/components/providers.tsx"
      to: "convex/react-clerk"
      via: "ConvexProviderWithClerk"
      pattern: "ConvexProviderWithClerk"
    - from: "convex/auth.config.ts"
      to: "Clerk JWT issuer"
      via: "domain configuration"
      pattern: "CLERK_JWT_ISSUER_DOMAIN"
---

<objective>
Set up Next.js project with Clerk authentication and Convex backend integration.

Purpose: Establish the foundation for all authentication features. Without this wiring, no auth flows can work.
Output: Working Next.js app with Clerk + Convex providers configured, ready for auth UI components.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js project with dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.js (or next.config.ts)
    tailwind.config.ts
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    .env.local
    .env.example
    .gitignore
  </files>
  <action>
    Create a new Next.js 15+ project with App Router:

    1. Run `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"` (accept defaults, use current directory)

    2. Install auth dependencies:
       `npm install @clerk/nextjs convex`

    3. Create `.env.local` with placeholders (actual values will be added during user_setup):
       ```
       # Clerk
       NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_YOUR_KEY
       CLERK_SECRET_KEY=sk_test_YOUR_KEY
       NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=/create
       NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=/create

       # Convex
       NEXT_PUBLIC_CONVEX_URL=https://YOUR_DEPLOYMENT.convex.cloud

       # Clerk JWT for Convex
       CLERK_JWT_ISSUER_DOMAIN=https://YOUR_CLERK_INSTANCE.clerk.accounts.dev
       ```

    4. Create `.env.example` with same structure (no values) for documentation

    5. Update `.gitignore` to include `.env.local`

    6. Initialize Convex: `npx convex init`

    AVOID: Do not install @clerk/themes yet (not needed for MVP). Do not create custom auth pages (we're using modals).
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Visit http://localhost:3000 shows Next.js default page
    - `ls convex/` shows _generated folder exists
    - `.env.local` file exists with placeholders
  </verify>
  <done>
    Next.js app runs, Convex initialized, all dependencies installed, environment structure in place
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Clerk + Convex provider hierarchy</name>
  <files>
    src/components/providers.tsx
    src/app/layout.tsx
    convex/auth.config.ts
  </files>
  <action>
    1. Create `src/components/providers.tsx` as a client component:
       ```typescript
       "use client";

       import { ClerkProvider, useAuth } from "@clerk/nextjs";
       import { ConvexProviderWithClerk } from "convex/react-clerk";
       import { ConvexReactClient } from "convex/react";

       const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

       export function Providers({ children }: { children: React.ReactNode }) {
         return (
           <ClerkProvider publishableKey={process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY!}>
             <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
               {children}
             </ConvexProviderWithClerk>
           </ClerkProvider>
         );
       }
       ```

    2. Update `src/app/layout.tsx` to wrap children with Providers:
       - Import Providers from "@/components/providers"
       - Wrap {children} with <Providers>{children}</Providers>
       - Keep the html and body tags, Inter font, globals.css import

    3. Create `convex/auth.config.ts`:
       ```typescript
       export default {
         providers: [
           {
             domain: process.env.CLERK_JWT_ISSUER_DOMAIN,
             applicationID: "convex",
           },
         ],
       };
       ```

    IMPORTANT: The provider hierarchy must be ClerkProvider > ConvexProviderWithClerk. Reversing this breaks auth.

    AVOID: Do not add any Convex queries/mutations yet. This task is provider setup only.
  </action>
  <verify>
    - `npm run dev` starts without errors
    - No hydration errors in browser console
    - React DevTools shows ClerkProvider > ConvexProviderWithClerk hierarchy
  </verify>
  <done>
    Provider hierarchy configured, auth.config.ts created, app loads with both Clerk and Convex active
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Convex schema and user functions</name>
  <files>
    convex/schema.ts
    convex/users.ts
  </files>
  <action>
    1. Create `convex/schema.ts` with users table:
       ```typescript
       import { defineSchema, defineTable } from "convex/server";
       import { v } from "convex/values";

       export default defineSchema({
         users: defineTable({
           tokenIdentifier: v.string(),
           email: v.string(),
           name: v.optional(v.string()),
           imageUrl: v.optional(v.string()),
           createdAt: v.number(),
         }).index("by_token", ["tokenIdentifier"]),
       });
       ```

    2. Create `convex/users.ts` with getCurrentUser query and storeUser mutation:
       ```typescript
       import { mutation, query } from "./_generated/server";
       import { ConvexError } from "convex/values";

       export const getCurrentUser = query({
         handler: async (ctx) => {
           const identity = await ctx.auth.getUserIdentity();
           if (!identity) {
             return null;
           }

           const user = await ctx.db
             .query("users")
             .withIndex("by_token", (q) =>
               q.eq("tokenIdentifier", identity.tokenIdentifier)
             )
             .unique();

           return user;
         },
       });

       export const storeUser = mutation({
         handler: async (ctx) => {
           const identity = await ctx.auth.getUserIdentity();
           if (!identity) {
             throw new ConvexError("Unauthenticated");
           }

           // Check if user already exists
           const existingUser = await ctx.db
             .query("users")
             .withIndex("by_token", (q) =>
               q.eq("tokenIdentifier", identity.tokenIdentifier)
             )
             .unique();

           if (existingUser) {
             // Update existing user with latest info
             await ctx.db.patch(existingUser._id, {
               name: identity.name ?? existingUser.name,
               email: identity.email ?? existingUser.email,
               imageUrl: identity.pictureUrl ?? existingUser.imageUrl,
             });
             return existingUser._id;
           }

           // Create new user
           const userId = await ctx.db.insert("users", {
             tokenIdentifier: identity.tokenIdentifier,
             email: identity.email ?? "",
             name: identity.name,
             imageUrl: identity.pictureUrl,
             createdAt: Date.now(),
           });

           return userId;
         },
       });
       ```

    3. Run `npx convex dev` to deploy schema and generate types (this will start the Convex dev server)

    AVOID: Do not add complex user management features. This is minimum viable user storage.
  </action>
  <verify>
    - `npx convex dev` runs without schema errors
    - TypeScript shows no errors in users.ts
    - Generated types exist in convex/_generated/api.ts
  </verify>
  <done>
    Convex schema deployed, user query and mutation available, types generated
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` runs without errors
2. `npx convex dev` runs without errors (in separate terminal)
3. Browser loads http://localhost:3000 without console errors
4. Project structure matches RESEARCH.md recommended layout
5. All environment variables have placeholders
</verification>

<success_criteria>
- Next.js 15+ app running with App Router
- Clerk and Convex packages installed
- Provider hierarchy: ClerkProvider > ConvexProviderWithClerk
- convex/auth.config.ts configured for Clerk JWT
- convex/schema.ts defines users table
- convex/users.ts has getCurrentUser and storeUser functions
- Environment variable structure documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
