---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - middleware.ts
  - src/components/auth/auth-buttons.tsx
  - src/components/auth/user-menu.tsx
  - src/app/page.tsx
  - src/app/create/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can create new account using Clerk signup flow"
    - "User can log in with email and password"
    - "User can log in with Google or GitHub OAuth"
    - "User remains logged in after closing and reopening browser"
    - "User can log out from any page"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection for authenticated pages"
      contains: "clerkMiddleware"
    - path: "src/components/auth/auth-buttons.tsx"
      provides: "Sign in/up modal triggers"
      contains: "SignInButton"
    - path: "src/components/auth/user-menu.tsx"
      provides: "User dropdown with logout"
      contains: "UserButton"
    - path: "src/app/create/page.tsx"
      provides: "Protected creation page"
      contains: "Authenticated"
  key_links:
    - from: "middleware.ts"
      to: "/create route"
      via: "createRouteMatcher"
      pattern: "isProtectedRoute.*create"
    - from: "src/app/page.tsx"
      to: "src/components/auth/auth-buttons.tsx"
      via: "import and render"
      pattern: "AuthButtons"
    - from: "src/app/create/page.tsx"
      to: "convex/users.ts"
      via: "storeUser mutation"
      pattern: "api\\.users\\.storeUser"
---

<objective>
Implement complete auth UI with middleware protection and verify the full auth flow works.

Purpose: This plan delivers all visible auth functionality - the signup/login modals, user menu with logout, and protected routes. After this, users can actually authenticate.
Output: Working auth flow from signup through logout, with protected /create route.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Clerk middleware for route protection</name>
  <files>
    middleware.ts
  </files>
  <action>
    Create `middleware.ts` in the project root (NOT in src/):

    ```typescript
    import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

    // Routes that require authentication
    const isProtectedRoute = createRouteMatcher([
      "/create(.*)",
      "/dashboard(.*)",
      "/api/protected(.*)",
    ]);

    export default clerkMiddleware(async (auth, req) => {
      if (isProtectedRoute(req)) {
        await auth.protect();
      }
    });

    export const config = {
      matcher: [
        // Skip Next.js internals and all static files
        "/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)",
        // Always run for API routes
        "/(api|trpc)(.*)",
      ],
    };
    ```

    IMPORTANT:
    - File must be in project root, not src/ folder
    - Use `clerkMiddleware` (not deprecated `authMiddleware`)
    - `auth.protect()` redirects unauthenticated users to sign-in

    AVOID: Do not add complex route patterns yet. Keep it simple: /create is protected, everything else is public.
  </action>
  <verify>
    - Middleware file exists at project root
    - `npm run dev` starts without middleware errors
    - Visiting /create redirects to Clerk sign-in (once Clerk keys are configured)
  </verify>
  <done>
    Middleware configured, /create route protected, other routes remain public
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth UI components</name>
  <files>
    src/components/auth/auth-buttons.tsx
    src/components/auth/user-menu.tsx
  </files>
  <action>
    1. Create `src/components/auth/auth-buttons.tsx`:
       ```typescript
       "use client";

       import { SignInButton, SignUpButton, SignedIn, SignedOut } from "@clerk/nextjs";

       export function AuthButtons() {
         return (
           <div className="flex items-center gap-3">
             <SignedOut>
               <SignInButton mode="modal">
                 <button className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">
                   Sign In
                 </button>
               </SignInButton>
               <SignUpButton mode="modal">
                 <button className="px-4 py-2 text-sm font-medium text-indigo-600 border border-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors">
                   Sign Up
                 </button>
               </SignUpButton>
             </SignedOut>
             <SignedIn>
               {/* UserMenu will be shown here via separate component */}
             </SignedIn>
           </div>
         );
       }
       ```

    2. Create `src/components/auth/user-menu.tsx`:
       ```typescript
       "use client";

       import { UserButton } from "@clerk/nextjs";

       export function UserMenu() {
         return (
           <UserButton
             afterSignOutUrl="/"
             appearance={{
               elements: {
                 avatarBox: "w-10 h-10",
               },
             }}
           />
         );
       }
       ```

    Per CONTEXT.md decisions:
    - OAuth buttons shown first (Clerk handles this automatically in modal)
    - Modal overlay, not dedicated pages
    - Logout via UserButton dropdown (click avatar)

    AVOID: Do not add custom styling beyond basic Tailwind. Clerk's modal handles most UX.
  </action>
  <verify>
    - TypeScript shows no errors
    - Components import correctly from @clerk/nextjs
  </verify>
  <done>
    Auth button and user menu components created with modal mode
  </done>
</task>

<task type="auto">
  <name>Task 3: Build landing page and protected create page</name>
  <files>
    src/app/page.tsx
    src/app/create/page.tsx
  </files>
  <action>
    1. Update `src/app/page.tsx` (landing page):
       ```typescript
       import { SignedIn, SignedOut } from "@clerk/nextjs";
       import { AuthButtons } from "@/components/auth/auth-buttons";
       import { UserMenu } from "@/components/auth/user-menu";
       import Link from "next/link";

       export default function HomePage() {
         return (
           <main className="min-h-screen flex flex-col">
             {/* Header */}
             <header className="flex items-center justify-between px-6 py-4 border-b">
               <h1 className="text-xl font-bold">RemotionLab</h1>
               <nav className="flex items-center gap-4">
                 <SignedIn>
                   <Link
                     href="/create"
                     className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
                   >
                     Create Animation
                   </Link>
                   <UserMenu />
                 </SignedIn>
                 <SignedOut>
                   <AuthButtons />
                 </SignedOut>
               </nav>
             </header>

             {/* Hero */}
             <div className="flex-1 flex flex-col items-center justify-center px-6 text-center">
               <h2 className="text-4xl font-bold mb-4">
                 Create Stunning Animations with AI
               </h2>
               <p className="text-lg text-gray-600 mb-8 max-w-2xl">
                 Describe what you want, and watch it come to life. No coding or motion design skills required.
               </p>
               <SignedOut>
                 <AuthButtons />
               </SignedOut>
               <SignedIn>
                 <Link
                   href="/create"
                   className="px-6 py-3 text-lg font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
                 >
                   Start Creating
                 </Link>
               </SignedIn>
             </div>
           </main>
         );
       }
       ```

    2. Create `src/app/create/page.tsx` (protected page):
       ```typescript
       "use client";

       import { useConvexAuth, useMutation } from "convex/react";
       import { Authenticated, Unauthenticated, AuthLoading } from "convex/react";
       import { api } from "@/convex/_generated/api";
       import { useEffect } from "react";
       import { UserMenu } from "@/components/auth/user-menu";
       import Link from "next/link";

       function CreateContent() {
         const storeUser = useMutation(api.users.storeUser);

         // Store user in Convex on first visit (handles both new signups and existing users)
         useEffect(() => {
           storeUser().catch(console.error);
         }, [storeUser]);

         return (
           <div className="p-6">
             <p className="text-lg text-gray-600 mb-4">
               You&apos;re signed in! This is where the prompt input will go in Phase 2.
             </p>
             <div className="p-4 bg-gray-100 rounded-lg">
               <p className="text-sm text-gray-500">
                 Placeholder for animation generation interface
               </p>
             </div>
           </div>
         );
       }

       export default function CreatePage() {
         return (
           <main className="min-h-screen flex flex-col">
             {/* Header */}
             <header className="flex items-center justify-between px-6 py-4 border-b">
               <Link href="/" className="text-xl font-bold">
                 RemotionLab
               </Link>
               <UserMenu />
             </header>

             {/* Content */}
             <div className="flex-1">
               <AuthLoading>
                 <div className="flex items-center justify-center h-64">
                   <p className="text-gray-500">Loading...</p>
                 </div>
               </AuthLoading>

               <Unauthenticated>
                 <div className="flex items-center justify-center h-64">
                   <p className="text-gray-500">Redirecting to sign in...</p>
                 </div>
               </Unauthenticated>

               <Authenticated>
                 <CreateContent />
               </Authenticated>
             </div>
           </main>
         );
       }
       ```

    Per CONTEXT.md:
    - After login, user goes to /create (the creation page)
    - Unauthenticated users can browse landing page, must auth to create
    - storeUser mutation called on first protected page visit (stores user in Convex)

    AVOID: Do not build the actual prompt input yet. This is a placeholder for Phase 2.
  </action>
  <verify>
    - `npm run dev` runs without errors
    - Landing page shows auth buttons when signed out
    - Landing page shows "Create Animation" link + UserMenu when signed in
    - /create page shows placeholder content when authenticated
  </verify>
  <done>
    Landing page with auth buttons, protected /create page with user storage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify complete auth flow</name>
  <what-built>
    Complete Clerk authentication flow with:
    - Sign up via email/password
    - Sign up via Google OAuth
    - Sign up via GitHub OAuth
    - Sign in via email/password
    - Sign in via OAuth
    - Session persistence (30 days)
    - Logout via user menu
    - Protected /create route
    - User storage in Convex
  </what-built>
  <how-to-verify>
    Prerequisites: Ensure Clerk and Convex env vars are configured with real values.

    1. **Test Sign Up (email/password):**
       - Visit http://localhost:3000
       - Click "Sign Up" button
       - Modal should appear with OAuth buttons (Google, GitHub) at top
       - Enter email and password, complete signup
       - Should redirect to /create page
       - User menu (avatar) should appear in header

    2. **Test Logout:**
       - Click user avatar in header
       - Click "Sign out" in dropdown
       - Should redirect to landing page
       - Auth buttons should reappear

    3. **Test Sign In (email/password):**
       - Click "Sign In" button
       - Enter credentials from step 1
       - Should redirect to /create page

    4. **Test Session Persistence:**
       - Close browser completely
       - Reopen and visit http://localhost:3000
       - Should still be signed in (user menu visible)

    5. **Test OAuth (Google):**
       - Log out first
       - Click "Sign Up" or "Sign In"
       - Click Google button in modal
       - Complete OAuth flow
       - Should redirect to /create page

    6. **Test OAuth (GitHub):**
       - Log out first
       - Click "Sign Up" or "Sign In"
       - Click GitHub button in modal
       - Complete OAuth flow
       - Should redirect to /create page

    7. **Test Route Protection:**
       - Log out
       - Try to visit http://localhost:3000/create directly
       - Should redirect to sign-in modal/page

    8. **Verify Convex User Storage:**
       - Visit Convex Dashboard -> Data
       - Check "users" table has entries for created accounts
  </how-to-verify>
  <resume-signal>
    Type "approved" if all flows work correctly.
    If issues found, describe what failed and expected vs actual behavior.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and checkpoint passes:
1. New users can sign up via email/password or OAuth
2. Existing users can sign in via email/password or OAuth
3. Sessions persist for 30 days (survives browser restart)
4. Logout works from any page via user menu
5. /create route is protected (redirects unauthenticated users)
6. Users are stored in Convex database on first protected page visit
</verification>

<success_criteria>
- AUTH-01: User can sign up with Clerk (email + OAuth)
- AUTH-02: User can log in via email/password
- AUTH-03: User can log in via OAuth (Google/GitHub)
- AUTH-04: User session persists across browser refresh
- Additional: User can log out from any page (success criterion #5)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
