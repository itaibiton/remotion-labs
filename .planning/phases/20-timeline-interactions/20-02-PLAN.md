---
phase: 20-timeline-interactions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-timeline-zoom.ts
  - src/components/movie/timeline-zoom-controls.tsx
  - src/components/movie/timeline.tsx
  - src/components/movie/timeline-ruler.tsx
autonomous: true

must_haves:
  truths:
    - "User can zoom in on the timeline via Ctrl+scroll wheel up"
    - "User can zoom out on the timeline via Ctrl+scroll wheel down"
    - "User can zoom in via + button"
    - "User can zoom out via - button"
    - "Zooming changes the visible detail level of the timeline"
    - "Ruler marks stay aligned with clip edges at all zoom levels"
  artifacts:
    - path: "src/hooks/use-timeline-zoom.ts"
      provides: "useTimelineZoom hook with scale state and handlers"
      exports: ["useTimelineZoom"]
      min_lines: 30
    - path: "src/components/movie/timeline-zoom-controls.tsx"
      provides: "Zoom button controls component"
      exports: ["TimelineZoomControls"]
      min_lines: 25
    - path: "src/components/movie/timeline.tsx"
      provides: "Zoom integration with wheel handler"
      contains: "useTimelineZoom"
    - path: "src/components/movie/timeline-ruler.tsx"
      provides: "Scale-aware ruler rendering"
      contains: "scale"
  key_links:
    - from: "src/components/movie/timeline.tsx"
      to: "src/hooks/use-timeline-zoom.ts"
      via: "useTimelineZoom hook import"
      pattern: "import.*useTimelineZoom"
    - from: "src/components/movie/timeline.tsx"
      to: "src/components/movie/timeline-zoom-controls.tsx"
      via: "TimelineZoomControls component"
      pattern: "TimelineZoomControls"
---

<objective>
Implement timeline zoom controls with scroll wheel and button interactions

Purpose: Allow users to zoom in/out on the timeline to see more or less detail when editing. This is essential for working with both long movies (need zoom out to see all) and precise edits (need zoom in for frame-accurate trim).

Output:
- useTimelineZoom hook managing scale state, zoomIn/zoomOut functions, wheel handler
- TimelineZoomControls component with +/- buttons and scale indicator
- Timeline component wired with zoom state controlling width calculation
- TimelineRuler updated to respect zoom scale for consistent alignment
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/20-timeline-interactions/20-RESEARCH.md
@.planning/phases/19-timeline-foundation/19-01-SUMMARY.md

Source files:
@src/components/movie/timeline.tsx
@src/components/movie/timeline-ruler.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTimelineZoom hook</name>
  <files>src/hooks/use-timeline-zoom.ts</files>
  <action>
Create src/hooks/use-timeline-zoom.ts:
- Manage scale state (pixels per frame)
- Default scale: calculate based on container width and total duration to fit timeline initially
- Min scale: 0.5 px/frame (zoomed out, for very long movies)
- Max scale: 20 px/frame (zoomed in, for frame-accurate editing)
- Provide zoomIn/zoomOut functions that multiply/divide by 1.25
- Provide wheel handler that:
  - Only zooms when Ctrl (Windows/Linux) or Meta (Mac) key is pressed
  - Calls e.preventDefault() to prevent browser zoom
  - Multiplies scale by 1.1 (scroll up) or 0.9 (scroll down)
- Provide resetZoom to return to default

Implementation:
```typescript
"use client";

import { useState, useCallback } from "react";

interface UseTimelineZoomOptions {
  minScale?: number;
  maxScale?: number;
  defaultScale?: number;
}

interface UseTimelineZoomReturn {
  scale: number;
  zoomIn: () => void;
  zoomOut: () => void;
  resetZoom: () => void;
  setScale: (scale: number) => void;
  handleWheel: (e: WheelEvent) => void;
  minScale: number;
  maxScale: number;
}

export function useTimelineZoom(options: UseTimelineZoomOptions = {}): UseTimelineZoomReturn {
  const { minScale = 0.5, maxScale = 20, defaultScale = 3 } = options;
  const [scale, setScaleState] = useState(defaultScale);

  const clampScale = useCallback((s: number) => {
    return Math.min(maxScale, Math.max(minScale, s));
  }, [minScale, maxScale]);

  const setScale = useCallback((newScale: number) => {
    setScaleState(clampScale(newScale));
  }, [clampScale]);

  const zoomIn = useCallback(() => {
    setScaleState((s) => clampScale(s * 1.25));
  }, [clampScale]);

  const zoomOut = useCallback(() => {
    setScaleState((s) => clampScale(s / 1.25));
  }, [clampScale]);

  const resetZoom = useCallback(() => {
    setScaleState(defaultScale);
  }, [defaultScale]);

  const handleWheel = useCallback((e: WheelEvent) => {
    // Only zoom with Ctrl (Windows/Linux) or Meta (Mac) modifier
    if (!e.ctrlKey && !e.metaKey) return;
    e.preventDefault();
    const factor = e.deltaY > 0 ? 0.9 : 1.1;
    setScaleState((s) => clampScale(s * factor));
  }, [clampScale]);

  return {
    scale,
    zoomIn,
    zoomOut,
    resetZoom,
    setScale,
    handleWheel,
    minScale,
    maxScale,
  };
}
```
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit src/hooks/use-timeline-zoom.ts</verify>
  <done>useTimelineZoom hook exists with scale state, zoom functions, and wheel handler</done>
</task>

<task type="auto">
  <name>Task 2: Create TimelineZoomControls component</name>
  <files>src/components/movie/timeline-zoom-controls.tsx</files>
  <action>
Create src/components/movie/timeline-zoom-controls.tsx:
- Import ZoomIn, ZoomOut from lucide-react
- Import Button from @/components/ui/button
- Props: onZoomIn, onZoomOut, scale, minScale, maxScale
- Display +/- buttons with scale percentage between them
- Disable + button when scale >= maxScale
- Disable - button when scale <= minScale
- Add tooltips explaining keyboard shortcuts

Implementation:
```typescript
"use client";

import { ZoomIn, ZoomOut } from "lucide-react";
import { Button } from "@/components/ui/button";

interface TimelineZoomControlsProps {
  onZoomIn: () => void;
  onZoomOut: () => void;
  scale: number;
  minScale: number;
  maxScale: number;
}

export function TimelineZoomControls({
  onZoomIn,
  onZoomOut,
  scale,
  minScale,
  maxScale,
}: TimelineZoomControlsProps) {
  // Display scale as percentage relative to default (3 px/frame = 100%)
  const displayPercent = Math.round((scale / 3) * 100);

  return (
    <div className="flex items-center gap-1">
      <Button
        variant="ghost"
        size="icon"
        className="h-7 w-7"
        onClick={onZoomOut}
        disabled={scale <= minScale}
        title="Zoom out (Ctrl + scroll down)"
      >
        <ZoomOut className="h-4 w-4" />
      </Button>
      <span className="text-xs text-muted-foreground min-w-[3rem] text-center tabular-nums">
        {displayPercent}%
      </span>
      <Button
        variant="ghost"
        size="icon"
        className="h-7 w-7"
        onClick={onZoomIn}
        disabled={scale >= maxScale}
        title="Zoom in (Ctrl + scroll up)"
      >
        <ZoomIn className="h-4 w-4" />
      </Button>
    </div>
  );
}
```
  </action>
  <verify>npm run build compiles without errors</verify>
  <done>TimelineZoomControls component exists with +/- buttons and scale display</done>
</task>

<task type="auto">
  <name>Task 3: Wire zoom into Timeline and update ruler</name>
  <files>src/components/movie/timeline.tsx, src/components/movie/timeline-ruler.tsx</files>
  <action>
Update src/components/movie/timeline.tsx:
- Import useTimelineZoom hook
- Import TimelineZoomControls component
- Call useTimelineZoom() to get scale, zoomIn, zoomOut, handleWheel, etc.
- Calculate timeline width based on scale: `totalDurationInFrames * scale`
- Add wheel event listener to timeline container using useEffect with { passive: false }
- Add TimelineZoomControls to the timeline header (above the ruler)
- Update the timeline container to have a fixed outer wrapper and scrollable inner:
  ```tsx
  {/* Outer container - fixed viewport */}
  <div className="relative">
    {/* Zoom controls in header */}
    <div className="flex items-center justify-between px-4 py-2 border-b">
      <span className="text-sm text-muted-foreground">Timeline</span>
      <TimelineZoomControls
        onZoomIn={zoomIn}
        onZoomOut={zoomOut}
        scale={scale}
        minScale={minScale}
        maxScale={maxScale}
      />
    </div>

    {/* Scrollable timeline area */}
    <div
      ref={timelineContainerRef}
      className="relative overflow-x-auto cursor-pointer"
      onClick={handleTimelineClick}
    >
      <div style={{ width: `${timelineWidth}px`, minWidth: '100%' }}>
        {/* Playhead, Ruler, Clips */}
      </div>
    </div>
  </div>
  ```
- Pass scale to TimelineRuler
- Pass scale to TimelineScene components (they need it for trim handle calculations)
- Update width calculations to use scale instead of percentages:
  - Remove sceneWidths useMemo with percentages
  - Calculate scene width as: `(sceneDuration * scale)px`
  - Keep minWidth: 80px for very short clips

Update src/components/movie/timeline-ruler.tsx:
- Add scale prop to TimelineRulerProps
- Update width calculation: ruler width = totalDurationInFrames * scale
- Update tick positioning to use scale instead of percentages
- Tick at frame F is positioned at: `F * scale` pixels from left

Update click-to-seek handler in Timeline:
- Convert click position to frame using scale: `frame = Math.round(clickX / scale)`
- Clamp to valid range [0, totalDurationInFrames - 1]
  </action>
  <verify>
1. npm run build compiles without errors
2. Dev server: Ctrl+scroll wheel zooms the timeline
3. Dev server: +/- buttons zoom in/out
4. Dev server: Ruler marks stay aligned with clip edges at all zoom levels
5. Dev server: Timeline scrolls horizontally when zoomed in beyond viewport
  </verify>
  <done>Timeline has zoom controls; scale affects timeline width; ruler and clips stay aligned</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` compiles successfully
2. Timeline shows zoom controls (+/- buttons with percentage)
3. Ctrl+scroll wheel zooms in/out
4. +/- buttons zoom in/out
5. Zooming changes timeline width (more detail when zoomed in)
6. Ruler tick marks stay perfectly aligned with clip edges at all zoom levels
7. Click-to-seek still works at all zoom levels
8. Playhead still syncs correctly at all zoom levels
</verification>

<success_criteria>
- useTimelineZoom hook provides scale state with zoom functions
- TimelineZoomControls shows +/- buttons with current scale percentage
- Ctrl+scroll wheel triggers zoom (with preventDefault to avoid browser zoom)
- Timeline width is calculated as totalDurationInFrames * scale
- Ruler and clips use consistent scale-based positioning
- Horizontal scroll appears when timeline is wider than viewport
</success_criteria>

<output>
After completion, create `.planning/phases/20-timeline-interactions/20-02-SUMMARY.md`
</output>
