---
phase: 22-per-clip-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/clips.ts
  - convex/movies.ts
  - src/components/movie/timeline-scene-actions.tsx
  - src/components/movie/timeline-scene.tsx
  - src/components/movie/timeline.tsx
autonomous: true

must_haves:
  truths:
    - "clips.update mutation can patch code/rawCode/name/duration/fps on existing clip"
    - "movies.insertScene mutation can insert a scene after or before a specific index"
    - "TimelineScene shows a dropdown menu with 4 action items on hover"
    - "Dropdown trigger click does not start drag operation"
  artifacts:
    - path: "convex/clips.ts"
      provides: "clips.update mutation"
      exports: ["update"]
    - path: "convex/movies.ts"
      provides: "movies.insertScene mutation"
      exports: ["insertScene"]
    - path: "src/components/movie/timeline-scene-actions.tsx"
      provides: "TimelineSceneActions dropdown component"
      exports: ["TimelineSceneActions"]
  key_links:
    - from: "src/components/movie/timeline-scene.tsx"
      to: "src/components/movie/timeline-scene-actions.tsx"
      via: "imports and renders TimelineSceneActions"
      pattern: "import.*TimelineSceneActions"
    - from: "src/components/movie/timeline-scene-actions.tsx"
      to: "@/components/ui/dropdown-menu"
      via: "uses DropdownMenu components"
      pattern: "DropdownMenu"
---

<objective>
Add backend mutations for clip updates and scene insertion, and create the TimelineSceneActions dropdown component that appears on timeline clips.

Purpose: Establish the data layer and UI component for per-clip actions, enabling the movie editor to support generation and editing workflows directly from timeline clips.

Output:
- `clips.update` mutation for updating existing clip code
- `movies.insertScene` mutation for inserting scenes at specific positions
- `TimelineSceneActions` component with Generate Next, Generate Previous, Re-generate, and Edit actions
- TimelineScene updated to show actions dropdown on hover
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase-specific research
@.planning/phases/22-per-clip-actions/22-RESEARCH.md

# Existing files to extend
@convex/clips.ts
@convex/movies.ts
@src/components/movie/timeline-scene.tsx
@src/components/movie/timeline.tsx
@src/components/generation/generation-row-actions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clips.update mutation</name>
  <files>convex/clips.ts</files>
  <action>
Add a new `update` mutation to convex/clips.ts that patches an existing clip's fields.

Implementation:
```typescript
/**
 * Update an existing clip's code and metadata.
 * Used for regenerate and edit save operations.
 */
export const update = mutation({
  args: {
    id: v.id("clips"),
    code: v.optional(v.string()),
    rawCode: v.optional(v.string()),
    name: v.optional(v.string()),
    durationInFrames: v.optional(v.number()),
    fps: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Not authenticated");

    const clip = await ctx.db.get(args.id);
    if (!clip || clip.userId !== identity.tokenIdentifier) {
      throw new Error("Clip not found");
    }

    const updates: Record<string, unknown> = { updatedAt: Date.now() };
    if (args.code !== undefined) updates.code = args.code;
    if (args.rawCode !== undefined) updates.rawCode = args.rawCode;
    if (args.name !== undefined) updates.name = args.name;
    if (args.durationInFrames !== undefined) updates.durationInFrames = args.durationInFrames;
    if (args.fps !== undefined) updates.fps = args.fps;

    await ctx.db.patch(args.id, updates);
  },
});
```

Key points:
- Validates authentication and ownership before patching
- Only patches fields that are provided (undefined fields are skipped)
- Updates `updatedAt` timestamp on every patch
  </action>
  <verify>Run `npx convex dev` and check no type errors. The mutation should appear in convex/_generated/api.d.ts.</verify>
  <done>clips.update mutation exists and accepts id + optional code/rawCode/name/duration/fps args.</done>
</task>

<task type="auto">
  <name>Task 2: Add movies.insertScene mutation</name>
  <files>convex/movies.ts</files>
  <action>
Add a new `insertScene` mutation to convex/movies.ts that inserts a scene at a specific position.

Implementation (add after the `addScene` mutation):
```typescript
/**
 * Insert a scene at a specific position in the movie.
 * Use afterIndex to insert after a scene, or beforeIndex to insert before.
 */
export const insertScene = mutation({
  args: {
    movieId: v.id("movies"),
    clipId: v.id("clips"),
    afterIndex: v.optional(v.number()),  // Insert after this index
    beforeIndex: v.optional(v.number()), // Insert before this index
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Not authenticated");

    const movie = await ctx.db.get(args.movieId);
    if (!movie || movie.userId !== identity.tokenIdentifier) {
      throw new Error("Movie not found");
    }

    const clip = await ctx.db.get(args.clipId);
    if (!clip) throw new Error("Clip not found");

    // Determine insertion index
    let insertAt: number;
    if (args.afterIndex !== undefined) {
      insertAt = args.afterIndex + 1;
    } else if (args.beforeIndex !== undefined) {
      insertAt = args.beforeIndex;
    } else {
      insertAt = movie.scenes.length; // Append by default
    }

    // Clamp to valid range
    insertAt = Math.max(0, Math.min(insertAt, movie.scenes.length));

    // Normalize duration if FPS differs
    const durationOverride =
      clip.fps !== movie.fps
        ? Math.round(clip.durationInFrames * (movie.fps / clip.fps))
        : undefined;

    const newScene = {
      clipId: args.clipId,
      ...(durationOverride !== undefined && { durationOverride }),
    };

    const newScenes = [
      ...movie.scenes.slice(0, insertAt),
      newScene,
      ...movie.scenes.slice(insertAt),
    ];

    const totalDuration = await computeTotalDuration(ctx, newScenes);

    await ctx.db.patch(args.movieId, {
      scenes: newScenes,
      totalDurationInFrames: totalDuration,
      updatedAt: Date.now(),
    });

    return { insertedAt: insertAt };
  },
});
```

Key points:
- Uses existing `computeTotalDuration` helper (already in the file)
- Handles FPS normalization like `addScene` does
- Returns the insertion index for caller feedback
  </action>
  <verify>Run `npx convex dev` and check no type errors. The mutation should appear in convex/_generated/api.d.ts.</verify>
  <done>movies.insertScene mutation exists and can insert at afterIndex or beforeIndex position.</done>
</task>

<task type="auto">
  <name>Task 3: Create TimelineSceneActions dropdown component</name>
  <files>src/components/movie/timeline-scene-actions.tsx</files>
  <action>
Create a new file `src/components/movie/timeline-scene-actions.tsx` with a dropdown menu component for per-clip actions.

Follow the pattern from `GenerationRowActions` but adapted for timeline context:

```typescript
"use client";

import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { MoreHorizontal, FastForward, Rewind, RotateCcw, Pencil } from "lucide-react";

interface TimelineSceneActionsProps {
  sceneIndex: number;
  onGenerateNext: (sceneIndex: number) => void;
  onGeneratePrevious: (sceneIndex: number) => void;
  onRegenerate: (sceneIndex: number) => void;
  onEdit: (sceneIndex: number) => void;
  disabled?: boolean;
}

export function TimelineSceneActions({
  sceneIndex,
  onGenerateNext,
  onGeneratePrevious,
  onRegenerate,
  onEdit,
  disabled,
}: TimelineSceneActionsProps) {
  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="h-6 w-6 bg-background/80 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-background"
          disabled={disabled}
          onClick={(e) => e.stopPropagation()}
          onPointerDown={(e) => e.stopPropagation()}
        >
          <MoreHorizontal className="h-4 w-4" />
          <span className="sr-only">Scene actions</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="start">
        <DropdownMenuItem onSelect={() => onGenerateNext(sceneIndex)}>
          <FastForward className="h-4 w-4" />
          Generate Next
        </DropdownMenuItem>
        <DropdownMenuItem onSelect={() => onGeneratePrevious(sceneIndex)}>
          <Rewind className="h-4 w-4" />
          Generate Previous
        </DropdownMenuItem>
        <DropdownMenuItem onSelect={() => onRegenerate(sceneIndex)}>
          <RotateCcw className="h-4 w-4" />
          Re-generate
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        <DropdownMenuItem onSelect={() => onEdit(sceneIndex)}>
          <Pencil className="h-4 w-4" />
          Edit
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

Key points:
- `e.stopPropagation()` on both onClick and onPointerDown to prevent drag initiation
- Uses `group-hover:opacity-100` to show on parent hover (TimelineScene has `group` class)
- Background/80 for subtle visibility against clip thumbnails
- Icons match the semantic action (FastForward = next, Rewind = previous)
  </action>
  <verify>Run `npm run lint` to check for TypeScript/ESLint errors. Import should resolve correctly.</verify>
  <done>TimelineSceneActions component renders dropdown with 4 menu items and prevents drag interference.</done>
</task>

<task type="auto">
  <name>Task 4: Wire TimelineSceneActions into TimelineScene</name>
  <files>src/components/movie/timeline-scene.tsx, src/components/movie/timeline.tsx</files>
  <action>
Update TimelineScene to accept and render the TimelineSceneActions dropdown.

1. **Update TimelineSceneProps interface** in timeline-scene.tsx:
Add new callback props:
```typescript
interface TimelineSceneProps {
  // ... existing props ...
  onGenerateNext?: (sceneIndex: number) => void;
  onGeneratePrevious?: (sceneIndex: number) => void;
  onRegenerate?: (sceneIndex: number) => void;
  onEdit?: (sceneIndex: number) => void;
  isGenerating?: boolean;
}
```

2. **Import and render TimelineSceneActions** in timeline-scene.tsx:
Add import at top:
```typescript
import { TimelineSceneActions } from "./timeline-scene-actions";
```

In the content layer (inside the `<div className="pointer-events-none absolute inset-0">` div), add the actions dropdown near the existing remove button. Replace the existing "Generate next scene button" with the actions dropdown:

```typescript
{/* Actions dropdown - replaces individual generate button */}
{clip && onGenerateNext && onGeneratePrevious && onRegenerate && onEdit && (
  <div className="pointer-events-auto absolute top-1 left-1 z-30">
    <TimelineSceneActions
      sceneIndex={index}
      onGenerateNext={onGenerateNext}
      onGeneratePrevious={onGeneratePrevious}
      onRegenerate={onRegenerate}
      onEdit={onEdit}
      disabled={isGenerating}
    />
  </div>
)}
```

Remove the existing standalone "Generate next scene button" that navigates to /create page (the one with FastForward icon at bottom-right).

3. **Update Timeline component** (timeline.tsx) to pass action handlers:
Add new props to Timeline interface and pass them through to TimelineScene:

```typescript
// In Timeline props interface, add:
onGenerateNext?: (sceneIndex: number) => void;
onGeneratePrevious?: (sceneIndex: number) => void;
onRegenerate?: (sceneIndex: number) => void;
onEdit?: (sceneIndex: number) => void;
isGenerating?: boolean;
```

Pass these to each TimelineScene:
```typescript
<TimelineScene
  // ... existing props ...
  onGenerateNext={onGenerateNext}
  onGeneratePrevious={onGeneratePrevious}
  onRegenerate={onRegenerate}
  onEdit={onEdit}
  isGenerating={isGenerating}
/>
```

Note: The actual handler implementations will be added in Plan 22-02 from MovieEditor.
  </action>
  <verify>Run `npm run lint` and `npm run build` to check for type errors. The app should still compile (handlers are optional).</verify>
  <done>TimelineScene shows actions dropdown on hover. Clicking dropdown does not trigger drag. Props pass through from Timeline.</done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. `npm run lint` passes
3. `npm run build` succeeds
4. Timeline clips show three-dot menu button on hover (top-left corner)
5. Clicking the menu button opens dropdown without dragging the clip
6. Dropdown shows 4 items: Generate Next, Generate Previous, Re-generate, Edit (actions are no-ops until Plan 22-02)
</verification>

<success_criteria>
- clips.update mutation is exported and callable
- movies.insertScene mutation is exported and supports afterIndex/beforeIndex
- TimelineSceneActions component exists with correct dropdown structure
- TimelineScene renders the actions dropdown with proper event propagation handling
- Timeline passes action handler props through to TimelineScene
</success_criteria>

<output>
After completion, create `.planning/phases/22-per-clip-actions/22-01-SUMMARY.md`
</output>
