---
phase: 19-timeline-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/format-timecode.ts
  - src/components/movie/timeline-ruler.tsx
  - src/components/movie/timeline.tsx
  - src/components/movie/timeline-scene.tsx
autonomous: true

must_haves:
  truths:
    - "Each clip on the timeline has a width proportional to its duration relative to total movie length"
    - "A ruler above the clips displays timecodes spanning the full movie duration"
  artifacts:
    - path: "src/lib/format-timecode.ts"
      provides: "Timecode formatting utility"
      exports: ["formatTimecode"]
    - path: "src/components/movie/timeline-ruler.tsx"
      provides: "Timecode ruler with interval marks"
      exports: ["TimelineRuler"]
    - path: "src/components/movie/timeline.tsx"
      provides: "Timeline with proportional clip widths and ruler"
      contains: "widthPercent"
    - path: "src/components/movie/timeline-scene.tsx"
      provides: "Scene card with percentage-based width"
      contains: "widthPercent"
  key_links:
    - from: "src/components/movie/timeline.tsx"
      to: "src/components/movie/timeline-ruler.tsx"
      via: "import and render TimelineRuler"
      pattern: "TimelineRuler"
    - from: "src/components/movie/timeline-ruler.tsx"
      to: "src/lib/format-timecode.ts"
      via: "import formatTimecode"
      pattern: "formatTimecode"
---

<objective>
Add proportional-width timeline clips and a timecode ruler above the clip track.

Purpose: Transform the fixed-width timeline cards into a professional video editor layout where clip widths visually represent their relative durations, and a ruler displays timecodes for navigation context.

Output:
- `src/lib/format-timecode.ts` - Simple MM:SS or SS.f formatter
- `src/components/movie/timeline-ruler.tsx` - Ruler with interval marks
- Modified `timeline.tsx` - Calculates and passes width percentages
- Modified `timeline-scene.tsx` - Accepts widthPercent prop instead of fixed width
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-timeline-foundation/19-RESEARCH.md

Key existing files:
@src/components/movie/timeline.tsx
@src/components/movie/timeline-scene.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create timecode formatter and ruler component</name>
  <files>src/lib/format-timecode.ts, src/components/movie/timeline-ruler.tsx</files>
  <action>
Create `src/lib/format-timecode.ts`:
```typescript
/**
 * Format a frame number as MM:SS or SS.f depending on duration.
 * For short clips (< 60s), shows SS.f (e.g., "4.5").
 * For longer clips, shows MM:SS (e.g., "1:23").
 */
export function formatTimecode(frame: number, fps: number): string {
  const totalSeconds = frame / fps;
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;

  if (minutes > 0) {
    return `${minutes}:${seconds.toFixed(0).padStart(2, "0")}`;
  }
  return `${seconds.toFixed(1)}`;
}
```

Create `src/components/movie/timeline-ruler.tsx`:
- Props: `totalDurationInFrames: number`, `fps: number`
- Calculate marks at 1-second intervals (or 5-second if total > 30s)
- Each mark positioned at `(second / totalSeconds) * 100%` from left
- Render tick marks (vertical lines) and labels using formatTimecode
- Use relative positioning within a container that matches the clip track width
- Style: `h-6`, tick marks with `h-2 w-px bg-muted-foreground`, labels with `text-[10px] text-muted-foreground`
- Add cursor-pointer class to the container (click-to-seek will be wired in Plan 02)
  </action>
  <verify>
- `npm run build` succeeds
- Files exist at correct paths
- No TypeScript errors
  </verify>
  <done>
- formatTimecode correctly formats frames as MM:SS or SS.f
- TimelineRuler renders timecode marks at proportional positions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Timeline and TimelineScene for proportional widths</name>
  <files>src/components/movie/timeline.tsx, src/components/movie/timeline-scene.tsx</files>
  <action>
Modify `src/components/movie/timeline-scene.tsx`:
- Add `widthPercent: string` to props interface
- Remove the fixed `w-[160px]` class from the container div
- Apply `style={{ ...style, width: widthPercent, minWidth: "80px" }}` to maintain minimum visibility
- Keep `flex-shrink-0` class to prevent compression

Modify `src/components/movie/timeline.tsx`:
- Add props: `totalDurationInFrames: number`, `fps: number`
- Import and render `TimelineRuler` above the clip track (before the DndContext)
- Calculate width percentages for each scene in a useMemo:
  ```typescript
  const sceneWidths = useMemo(() => {
    return localScenes.map((scene) => {
      const duration = scene.clip?.durationInFrames ?? 0;
      if (totalDurationInFrames === 0) return "0%";
      const percent = (duration / totalDurationInFrames) * 100;
      return `${percent}%`;
    });
  }, [localScenes, totalDurationInFrames]);
  ```
- Pass `widthPercent={sceneWidths[index]}` to each TimelineScene
- Remove the gap-2 class from clip container (clips should be adjacent for proportional layout)
- Wrap ruler and clip track in a shared container div for alignment

Update `src/components/movie/movie-editor.tsx`:
- Pass `totalDurationInFrames={totalDurationInFrames}` and `fps={movie.fps}` to Timeline component
  </action>
  <verify>
- `npm run build` succeeds
- `npm run lint` passes
- Open movie page with scenes -- clips should display with widths proportional to their duration
  </verify>
  <done>
- Timeline clips have proportional widths based on duration
- Ruler displays above clips with matching alignment
- No visual gaps between clips (they form a continuous track)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. Movie page with 2+ scenes of different durations shows clips with different widths
4. Ruler marks align with clip positions (start of movie = 0:00, end = total duration)
</verification>

<success_criteria>
- Each clip width is `(clipDuration / totalDuration) * 100%`
- Ruler shows timecodes at regular intervals
- Clips are adjacent (no gaps) forming a continuous track
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-timeline-foundation/19-01-SUMMARY.md`
</output>
