---
phase: 19-timeline-foundation
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/components/movie/movie-editor.tsx
  - src/components/movie/movie-preview-player.tsx
  - src/components/movie/timeline.tsx
  - src/components/movie/timeline-playhead.tsx
autonomous: false

must_haves:
  truths:
    - "A playhead indicator on the ruler is draggable and scrubbing it updates the preview player position"
    - "Playing the preview player moves the playhead across the timeline in sync"
    - "Clicking a position on the ruler jumps the playhead and preview to that timecode"
  artifacts:
    - path: "src/components/movie/timeline-playhead.tsx"
      provides: "Draggable playhead with pointer events"
      exports: ["TimelinePlayhead"]
    - path: "src/components/movie/movie-editor.tsx"
      provides: "Lifted playerRef passed to both player and timeline"
      contains: "playerRef"
    - path: "src/components/movie/movie-preview-player.tsx"
      provides: "Accepts playerRef from parent"
      contains: "playerRef: React.RefObject"
    - path: "src/components/movie/timeline.tsx"
      provides: "Timeline with playhead and click-to-seek"
      contains: "TimelinePlayhead"
  key_links:
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/movie-preview-player.tsx"
      via: "playerRef prop"
      pattern: "playerRef={playerRef}"
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/timeline.tsx"
      via: "playerRef prop"
      pattern: "playerRef={playerRef}"
    - from: "src/components/movie/timeline-playhead.tsx"
      to: "@remotion/player"
      via: "seekTo and pause/play calls"
      pattern: "playerRef\\.current\\?.seekTo"
---

<objective>
Add a draggable playhead synced to the Remotion Player with click-to-seek on the ruler.

Purpose: Enable bidirectional synchronization between the preview player and timeline -- playhead moves during playback and can be dragged to seek. Clicking anywhere on the ruler jumps to that position.

Output:
- `src/components/movie/timeline-playhead.tsx` - Draggable playhead with pointer events
- Modified `movie-editor.tsx` - Lifts playerRef to parent
- Modified `movie-preview-player.tsx` - Accepts playerRef as prop
- Modified `timeline.tsx` - Integrates playhead and click-to-seek
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-timeline-foundation/19-RESEARCH.md
@.planning/phases/19-timeline-foundation/19-01-SUMMARY.md

Key existing files:
@src/components/movie/movie-editor.tsx
@src/components/movie/movie-preview-player.tsx
@src/components/movie/timeline.tsx
@src/hooks/use-current-player-frame.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lift playerRef to MovieEditor and update components</name>
  <files>src/components/movie/movie-editor.tsx, src/components/movie/movie-preview-player.tsx</files>
  <action>
Modify `src/components/movie/movie-preview-player.tsx`:
- Change props interface to accept `playerRef: React.RefObject<PlayerRef>` from parent
- Remove the internal `const playerRef = useRef<PlayerRef>(null);` line
- Keep the `useCurrentPlayerFrame(playerRef)` hook -- it will use the passed-in ref
- Pass the received `playerRef` to the Player's `ref` prop

Modify `src/components/movie/movie-editor.tsx`:
- Import `useRef` and `PlayerRef` from "@remotion/player"
- Create `const playerRef = useRef<PlayerRef>(null);` in the component
- Pass `playerRef={playerRef}` to MoviePreviewPlayer
- Pass `playerRef={playerRef}` to Timeline (will be wired in Task 2)
  </action>
  <verify>
- `npm run build` succeeds
- Movie page still plays video correctly
- Active scene highlighting still works
  </verify>
  <done>
- playerRef is created in MovieEditor and passed to both child components
- Preview player still functions correctly with the lifted ref
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TimelinePlayhead and wire click-to-seek</name>
  <files>src/components/movie/timeline-playhead.tsx, src/components/movie/timeline.tsx</files>
  <action>
Create `src/components/movie/timeline-playhead.tsx`:
```typescript
"use client";

import { useState, useCallback, useRef } from "react";
import type { PlayerRef } from "@remotion/player";

interface TimelinePlayheadProps {
  currentFrame: number;
  totalDurationInFrames: number;
  playerRef: React.RefObject<PlayerRef>;
  containerRef: React.RefObject<HTMLDivElement>;
}

export function TimelinePlayhead({
  currentFrame,
  totalDurationInFrames,
  playerRef,
  containerRef,
}: TimelinePlayheadProps) {
  const [isDragging, setIsDragging] = useState(false);
  const wasPlayingRef = useRef(false);

  const percent = totalDurationInFrames > 0
    ? (currentFrame / totalDurationInFrames) * 100
    : 0;

  const getFrameFromX = useCallback((clientX: number) => {
    const container = containerRef.current;
    if (!container) return 0;
    const rect = container.getBoundingClientRect();
    const x = clientX - rect.left;
    const fraction = Math.max(0, Math.min(1, x / rect.width));
    return Math.round(fraction * Math.max(totalDurationInFrames - 1, 0));
  }, [containerRef, totalDurationInFrames]);

  const handlePointerDown = (e: React.PointerEvent) => {
    e.currentTarget.setPointerCapture(e.pointerId);
    setIsDragging(true);
    wasPlayingRef.current = playerRef.current?.isPlaying() ?? false;
    playerRef.current?.pause();
    const frame = getFrameFromX(e.clientX);
    playerRef.current?.seekTo(frame);
  };

  const handlePointerMove = (e: React.PointerEvent) => {
    if (!isDragging) return;
    const frame = getFrameFromX(e.clientX);
    playerRef.current?.seekTo(frame);
  };

  const handlePointerUp = () => {
    setIsDragging(false);
    if (wasPlayingRef.current) {
      playerRef.current?.play();
    }
  };

  return (
    <div
      className="absolute top-0 bottom-0 z-20 cursor-ew-resize touch-none group"
      style={{ left: `calc(${percent}% - 6px)` }}
    >
      {/* Hit zone for easier grabbing (12px wide, invisible) */}
      <div
        className="absolute inset-0 w-3"
        onPointerDown={handlePointerDown}
        onPointerMove={handlePointerMove}
        onPointerUp={handlePointerUp}
        onPointerCancel={handlePointerUp}
      />
      {/* Visible line (2px wide, centered) */}
      <div className="absolute left-[5px] top-0 bottom-0 w-0.5 bg-primary group-hover:bg-primary/80" />
      {/* Playhead triangle at top */}
      <div className="absolute left-[3px] top-0 w-0 h-0 border-l-[4px] border-r-[4px] border-t-[6px] border-l-transparent border-r-transparent border-t-primary" />
    </div>
  );
}
```

Modify `src/components/movie/timeline.tsx`:
- Add `playerRef: React.RefObject<PlayerRef>` to props interface
- Import `useCurrentPlayerFrame` from "@/hooks/use-current-player-frame"
- Import `TimelinePlayhead` from "./timeline-playhead"
- Create `const timelineContainerRef = useRef<HTMLDivElement>(null);`
- Add `const currentFrame = useCurrentPlayerFrame(playerRef);`
- Create click-to-seek handler:
  ```typescript
  const handleTimelineClick = (e: React.MouseEvent<HTMLDivElement>) => {
    // Don't seek if clicking on a clip (only background/ruler)
    if ((e.target as HTMLElement).closest('[data-sortable]')) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const fraction = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    const frame = Math.round(fraction * Math.max(totalDurationInFrames - 1, 0));
    playerRef.current?.seekTo(frame);
  };
  ```
- Wrap the ruler and clip track in a container with `ref={timelineContainerRef}` and `onClick={handleTimelineClick}`
- Add the TimelinePlayhead component inside this container, positioned absolutely:
  ```jsx
  <TimelinePlayhead
    currentFrame={currentFrame}
    totalDurationInFrames={totalDurationInFrames}
    playerRef={playerRef}
    containerRef={timelineContainerRef}
  />
  ```
- Add `relative` class to the container and ensure playhead spans both ruler and clip track areas
  </action>
  <verify>
- `npm run build` succeeds
- `npm run lint` passes
- Playhead visible on timeline
  </verify>
  <done>
- Playhead displays at correct position based on current frame
- Dragging playhead seeks the player
- Clicking ruler/background jumps playhead to that position
- Playing the video moves playhead smoothly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Timeline with proportional clips, timecode ruler, and synced draggable playhead.
  </what-built>
  <how-to-verify>
1. Open http://localhost:3000/movie/[movie-id] with a movie containing 2+ scenes of different durations
2. **Proportional widths:** Verify clips have different widths based on their duration
3. **Ruler:** Verify timecode marks appear above clips (0:00, 1.0, 2.0, etc.)
4. **Playhead sync:** Click Play on the preview player and verify the playhead moves smoothly across the timeline
5. **Drag to seek:** Drag the playhead left/right and verify the preview player jumps to that position
6. **Click to seek:** Click anywhere on the ruler or timeline background and verify the playhead and preview jump to that position
7. **Playhead visual:** Verify the playhead has a visible line and triangle indicator at the top
8. Verify touch-none prevents page scroll when dragging on mobile (if testing on touch device)
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. Human verification confirms all 5 success criteria from the phase are met
</verification>

<success_criteria>
- Playhead position = `(currentFrame / totalDurationInFrames) * 100%`
- Dragging playhead calls `playerRef.current.seekTo(frame)`
- Playing the video moves playhead in sync via `useCurrentPlayerFrame`
- Clicking ruler/background seeks to clicked position
- Playhead pauses during drag and resumes play state after release
</success_criteria>

<output>
After completion, create `.planning/phases/19-timeline-foundation/19-02-SUMMARY.md`
</output>
