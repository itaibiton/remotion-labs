---
phase: 21-blade-split
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/movie/movie-editor.tsx
  - src/components/movie/timeline.tsx
  - src/components/movie/timeline-scene.tsx
autonomous: false

must_haves:
  truths:
    - "User can activate blade tool via toolbar button or B key"
    - "With blade mode active, timeline shows visual indicator (cursor change, button highlight)"
    - "Clicking on a clip while in blade mode splits it at the playhead position"
    - "The two resulting clips share the same source but have different trim ranges"
    - "Both resulting clips are independently trimmable and reorderable"
    - "Help text updates to mention blade tool shortcut"
  artifacts:
    - path: "src/components/movie/movie-editor.tsx"
      provides: "Blade mode state, split handler, passes to timeline"
      contains: "useBladeMode"
    - path: "src/components/movie/timeline.tsx"
      provides: "Blade button, cursor change, split-at-playhead wiring"
      contains: "isBladeMode"
    - path: "src/components/movie/timeline-scene.tsx"
      provides: "Blade cursor on clips"
      contains: "cursor-crosshair"
  key_links:
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/hooks/use-blade-mode.ts"
      via: "hook import"
      pattern: "useBladeMode"
    - from: "src/components/movie/movie-editor.tsx"
      to: "api.movies.splitScene"
      via: "mutation call"
      pattern: "splitScene\\("
    - from: "src/components/movie/timeline.tsx"
      to: "src/components/movie/movie-editor.tsx"
      via: "onSplit prop"
      pattern: "onSplit\\("
---

<objective>
Wire up the blade tool UI: toolbar button, visual mode indicator, and click-to-split functionality.

Purpose: Complete the blade tool feature by integrating the hook and mutation from Plan 01 into the timeline UI. Users will be able to toggle blade mode via button or keyboard, see visual feedback, and split clips at the playhead position.
Output: Fully functional blade tool with visual indicators and split capability.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-blade-split/21-RESEARCH.md
@.planning/phases/21-blade-split/21-01-SUMMARY.md

@src/components/movie/movie-editor.tsx
@src/components/movie/timeline.tsx
@src/components/movie/timeline-scene.tsx
@src/hooks/use-blade-mode.ts
@convex/movies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate blade mode in movie-editor and timeline</name>
  <files>
    src/components/movie/movie-editor.tsx
    src/components/movie/timeline.tsx
  </files>
  <action>
**In movie-editor.tsx:**

1. Import the useBladeMode hook and splitScene mutation:
   ```typescript
   import { useBladeMode } from "@/hooks/use-blade-mode";
   ```
   Add `splitScene` to the useMutation calls.

2. Create a helper function to find which scene contains a given frame:
   ```typescript
   function findSceneAtFrame(
     scenes: Array<{...}>,
     targetFrame: number
   ): { sceneIndex: number; frameInClip: number } | null
   ```
   This iterates through scenes, accumulating effective durations, and returns the scene index and frame position within the original clip when found.

3. Create the split handler:
   ```typescript
   const handleSplitAtPlayhead = useCallback(async () => {
     const location = findSceneAtFrame(scenesWithClips, currentFrame);
     if (!location) {
       toast.error("No clip at playhead position");
       return;
     }
     try {
       await splitScene({
         movieId: movie!._id as any,
         sceneIndex: location.sceneIndex,
         splitFrame: location.frameInClip,
       });
       toast.success("Clip split");
     } catch (error) {
       toast.error(error instanceof Error ? error.message : "Failed to split clip");
     }
   }, [currentFrame, scenesWithClips, movie, splitScene]);
   ```

4. Use the hook with the split callback:
   ```typescript
   const { isBladeMode, toggleBladeMode, exitBladeMode } = useBladeMode({
     onSplitAtPlayhead: handleSplitAtPlayhead,
   });
   ```

5. Get currentFrame using the existing useCurrentPlayerFrame hook:
   ```typescript
   import { useCurrentPlayerFrame } from "@/hooks/use-current-player-frame";
   const currentFrame = useCurrentPlayerFrame(playerRef);
   ```

6. Pass blade mode props to Timeline component:
   ```typescript
   <Timeline
     {...existingProps}
     isBladeMode={isBladeMode}
     onToggleBladeMode={toggleBladeMode}
     onSplit={handleSplitAtPlayhead}
   />
   ```

**In timeline.tsx:**

1. Update TimelineProps interface to include:
   ```typescript
   isBladeMode?: boolean;
   onToggleBladeMode?: () => void;
   onSplit?: () => void;
   ```

2. Import Scissors icon from lucide-react:
   ```typescript
   import { Scissors } from "lucide-react";
   ```

3. Add blade button to the timeline header (next to zoom controls):
   ```typescript
   <div className="flex items-center justify-between px-4 py-2 border-b">
     <div className="flex items-center gap-2">
       <span className="text-sm text-muted-foreground">Timeline</span>
       {onToggleBladeMode && (
         <Button
           variant={isBladeMode ? "default" : "outline"}
           size="sm"
           onClick={onToggleBladeMode}
           title={isBladeMode ? "Exit blade mode (Esc)" : "Blade tool (B)"}
         >
           <Scissors className="h-4 w-4" />
         </Button>
       )}
     </div>
     <TimelineZoomControls ... />
   </div>
   ```

4. Add cursor change to timeline container when in blade mode:
   ```typescript
   <div
     ref={timelineContainerRef}
     className={`relative ${isBladeMode ? "cursor-crosshair" : "cursor-pointer"}`}
     ...
   >
   ```

5. Modify handleTimelineClick to trigger split when in blade mode:
   ```typescript
   const handleTimelineClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
     if (isBladeMode && onSplit) {
       // In blade mode, clicking anywhere triggers split at playhead
       onSplit();
       return;
     }
     // Existing seek logic...
   }, [isBladeMode, onSplit, ...existingDeps]);
   ```

6. Update help text at bottom:
   ```typescript
   <p className="text-xs text-muted-foreground mt-2 text-center">
     Drag to reorder | Drag edges to trim | Ctrl+scroll to zoom | B for blade tool
   </p>
   ```

7. Pass isBladeMode to TimelineScene for cursor styling.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run dev` starts without errors
- Blade button appears in timeline header
  </verify>
  <done>
- movie-editor.tsx has useBladeMode hook and split handler
- timeline.tsx has blade button and cursor change
- Props flow correctly between components
  </done>
</task>

<task type="auto">
  <name>Task 2: Add blade cursor to timeline scenes</name>
  <files>
    src/components/movie/timeline-scene.tsx
  </files>
  <action>
1. Update TimelineSceneProps to include:
   ```typescript
   isBladeMode?: boolean;
   ```

2. Apply conditional cursor styling to the scene container:
   ```typescript
   <div
     ref={setNodeRef}
     style={{ ... }}
     className={`group relative h-[110px] flex-shrink-0 rounded-lg border bg-card overflow-hidden
       ${isActive ? "ring-2 ring-primary" : ""}
       ${isBladeMode ? "cursor-crosshair" : ""}`}
   >
   ```

3. Also apply to the center drag area so the cursor is consistent:
   ```typescript
   <div
     ref={setActivatorNodeRef}
     {...attributes}
     {...listeners}
     className={`absolute inset-x-3 inset-y-0 z-10 ${
       isBladeMode ? "cursor-crosshair" : "cursor-grab active:cursor-grabbing"
     }`}
   />
   ```

4. Update timeline.tsx to pass isBladeMode to TimelineScene:
   ```typescript
   <TimelineScene
     key={`scene-${index}`}
     id={`scene-${index}`}
     clip={scene.clip}
     index={index}
     isActive={index === activeSceneIndex}
     isBladeMode={isBladeMode}
     trimStart={scene.trimStart ?? 0}
     trimEnd={scene.trimEnd ?? 0}
     scale={scale}
     onRemove={onRemove}
     onTrimChange={handleTrimChange}
   />
   ```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Cursor changes to crosshair on clips when blade mode is active
  </verify>
  <done>
- TimelineScene shows crosshair cursor in blade mode
- Drag area cursor respects blade mode
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete blade tool functionality: keyboard shortcuts (B to toggle, Esc/V/A to exit), toolbar button with visual highlight, cursor change on timeline and clips, and click-to-split at playhead position.</what-built>
  <how-to-verify>
1. Open http://localhost:3000 and navigate to a movie with at least one clip
2. Test keyboard shortcut:
   - Press "B" - blade button should highlight, cursor should change to crosshair
   - Press "Escape" or "V" or "A" - should exit blade mode (button unhighlights, cursor normal)
3. Test toolbar button:
   - Click the scissors button - should toggle blade mode
4. Test split functionality:
   - Enter blade mode (B or click button)
   - Position playhead somewhere in the middle of a clip
   - Click anywhere on the timeline - clip should split into two
   - Verify: Two clips now exist, first ends at playhead, second starts at playhead
   - Verify: Both clips can be independently trimmed (drag handles)
   - Verify: Both clips can be reordered (drag center)
5. Test edge cases:
   - Try to split at the very start or end of a clip - should fail with error toast
   - Try blade mode while in a text input (movie name) - should NOT toggle
6. Test help text shows "B for blade tool" at bottom
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit`
2. Dev server runs without errors: `npm run dev`
3. Manual testing of blade tool functionality
4. Split creates two independent clips with correct trim values
5. Both clips work with existing trim and reorder features
</verification>

<success_criteria>
- Blade button appears in timeline header
- Pressing B toggles blade mode (with visual feedback)
- Clicking in blade mode splits clip at playhead position
- Two resulting clips have complementary trim ranges
- Both clips are independently trimmable and reorderable
- Help text mentions blade tool shortcut
</success_criteria>

<output>
After completion, create `.planning/phases/21-blade-split/21-02-SUMMARY.md`
</output>
