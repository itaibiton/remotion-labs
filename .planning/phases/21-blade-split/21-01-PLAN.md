---
phase: 21-blade-split
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-blade-mode.ts
  - convex/movies.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Pressing B key toggles blade mode state"
    - "Pressing Escape/V/A exits blade mode"
    - "Keyboard shortcuts do not trigger in text inputs"
    - "splitScene mutation splits a scene into two at the specified frame"
    - "Split validation rejects invalid split positions (at edges)"
  artifacts:
    - path: "src/hooks/use-blade-mode.ts"
      provides: "Blade mode state and keyboard shortcut handling"
      exports: ["useBladeMode"]
      min_lines: 40
    - path: "convex/movies.ts"
      provides: "splitScene mutation"
      contains: "export const splitScene"
  key_links:
    - from: "src/hooks/use-blade-mode.ts"
      to: "tinykeys"
      via: "keyboard binding"
      pattern: "tinykeys\\(window"
    - from: "convex/movies.ts"
      to: "computeTotalDuration"
      via: "recompute total after split"
      pattern: "computeTotalDuration\\(ctx, newScenes\\)"
---

<objective>
Create the foundation for the blade tool: keyboard shortcut handling via tinykeys and the splitScene Convex mutation.

Purpose: Establish the core infrastructure that the UI layer will consume in the next plan. The hook manages blade mode state with industry-standard keyboard shortcuts (B to toggle, Escape/V/A to exit). The mutation handles the split logic using the existing trim infrastructure.
Output: Working useBladeMode hook and splitScene mutation ready for UI integration.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-blade-split/21-RESEARCH.md

@convex/movies.ts
@src/hooks/use-timeline-zoom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tinykeys and create useBladeMode hook</name>
  <files>
    package.json
    src/hooks/use-blade-mode.ts
  </files>
  <action>
1. Install tinykeys:
   ```bash
   npm install tinykeys
   ```

2. Create `src/hooks/use-blade-mode.ts` with the following implementation:

- Export `useBladeMode` hook that returns `{ isBladeMode, toggleBladeMode, exitBladeMode }`
- Use `useState` for `isBladeMode` boolean (default: false)
- Use `useCallback` for `toggleBladeMode` and `exitBladeMode` functions
- Use `useEffect` with `tinykeys(window, {...})` to bind keyboard shortcuts:
  - "b": Toggle blade mode (call toggleBladeMode)
  - "Escape": Exit blade mode (call exitBladeMode)
  - "v": Exit blade mode (Premiere Pro convention)
  - "a": Exit blade mode (DaVinci Resolve convention)
- IMPORTANT: In each handler, check if `e.target` is an input/textarea/contenteditable before toggling:
  ```typescript
  if (e.target instanceof HTMLInputElement ||
      e.target instanceof HTMLTextAreaElement ||
      (e.target as HTMLElement).isContentEditable) {
    return;
  }
  ```
- Return the cleanup function `unsubscribe` from useEffect
- Accept optional `onSplitAtPlayhead?: () => void` callback for Cmd+B split action

Reference the research document for the complete implementation pattern.
  </action>
  <verify>
- `npm ls tinykeys` shows package installed
- File exists at `src/hooks/use-blade-mode.ts`
- TypeScript compilation succeeds: `npx tsc --noEmit`
  </verify>
  <done>
- tinykeys installed in package.json
- useBladeMode hook exports isBladeMode state and toggle/exit functions
- Keyboard shortcuts bound (B, Escape, V, A) with input field guards
  </done>
</task>

<task type="auto">
  <name>Task 2: Add splitScene mutation to Convex movies</name>
  <files>
    convex/movies.ts
  </files>
  <action>
Add a new `splitScene` mutation to `convex/movies.ts`:

1. Args:
   - `movieId: v.id("movies")`
   - `sceneIndex: v.number()`
   - `splitFrame: v.number()` -- frame position in ORIGINAL clip (not visible portion)

2. Handler logic:
   a. Authenticate user and verify movie ownership
   b. Get the scene at sceneIndex
   c. Get the clip to determine baseDuration: `scene.durationOverride ?? clip.durationInFrames`
   d. Get current trim values: `trimStart = scene.trimStart ?? 0`, `trimEnd = scene.trimEnd ?? 0`
   e. Validate split position:
      - `splitFrame > trimStart` (must be after current trim start)
      - `splitFrame < baseDuration - trimEnd` (must be before current trim end)
      - If invalid, throw descriptive error
   f. Create two new scene objects:
      - First scene: same clipId, trimStart unchanged, trimEnd = `baseDuration - splitFrame`
      - Second scene: same clipId, trimStart = `splitFrame`, trimEnd unchanged
      - Preserve durationOverride on both
   g. Replace original scene with the two new scenes in the array
   h. Recompute totalDuration using existing `computeTotalDuration` helper
   i. Patch movie with new scenes array and updated totalDurationInFrames

Return value: `{ firstSceneIndex: args.sceneIndex, secondSceneIndex: args.sceneIndex + 1 }`

The mutation follows the exact pattern of `trimScene` but creates two scenes instead of modifying one.
  </action>
  <verify>
- Convex dev server reloads without errors: Check terminal running `npx convex dev`
- Mutation appears in Convex dashboard under movies module
- TypeScript compilation succeeds: `npx tsc --noEmit`
  </verify>
  <done>
- splitScene mutation exists in convex/movies.ts
- Mutation validates split position (not at edges)
- Mutation creates two scenes with correct trim values
- Total duration is recomputed after split
  </done>
</task>

</tasks>

<verification>
1. Run `npm ls tinykeys` - package should be listed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Check Convex dashboard - splitScene mutation should appear in movies module
4. Both files should exist with correct exports
</verification>

<success_criteria>
- tinykeys package installed
- useBladeMode hook exists with keyboard shortcut handling
- splitScene mutation exists with proper validation and split logic
- No TypeScript errors
- No runtime errors in Convex dev server
</success_criteria>

<output>
After completion, create `.planning/phases/21-blade-split/21-01-SUMMARY.md`
</output>
