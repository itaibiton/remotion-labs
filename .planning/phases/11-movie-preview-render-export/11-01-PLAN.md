---
phase: 11-movie-preview-render-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-current-player-frame.ts
  - src/components/movie/movie-preview-player.tsx
  - src/components/movie/movie-editor.tsx
  - src/components/movie/timeline.tsx
  - src/components/movie/timeline-scene.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Preview on the movie page and watch all scenes play in sequence in one player"
    - "User can scrub through the full movie preview and see the corresponding scene highlighted on the timeline"
  artifacts:
    - path: "src/hooks/use-current-player-frame.ts"
      provides: "useSyncExternalStore-based hook for tracking Player frame from a sibling component"
      exports: ["useCurrentPlayerFrame"]
    - path: "src/components/movie/movie-preview-player.tsx"
      provides: "Player wrapping MovieComposition with frame-to-scene mapping and active scene callback"
      exports: ["MoviePreviewPlayer"]
    - path: "src/components/movie/movie-editor.tsx"
      provides: "Movie editor with preview player above timeline, activeSceneIndex state"
    - path: "src/components/movie/timeline.tsx"
      provides: "Timeline with activeSceneIndex prop for scene highlighting"
    - path: "src/components/movie/timeline-scene.tsx"
      provides: "TimelineScene with isActive prop for visual highlight ring"
  key_links:
    - from: "src/components/movie/movie-preview-player.tsx"
      to: "src/hooks/use-current-player-frame.ts"
      via: "useCurrentPlayerFrame(playerRef)"
      pattern: "useCurrentPlayerFrame"
    - from: "src/components/movie/movie-preview-player.tsx"
      to: "src/remotion/compositions/MovieComposition.tsx"
      via: "Player component prop"
      pattern: "component=.*MovieComposition"
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/movie-preview-player.tsx"
      via: "MoviePreviewPlayer with onActiveSceneChange callback"
      pattern: "onActiveSceneChange"
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/timeline.tsx"
      via: "activeSceneIndex prop"
      pattern: "activeSceneIndex"
---

<objective>
Build the movie preview player with frame-synced timeline scene highlighting.

Purpose: Users need to preview their full movie as one continuous video and see which scene is currently playing on the timeline. This is the core viewing experience for the movie editor.

Output: MoviePreviewPlayer component wrapping MovieComposition in a Remotion Player, useCurrentPlayerFrame hook for efficient frame tracking, and timeline scene highlighting based on the current playback position.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-movie-preview-render-export/11-RESEARCH.md
@src/remotion/compositions/MovieComposition.tsx
@src/components/movie/movie-editor.tsx
@src/components/movie/timeline.tsx
@src/components/movie/timeline-scene.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCurrentPlayerFrame hook and MoviePreviewPlayer component</name>
  <files>
    src/hooks/use-current-player-frame.ts
    src/components/movie/movie-preview-player.tsx
  </files>
  <action>
  Create `src/hooks/use-current-player-frame.ts`:
  - Export `useCurrentPlayerFrame(ref: React.RefObject<PlayerRef | null>): number`
  - Use `useSyncExternalStore` from React (NOT useState + setInterval)
  - Subscribe to `frameupdate` event on PlayerRef via `addEventListener`/`removeEventListener`
  - `getSnapshot` returns `ref.current?.getCurrentFrame() ?? 0`
  - `getServerSnapshot` returns `0`
  - The subscribe callback must handle null ref (return no-op cleanup)

  Create `src/components/movie/movie-preview-player.tsx`:
  - "use client" directive
  - Import Player and PlayerRef from `@remotion/player`, MovieComposition and MovieScene from `@/remotion/compositions/MovieComposition`, useCurrentPlayerFrame from `@/hooks/use-current-player-frame`
  - Props: `scenes: MovieScene[]`, `fps: number`, `totalDurationInFrames: number`, `onActiveSceneChange?: (sceneIndex: number) => void`
  - Create playerRef via `useRef<PlayerRef>(null)`
  - Call `useCurrentPlayerFrame(playerRef)` to get current frame
  - Compute `sceneTimings` array via useMemo: for each scene, accumulate startFrame/endFrame offsets
  - Compute `activeSceneIndex` via useMemo from frame + sceneTimings (iterate timings, find where frame >= startFrame && frame < endFrame; fallback to last scene)
  - useEffect to call `onActiveSceneChange?.(activeSceneIndex)` when activeSceneIndex changes
  - Render `<Player ref={playerRef} component={MovieComposition} inputProps={{ scenes }} durationInFrames={totalDurationInFrames} fps={fps} compositionWidth={1920} compositionHeight={1080} style={{ width: "100%" }} controls loop />`
  - If totalDurationInFrames is 0, render nothing (guard for empty movies)
  - Cast component as `MovieComposition as React.ComponentType<Record<string, unknown>>` to satisfy Player's generic type constraint (see existing PreviewPlayer pattern if applicable)
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no type errors in the new files. Verify both files exist with correct exports.
  </verify>
  <done>
  useCurrentPlayerFrame hook exists and uses useSyncExternalStore pattern. MoviePreviewPlayer renders a Remotion Player with MovieComposition, tracks frame position, and calls onActiveSceneChange with the correct scene index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire preview into movie-editor and add timeline scene highlighting</name>
  <files>
    src/components/movie/movie-editor.tsx
    src/components/movie/timeline.tsx
    src/components/movie/timeline-scene.tsx
  </files>
  <action>
  Modify `src/components/movie/movie-editor.tsx`:
  - Add state: `const [activeSceneIndex, setActiveSceneIndex] = useState<number>(-1);`
  - Import MoviePreviewPlayer from `@/components/movie/movie-preview-player`
  - Build `validScenes` array from `scenesWithClips` by filtering out entries where `clip` is null, then mapping to `{ code: clip.code, durationInFrames: clip.durationInFrames, fps: clip.fps }` (MovieScene shape)
  - Compute `totalDurationInFrames` as sum of validScenes' durationInFrames
  - In the render section, ABOVE the Timeline (inside the `movie.scenes.length > 0` branch), add:
    ```
    <div className="px-6 pt-6">
      <MoviePreviewPlayer
        scenes={validScenes}
        fps={movie.fps}
        totalDurationInFrames={totalDurationInFrames}
        onActiveSceneChange={setActiveSceneIndex}
      />
    </div>
    ```
  - Pass `activeSceneIndex` prop to `<Timeline>`

  Modify `src/components/movie/timeline.tsx`:
  - Add `activeSceneIndex?: number` to TimelineProps interface
  - Pass `isActive={index === activeSceneIndex}` prop to each `<TimelineScene>`

  Modify `src/components/movie/timeline-scene.tsx`:
  - Add `isActive?: boolean` to TimelineSceneProps interface
  - When `isActive` is true, add a visual ring: change the container className to include `ring-2 ring-primary` (in addition to existing classes). Use conditional: `${isActive ? "ring-2 ring-primary" : ""}`
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no type errors. Run `npm run build` to confirm the build passes. Visually: the movie editor page should show a Player above the timeline when scenes exist, and the active scene should have a primary-colored ring during playback.
  </verify>
  <done>
  Movie editor shows MoviePreviewPlayer above the timeline. Scrubbing or playing the preview highlights the corresponding scene block on the timeline with a colored ring. Empty movies still show the "No scenes yet" state.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Navigate to a movie page with 2+ scenes -- Player appears and plays all scenes in sequence
4. While playing or scrubbing, the corresponding timeline scene block gets a highlight ring
5. Empty movies (0 scenes) show the "No scenes yet" placeholder, not the player
</verification>

<success_criteria>
- MoviePreviewPlayer renders all movie scenes in sequence via Remotion Player
- useCurrentPlayerFrame hook efficiently tracks frame position without causing Player re-renders
- Active scene index is computed from frame position and scene timings
- Timeline visually highlights the active scene during playback/scrub
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-movie-preview-render-export/11-01-SUMMARY.md`
</output>
