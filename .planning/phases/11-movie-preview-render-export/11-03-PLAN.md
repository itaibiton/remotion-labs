---
phase: 11-movie-preview-render-export
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - src/components/movie/movie-render-button.tsx
  - src/components/render/render-progress.tsx
  - src/lib/export-movie-zip.ts
  - src/components/movie/movie-export-buttons.tsx
  - src/components/movie/movie-editor.tsx
autonomous: false

must_haves:
  truths:
    - "User can render the full movie to a single MP4 and download it from the movie editor"
    - "User can export the full movie as a multi-composition Remotion project zip"
    - "User can see render progress and download the MP4 when complete"
  artifacts:
    - path: "src/components/movie/movie-render-button.tsx"
      provides: "Button that triggers startMovieRender action and shows progress/download"
      exports: ["MovieRenderButton"]
    - path: "src/lib/export-movie-zip.ts"
      provides: "Multi-composition Remotion project zip generator for movies"
      exports: ["generateMovieProjectZip"]
    - path: "src/components/movie/movie-export-buttons.tsx"
      provides: "Export buttons for movie: MP4 render + Remotion project zip download"
      exports: ["MovieExportButtons"]
    - path: "src/components/movie/movie-editor.tsx"
      provides: "Movie editor with render + export controls in the header"
  key_links:
    - from: "src/components/movie/movie-render-button.tsx"
      to: "convex/triggerRender.ts"
      via: "useAction(api.triggerRender.startMovieRender)"
      pattern: "startMovieRender"
    - from: "src/components/movie/movie-render-button.tsx"
      to: "convex/renders.ts"
      via: "useQuery(api.renders.getByMovie) for progress tracking"
      pattern: "getByMovie"
    - from: "src/components/movie/movie-export-buttons.tsx"
      to: "src/lib/export-movie-zip.ts"
      via: "generateMovieProjectZip call"
      pattern: "generateMovieProjectZip"
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/movie-render-button.tsx"
      via: "MovieRenderButton in header controls"
      pattern: "MovieRenderButton"
    - from: "src/components/movie/movie-editor.tsx"
      to: "src/components/movie/movie-export-buttons.tsx"
      via: "MovieExportButtons in header controls"
      pattern: "MovieExportButtons"
---

<objective>
Wire movie render and export UI into the movie editor page.

Purpose: Users need to trigger movie rendering to MP4 and export the full movie as a Remotion project zip. This plan creates the render button (with progress tracking and download), the movie zip generator, and export buttons, then wires everything into the movie editor header.

Output: MovieRenderButton, MovieExportButtons, export-movie-zip generator, and updated movie-editor with render/export controls.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-movie-preview-render-export/11-RESEARCH.md
@.planning/phases/11-movie-preview-render-export/11-01-SUMMARY.md
@.planning/phases/11-movie-preview-render-export/11-02-SUMMARY.md
@src/components/movie/movie-editor.tsx
@src/components/render/render-button.tsx
@src/components/render/render-progress.tsx
@src/components/render/download-button.tsx
@src/lib/export-project-zip.ts
@src/lib/export-utils.ts
@src/components/export/export-buttons.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MovieRenderButton and export-movie-zip generator</name>
  <files>
    src/components/movie/movie-render-button.tsx
    src/lib/export-movie-zip.ts
  </files>
  <action>
  Create `src/components/movie/movie-render-button.tsx`:
  - "use client" directive
  - Import useAction from "convex/react", api, toast from sonner, Button from ui/button, lucide icons (Play, Loader2, Download, Check)
  - Import useQuery from "convex/react" for render status tracking
  - Props: `movieId: string` (will be cast to Id<"movies"> via `as any`), `disabled?: boolean` (disable when movie has 0 scenes)
  - State: `isRendering` (boolean, tracks if action is in progress)
  - Use `useQuery(api.renders.getByMovie, { movieId: movieId as any })` to get latest render for this movie
  - Derive render state from query result: pending/rendering shows progress, complete shows download, failed shows retry
  - Render logic (3 states):
    1. **No render or failed**: Show "Render MP4" button. On click, call `startMovieRender({ movieId: movieId as any })`, set isRendering=true, toast.success on return, catch errors and toast.error
    2. **Rendering in progress**: Show RenderProgress-style inline: `<Button disabled><Loader2 className="animate-spin" /> Rendering {render.progress}%</Button>`
    3. **Complete**: Show download button. Use an anchor tag or the existing download-button pattern. Link to `render.outputUrl`. Also show a "Re-render" secondary button.
  - Use the existing `RenderProgress` and `DownloadButton` components if they can be reused cleanly, OR inline the progress/download UI to keep the component self-contained (prefer inlining for simplicity -- these are just a progress % display and a download link).

  Create `src/lib/export-movie-zip.ts`:
  - Follow the pattern from `export-project-zip.ts` and the research example
  - Import JSZip, detectUsedAPIs, extractMetadata from export-utils
  - Export `generateMovieProjectZip(options)` where options is:
    ```
    {
      movieName: string;
      scenes: Array<{ rawCode: string; name: string; durationInFrames: number; fps: number }>;
      totalDurationInFrames: number;
      fps: number;
    }
    ```
  - Create zip structure:
    - `remotionlab-movie-export/src/Scene01.tsx` through `SceneNN.tsx` -- each scene as a standalone component. Use `detectUsedAPIs` on rawCode, `extractMetadata` to strip metadata comments, rename `MyComposition` to `SceneNN` with export keyword.
    - `remotionlab-movie-export/src/MovieComposition.tsx` -- imports all SceneNN, uses `<Series>` with `<Series.Sequence durationInFrames={...}>` for each
    - `remotionlab-movie-export/src/Root.tsx` -- registers both individual scene compositions AND the Movie composition. Fragment pattern `<> <Composition id="Movie" ... /> <Composition id="Scene01" ... /> ... </>`
    - `remotionlab-movie-export/src/index.ts` -- `registerRoot(RemotionRoot)`
    - `remotionlab-movie-export/package.json` -- same dependencies as single export but with movie name. Scripts: `dev`, `render` (renders Movie composition), `build`
    - `remotionlab-movie-export/tsconfig.json` -- reuse `generateTsConfig` pattern
    - `remotionlab-movie-export/remotion.config.ts` -- reuse `generateRemotionConfig` pattern
  - Reuse the `generateTsConfig` and `generateRemotionConfig` helper functions. Since they are private in `export-project-zip.ts`, either duplicate them (they're small -- ~10 lines each) or extract to export-utils.ts. Prefer duplication to avoid modifying export-project-zip.ts (which is not in this plan's files_modified).
  - Return `zip.generateAsync({ type: "blob" })`
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no type errors. Verify both files exist with correct exports. Verify `generateMovieProjectZip` produces a zip Blob with the expected folder structure.
  </verify>
  <done>
  MovieRenderButton triggers startMovieRender, shows progress inline, and provides download when complete. export-movie-zip generates a multi-composition Remotion project zip with individual scene files + MovieComposition + Root.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MovieExportButtons and wire render + export into movie-editor</name>
  <files>
    src/components/movie/movie-export-buttons.tsx
    src/components/movie/movie-editor.tsx
  </files>
  <action>
  Create `src/components/movie/movie-export-buttons.tsx`:
  - "use client" directive
  - Import Button, Download icon, Loader2 icon, toast
  - Import generateMovieProjectZip from `@/lib/export-movie-zip`
  - Import downloadBlob from `@/lib/export-utils`
  - Props: `movieName: string`, `scenes: Array<{ rawCode: string; name: string; durationInFrames: number; fps: number }>`, `totalDurationInFrames: number`, `fps: number`, `disabled?: boolean`
  - State: `isExporting` boolean
  - Single button: "Export Remotion Project" with Download icon
  - On click: set isExporting=true, call `generateMovieProjectZip({ movieName, scenes, totalDurationInFrames, fps })`, call `downloadBlob(blob, sanitizedMovieName + "-remotion-project.zip")`, toast.success, set isExporting=false, catch errors and toast.error
  - Sanitize movie name for filename: replace non-alphanumeric with hyphens, lowercase

  Modify `src/components/movie/movie-editor.tsx`:
  - Import MovieRenderButton from `@/components/movie/movie-render-button`
  - Import MovieExportButtons from `@/components/movie/movie-export-buttons`
  - In the header controls area (the `<div className="flex items-center gap-2">` next to the Add Scene button), add:
    - `<MovieRenderButton movieId={movieId} disabled={validScenes.length === 0} />` (where validScenes is computed in 11-01)
    - `<MovieExportButtons movieName={movie.name} scenes={exportScenes} totalDurationInFrames={totalDurationInFrames} fps={movie.fps} disabled={validScenes.length === 0} />`
  - Build `exportScenes` from `scenesWithClips`: filter where clip is not null, map to `{ rawCode: clip.rawCode, name: clip.name, durationInFrames: clip.durationInFrames, fps: clip.fps }`. NOTE: clips may not have rawCode exposed from getWithClips. Check the clips schema -- clips have `rawCode: v.string()`. Check if getWithClips returns rawCode. If the clip data from getWithClips includes rawCode (it should, since getWithClips does `ctx.db.get(scene.clipId)` which returns the full document), use it directly. If not, add rawCode to the clip interface where needed.
  - Ensure the header doesn't overflow with the new buttons -- use `flex-wrap` or a responsive layout if needed
  </action>
  <verify>
  Run `npx tsc --noEmit` -- no type errors. Run `npm run build` -- build succeeds. Navigate to movie editor page with scenes: Render MP4 button and Export Remotion Project button appear in the header. Clicking Export downloads a zip file.
  </verify>
  <done>
  Movie editor header shows Render MP4 button (with progress/download states) and Export Remotion Project button (downloads zip). Both are disabled when movie has no valid scenes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete movie render and export flow:
  1. Movie preview player with timeline scene highlighting (from 11-01)
  2. Movie render to MP4 via Lambda with progress tracking
  3. Movie export as multi-composition Remotion project zip
  All wired into the movie editor page.
  </what-built>
  <how-to-verify>
  1. Navigate to the movie editor page (create a movie with 2+ scenes if needed)
  2. Verify the preview player appears above the timeline and plays all scenes in sequence
  3. Scrub through the player -- verify the active scene is highlighted on the timeline
  4. Click "Render MP4" -- verify progress appears (Note: actual Lambda rendering requires AWS setup; the button click and API call should work, but render may fail if Lambda is not configured)
  5. Click "Export Remotion Project" -- verify a zip file downloads
  6. Unzip the downloaded file -- verify it contains Scene01.tsx, Scene02.tsx, MovieComposition.tsx, Root.tsx, index.ts, package.json, tsconfig.json, remotion.config.ts
  7. Verify the movie editor header doesn't overflow with the new buttons
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. MovieRenderButton appears in movie editor, triggers startMovieRender action, shows progress
4. MovieExportButtons appears in movie editor, generates and downloads multi-composition zip
5. Exported zip has correct structure: individual scene files + MovieComposition + Root
6. Render + export buttons are disabled when movie has no valid scenes
</verification>

<success_criteria>
- User can click Render MP4 on movie page and the action is triggered (actual rendering depends on Lambda setup)
- User can download rendered MP4 when render completes
- User can click Export Remotion Project and download a zip with all scenes as individual components + MovieComposition using Series
- Exported project is a valid Remotion project structure (can be unzipped, npm installed, and npx remotion studio'd)
- Movie editor header cleanly shows Add Scene, Render, and Export controls
</success_criteria>

<output>
After completion, create `.planning/phases/11-movie-preview-render-export/11-03-SUMMARY.md`
</output>
