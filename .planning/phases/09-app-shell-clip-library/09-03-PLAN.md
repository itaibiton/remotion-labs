---
phase: 09-app-shell-clip-library
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/app/(app)/library/page.tsx
  - src/components/library/clip-card.tsx
  - src/components/library/clip-library.tsx
  - src/app/(app)/create/create-page-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /library and see a grid of saved clips"
    - "Each clip card shows a Remotion Thumbnail preview and the clip name"
    - "User can click a clip card to open it in the create page editor"
    - "User can delete a clip with a confirmation dialog"
    - "Opening a clip from library loads its code into the editor and preview"
    - "Library shows empty state message when no clips exist"
  artifacts:
    - path: "src/app/(app)/library/page.tsx"
      provides: "Library page rendering ClipLibrary component"
      min_lines: 10
    - path: "src/components/library/clip-card.tsx"
      provides: "Individual clip card with Thumbnail preview, name, duration, and actions"
      exports: ["ClipCard"]
    - path: "src/components/library/clip-library.tsx"
      provides: "Grid layout of clip cards with loading and empty states"
      exports: ["ClipLibrary"]
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Create page that loads clip data when clipId URL param is present"
  key_links:
    - from: "src/components/library/clip-library.tsx"
      to: "convex/clips.ts"
      via: "useQuery(api.clips.list)"
      pattern: "api\\.clips\\.list"
    - from: "src/components/library/clip-card.tsx"
      to: "@remotion/player"
      via: "Thumbnail component for clip preview"
      pattern: "Thumbnail"
    - from: "src/components/library/clip-library.tsx"
      to: "/create?clipId="
      via: "router.push on clip click"
      pattern: "clipId"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "convex/clips.ts"
      via: "useQuery(api.clips.get, { id: clipId })"
      pattern: "api\\.clips\\.get"
---

<objective>
Build the Library page with clip grid, Remotion Thumbnail previews, open-in-editor, and delete functionality. Wire clip loading into the create page.

Purpose: Users can browse, open, and manage their saved clips. Opening a clip loads it back into the create page for preview and re-editing. This completes the full save/open/delete lifecycle.
Output: Working /library page with clip cards, thumbnails, open and delete actions. Create page loads clip data from URL params.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-app-shell-clip-library/09-RESEARCH.md
@.planning/phases/09-app-shell-clip-library/09-01-SUMMARY.md
@.planning/phases/09-app-shell-clip-library/09-02-SUMMARY.md

Key existing files:
@convex/clips.ts (provides list, get, remove operations -- from Plan 09-02)
@src/remotion/compositions/DynamicCode.tsx (used by Thumbnail for clip preview)
@src/app/(app)/create/create-page-client.tsx (modify to load clip from URL param)
@src/app/(app)/create/page.tsx (already accepts clipId search param -- from Plan 09-01)
@src/components/preview/preview-player.tsx (reference for SSR guard pattern with Remotion)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClipCard and ClipLibrary components</name>
  <files>
    src/components/library/clip-card.tsx
    src/components/library/clip-library.tsx
  </files>
  <action>
**First, add shadcn alert-dialog component** (for delete confirmation):
Run `npx shadcn@latest add alert-dialog`

**Create `src/components/library/clip-card.tsx`:**
Client component ("use client").

Props interface `ClipCardProps`:
- `clip`: The clip document from Convex. Type it using `Doc<"clips">` from `"../../convex/_generated/dataModel"` (adjust relative path as needed from the component location). Alternatively, define an inline interface matching the clips schema: `{ _id: string; name: string; code: string; rawCode: string; durationInFrames: number; fps: number; createdAt: number; updatedAt: number; }`. Prefer the Convex `Doc` type if the import resolves cleanly.
- `onOpen: (clipId: string) => void`
- `onDelete: (clipId: string) => void`

Component implementation:
- SSR guard: `const [isMounted, setIsMounted] = useState(false)` + `useEffect(() => setIsMounted(true), [])` (same pattern as PreviewPlayer -- Remotion Thumbnail uses browser APIs)
- Import `Thumbnail` from "@remotion/player"
- Import `DynamicCode` from "@/remotion/compositions/DynamicCode"
- Import `Card`, `CardContent` from "@/components/ui/card"
- Import `MoreVertical`, `Trash2`, `ExternalLink` from "lucide-react"
- Import AlertDialog components from shadcn for delete confirmation
- Local state: `showDeleteDialog` (boolean)

Layout:
- `<Card>` with cursor-pointer, hover ring effect
- Top area: aspect-video container with black background
  - If `isMounted && clip.code`: render `<Thumbnail>` with:
    - `component={DynamicCode}`
    - `inputProps={{ code: clip.code, durationInFrames: clip.durationInFrames, fps: clip.fps }}`
    - `compositionWidth={1920}`, `compositionHeight={1080}`
    - `frameToDisplay={Math.floor(clip.durationInFrames / 2)}` (middle frame)
    - `durationInFrames={clip.durationInFrames}`, `fps={clip.fps}`
    - `style={{ width: "100%" }}`
  - If not mounted: show a gray placeholder div with same aspect ratio
- Bottom area: padding with:
  - Clip name (truncated, font-medium text-sm)
  - Duration in seconds: `(clip.durationInFrames / clip.fps).toFixed(1)s` (text-xs text-muted-foreground)
  - Actions row: "Open" button (clicks onOpen) and "Delete" button (opens delete confirmation)

- Click on the card itself calls `onOpen(clip._id)` (the whole card is clickable)
- Delete button has `onClick` with `e.stopPropagation()` to prevent card click, then `setShowDeleteDialog(true)`
- Delete confirmation uses shadcn `<AlertDialog>`:
  - Title: "Delete clip?"
  - Description: `Are you sure you want to delete "${clip.name}"? This cannot be undone.`
  - Cancel button + Delete button (variant="destructive")
  - On confirm: calls `onDelete(clip._id)`, closes dialog

**Create `src/components/library/clip-library.tsx`:**
Client component ("use client").

Implementation:
- Import `useQuery`, `useMutation` from "convex/react"
- Import `api` from convex generated
- Import `useRouter` from "next/navigation"
- Import `ClipCard` from "./clip-card"
- Import `toast` from "sonner"
- Import `Library` icon from "lucide-react" (for empty state)

- Fetch clips: `const clips = useQuery(api.clips.list)`
- Delete mutation: `const removeClip = useMutation(api.clips.remove)`
- Router: `const router = useRouter()`

- `handleOpen(clipId: string)`: navigates to `/create?clipId=${clipId}`
- `handleDelete(clipId: string)`: calls `removeClip({ id: clipId as any })`, shows success toast "Clip deleted", catches error and shows error toast. (The `as any` cast is needed because the clipId comes as string but Convex expects `Id<"clips">`. Convex will validate at runtime.)

Loading state (clips === undefined): Show a grid of 4-6 skeleton cards (pulsing gray rectangles with aspect-video ratio)

Empty state (clips.length === 0): Centered message with Library icon, "No clips yet", "Save an animation from the Create page to see it here.", and a link/button to "/create"

Normal state: CSS grid with responsive columns:
- `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4`
- Map clips to `<ClipCard>` with `key={clip._id}`, `clip`, `onOpen={handleOpen}`, `onDelete={handleDelete}`
  </action>
  <verify>
1. Verify components exist:
   - `grep "export function ClipCard" src/components/library/clip-card.tsx`
   - `grep "export function ClipLibrary" src/components/library/clip-library.tsx`
2. Verify Thumbnail integration: `grep "Thumbnail" src/components/library/clip-card.tsx`
3. Verify Convex query: `grep "api.clips.list" src/components/library/clip-library.tsx`
4. Verify delete mutation: `grep "api.clips.remove" src/components/library/clip-library.tsx`
5. Verify navigation: `grep "clipId" src/components/library/clip-library.tsx`
6. Verify AlertDialog installed: `ls src/components/ui/alert-dialog.tsx`
  </verify>
  <done>
ClipCard renders Thumbnail preview with SSR guard, clip name, duration, and delete action with confirmation. ClipLibrary fetches clips via Convex query, renders responsive grid, handles loading/empty states, and wires open (navigate to /create?clipId=) and delete (mutation + toast) actions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Library page and wire clip loading into create page</name>
  <files>
    src/app/(app)/library/page.tsx
    src/app/(app)/create/create-page-client.tsx
  </files>
  <action>
**Step 1: Create `src/app/(app)/library/page.tsx`:**
This is a simple page component that renders the ClipLibrary component.

```typescript
import { ClipLibrary } from "@/components/library/clip-library";

export default function LibraryPage() {
  return (
    <div className="flex-1 flex flex-col p-6">
      <div className="max-w-6xl mx-auto w-full space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Library</h1>
          <p className="text-muted-foreground mt-1">
            Your saved clips and compositions
          </p>
        </div>
        <ClipLibrary />
      </div>
    </div>
  );
}
```

This follows the same structural pattern as the templates page (heading + content area, max-w-6xl centered).

**Step 2: Modify `src/app/(app)/create/create-page-client.tsx` to load clips from URL params:**

The server component (page.tsx) already passes `clipId` as a prop (from Plan 09-01). Now wire it in the client component.

Changes to `CreateContent` component:
1. Add `clipId?: string` to `CreateContentProps` interface (alongside `selectedTemplate`)
2. Pass `clipId` from `CreatePageClient` down to `CreateContent`
3. Add import: `import { useQuery } from "convex/react"` (if not already imported -- check, it may already have useAction/useMutation from convex/react but not useQuery)
4. Inside `CreateContent`, add clip loading:
   ```typescript
   // Load clip from URL param (when opening from library)
   const clipData = useQuery(
     api.clips.get,
     clipId ? { id: clipId as any } : "skip"
   );
   ```
   The `"skip"` value tells Convex to not run the query when clipId is undefined. (This is the standard Convex pattern for conditional queries.)

5. Add a `useEffect` to populate state when clip data loads:
   ```typescript
   // Load clip data into editor state when clip is fetched
   useEffect(() => {
     if (clipData && clipId) {
       setLastGeneration({
         id: clipData._id,
         rawCode: clipData.rawCode,
         code: clipData.code,
         durationInFrames: clipData.durationInFrames,
         fps: clipData.fps,
       });
       setLastPrompt(clipData.name);
       // Reset editing state for clean load
       setEditedCode(null);
       setIsEditing(false);
       setSkipValidation(true);
       setChatMessages([]);
     }
   }, [clipData, clipId]);
   ```

   Place this useEffect AFTER the existing `storeUser` useEffect and BEFORE the `handleGenerate` callback. It should only run when `clipData` changes (i.e., when the query resolves).

6. Update `CreatePageClient` to pass clipId through:
   ```typescript
   interface CreatePageClientProps {
     selectedTemplate: Template | null;
     clipId?: string;
   }

   export function CreatePageClient({ selectedTemplate, clipId }: CreatePageClientProps) {
     // ... existing wrapper code, but pass clipId to CreateContent:
     <Authenticated>
       <CreateContent selectedTemplate={selectedTemplate} clipId={clipId} />
     </Authenticated>
   }
   ```

**IMPORTANT:** The `clipId as any` cast is necessary because the URL param is a string but Convex expects `Id<"clips">`. Convex validates the ID format at runtime and will return null for invalid IDs. This is the standard pattern used throughout the codebase.

**IMPORTANT:** Do NOT add `clipId` to the useEffect dependency array's setter functions. The setters are stable references. The effect depends on `clipData` and `clipId` only.
  </action>
  <verify>
1. Run `npm run build` to verify build succeeds
2. Verify library page: `ls src/app/\(app\)/library/page.tsx`
3. Verify clip loading: `grep "api.clips.get" src/app/\(app\)/create/create-page-client.tsx`
4. Verify clipId prop: `grep "clipId" src/app/\(app\)/create/create-page-client.tsx`
5. Verify the useEffect for clip loading: `grep "clipData" src/app/\(app\)/create/create-page-client.tsx`
6. Navigate to /library in browser -- page renders (empty state if no clips)
7. Save a clip from /create, navigate to /library -- clip card appears with thumbnail
8. Click clip card -- navigates to /create?clipId=xxx, editor loads with clip's code
  </verify>
  <done>
Library page exists at /library showing a grid of saved clips with Thumbnail previews. Clicking a clip navigates to /create?clipId=xxx and loads the clip's code into the editor and preview. Delete confirmation works with AlertDialog. Empty state shows helpful message. Build succeeds.
  </done>
</task>

</tasks>

<verification>
Full end-to-end verification of all Phase 9 success criteria:

1. **Sidebar navigation (SC-1):** Visit /create, /library, /templates -- sidebar with 5 links is visible on all pages. Active state highlights correctly. Landing page (/) has no sidebar.

2. **Save clip (SC-2):** Generate an animation on /create. Click "Save as Clip". Enter a name. Click Save. Toast shows "Clip saved!". Verify in Convex dashboard that the clip exists with correct data.

3. **Library grid (SC-3):** Navigate to /library. Saved clip appears in the grid. Card shows Thumbnail preview (middle frame of animation) and clip name. Duration shown.

4. **Open clip (SC-4):** Click a clip card in the library. URL changes to /create?clipId=xxx. Editor loads with the clip's raw JSX code. Preview shows the clip's animation. User can edit and re-generate from this state.

5. **Delete clip (SC-5):** In the library, click the delete button on a clip card. Confirmation dialog appears. Click Delete. Clip is removed from the grid. Toast shows "Clip deleted".

Edge cases to verify:
- Empty library shows "No clips yet" with link to /create
- Saving a clip after editing code (not just generating) captures the edited version
- Opening a clip clears previous chat messages and editing state
- Invalid clipId in URL (/create?clipId=invalid) gracefully shows normal create page
</verification>

<success_criteria>
- /library page renders with clip grid or empty state
- Clip cards show Remotion Thumbnail preview at middle frame
- Clicking a clip navigates to /create?clipId=xxx and loads clip data
- Delete shows AlertDialog confirmation and removes clip on confirm
- Build succeeds with zero errors
- All 5 phase success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/09-app-shell-clip-library/09-03-SUMMARY.md`
</output>
