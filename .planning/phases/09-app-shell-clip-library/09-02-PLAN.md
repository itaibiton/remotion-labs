---
phase: 09-app-shell-clip-library
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - convex/schema.ts
  - convex/clips.ts
  - src/components/library/save-clip-dialog.tsx
  - src/app/(app)/create/create-page-client.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Save on the create page to open a save dialog"
    - "User can name the clip and save it to Convex"
    - "Saved clip stores code, rawCode, durationInFrames, fps, and name"
    - "Save button is only visible when a valid preview exists"
    - "Toast confirmation appears on successful save"
  artifacts:
    - path: "convex/schema.ts"
      provides: "clips table definition with userId, name, code, rawCode, durationInFrames, fps, timestamps"
      contains: "clips: defineTable"
    - path: "convex/clips.ts"
      provides: "Clips CRUD: save, list, get, remove mutations/queries"
      exports: ["save", "list", "get", "remove"]
    - path: "src/components/library/save-clip-dialog.tsx"
      provides: "Modal dialog for naming and saving a clip"
      exports: ["SaveClipDialog"]
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Create page with Save button wired to SaveClipDialog"
  key_links:
    - from: "convex/clips.ts"
      to: "convex/schema.ts"
      via: "clips table definition"
      pattern: "clips"
    - from: "src/components/library/save-clip-dialog.tsx"
      to: "convex/clips.ts"
      via: "useMutation(api.clips.save)"
      pattern: "api\\.clips\\.save"
    - from: "src/app/(app)/create/create-page-client.tsx"
      to: "src/components/library/save-clip-dialog.tsx"
      via: "import and render with current code state"
      pattern: "SaveClipDialog"
---

<objective>
Create the Convex clips backend (schema + CRUD) and wire a Save button on the create page that stores the current composition as a named clip.

Purpose: Users can persist their compositions. This is the data foundation for the library (Plan 09-03) and movies (Phase 10). Without this, all work is lost on navigation.
Output: clips table in Convex, save/list/get/remove operations, Save button on create page with naming dialog.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-app-shell-clip-library/09-RESEARCH.md
@.planning/phases/09-app-shell-clip-library/09-01-SUMMARY.md

Key existing files:
@convex/schema.ts (ADD clips table here)
@convex/generations.ts (FOLLOW this auth pattern exactly)
@src/app/(app)/create/create-page-client.tsx (ADD save button + dialog here -- after 09-01 migration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clips table to Convex schema and create clips CRUD</name>
  <files>
    convex/schema.ts
    convex/clips.ts
  </files>
  <action>
**Step 1: Update `convex/schema.ts`:**
Add a `clips` table to the existing `defineSchema` call. Place it after the `generations` table. Schema:
```
clips: defineTable({
  userId: v.string(),
  name: v.string(),
  code: v.string(),           // Transformed JS (for execution/preview)
  rawCode: v.string(),        // Original JSX (for editor display)
  durationInFrames: v.number(),
  fps: v.number(),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_user_updated", ["userId", "updatedAt"]),
```

Do NOT modify any existing table definitions (users, generations, renders).

**Step 2: Create `convex/clips.ts`:**
Follow the EXACT same auth pattern as `convex/generations.ts` (use `ctx.auth.getUserIdentity()`, check for null, use `identity.tokenIdentifier` as userId).

Create four operations:

1. **`save` (mutation):**
   - Args: `name: v.string(), code: v.string(), rawCode: v.string(), durationInFrames: v.number(), fps: v.number()`
   - Auth check: throw "Not authenticated" if no identity
   - Insert into "clips" table with `userId: identity.tokenIdentifier`, all args, plus `createdAt: Date.now()`, `updatedAt: Date.now()`
   - Return the inserted clip ID

2. **`list` (query):**
   - Args: none
   - Auth check: return empty array `[]` if no identity (graceful, not throw -- matches library page loading state)
   - Query "clips" with index "by_user_updated", filter by `userId === identity.tokenIdentifier`
   - Order "desc" (newest first), `.take(50)`
   - Return clips array

3. **`get` (query):**
   - Args: `id: v.id("clips")`
   - Fetch clip by ID with `ctx.db.get(args.id)`
   - Return clip or null (no auth check needed -- the clip data itself isn't secret enough to warrant it for an MVP, and the create page needs to load clips by ID from URL params)

4. **`remove` (mutation):**
   - Args: `id: v.id("clips")`
   - Auth check: throw "Not authenticated" if no identity
   - Fetch clip, verify `clip.userId === identity.tokenIdentifier` (ownership check)
   - Throw "Clip not found" if clip doesn't exist or user doesn't own it
   - Delete the clip with `ctx.db.delete(args.id)`

Import `v` from "convex/values", `mutation` and `query` from "./_generated/server".
  </action>
  <verify>
1. Run `npx convex dev` (or check that the Convex dev server picks up schema changes). The clips table should be created without errors.
2. Verify schema: `grep "clips: defineTable" convex/schema.ts`
3. Verify CRUD exports: `grep "export const" convex/clips.ts` should show save, list, get, remove
4. Verify auth pattern: `grep "getUserIdentity" convex/clips.ts` should appear in save, list, and remove
  </verify>
  <done>
clips table exists in Convex schema with correct fields and indexes. clips.ts exports save, list, get, remove operations with proper auth checks following the generations.ts pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SaveClipDialog and wire Save button into create page</name>
  <files>
    src/components/library/save-clip-dialog.tsx
    src/app/(app)/create/create-page-client.tsx
  </files>
  <action>
**Step 1: Add shadcn input component** (needed for the name field in the dialog):
Run `npx shadcn@latest add input` to add the Input component. If it already exists, skip.

**Step 2: Create `src/components/library/save-clip-dialog.tsx`:**
Client component ("use client"). This is a modal dialog for naming and saving a clip.

Props interface `SaveClipDialogProps`:
- `open: boolean` -- controls dialog visibility
- `onOpenChange: (open: boolean) => void` -- close handler
- `rawCode: string` -- original JSX from editor
- `code: string` -- transformed JS for execution
- `durationInFrames: number`
- `fps: number`
- `defaultName: string` -- pre-filled name (from last prompt, truncated to 50 chars)

Component implementation:
- Local state: `name` (string, initialized from `defaultName`), `isSaving` (boolean)
- Use `useMutation(api.clips.save)` from "convex/react"
- Import `api` from the convex `_generated/api` path (use relative path: `"../../../convex/_generated/api"` -- adjust based on actual file location)
- On save: validate name is not empty, call `saveClip({ name: name.trim(), code, rawCode, durationInFrames, fps })`, show success toast via `sonner`, close dialog
- On error: show error toast
- UI structure using existing shadcn Dialog (already installed):
  - `<Dialog>` with `open` and `onOpenChange` props
  - `<DialogContent>` > `<DialogHeader>` > `<DialogTitle>Save as Clip</DialogTitle>`
  - Body: label "Clip Name" + `<Input>` (from shadcn) for name, with placeholder "My Animation", autoFocus
  - `<DialogFooter>`: Cancel button (variant="outline", closes dialog) + Save button (disabled while saving or name empty)
- Reset `name` to `defaultName` when dialog opens (use `useEffect` on `open` changing to true)

**Step 3: Modify `src/app/(app)/create/create-page-client.tsx`:**
Add the Save button and SaveClipDialog to the `CreateContent` component.

Changes to `CreateContent`:
1. Add import for `SaveClipDialog` from "@/components/library/save-clip-dialog"
2. Add import for `Save` icon from "lucide-react"
3. Add state: `const [showSaveDialog, setShowSaveDialog] = useState(false);`
4. In the render controls area (the `<div className="mt-4 p-4 bg-muted/50 rounded-lg space-y-4">` section), add a Save button BEFORE the export controls section:
   ```tsx
   {/* Save clip */}
   <div className="pt-2 border-t">
     <div className="flex items-center justify-between">
       <p className="text-sm text-muted-foreground">
         Save this composition to your library
       </p>
       <Button
         variant="outline"
         size="sm"
         onClick={() => setShowSaveDialog(true)}
       >
         <Save className="h-4 w-4 mr-2" />
         Save as Clip
       </Button>
     </div>
   </div>
   ```
5. Add the SaveClipDialog component at the end of the CreateContent JSX (inside the fragment, after the PromptInput):
   ```tsx
   <SaveClipDialog
     open={showSaveDialog}
     onOpenChange={setShowSaveDialog}
     rawCode={editorCode}
     code={previewCode}
     durationInFrames={lastGeneration?.durationInFrames ?? 90}
     fps={lastGeneration?.fps ?? 30}
     defaultName={lastPrompt.slice(0, 50) || "Untitled Clip"}
   />
   ```

**CRITICAL:** The save captures `editorCode` (which is `editedCode ?? lastGeneration?.rawCode`) as rawCode and `previewCode` (which is `validation.transformedCode ?? lastGeneration?.code`) as code. This ensures the saved clip matches what the user sees in editor and preview.

Also import `Button` from "@/components/ui/button" if not already imported in CreateContent. (Check -- it may only be used in child components. If needed, add the import.)
  </action>
  <verify>
1. Run `npm run build` (or `npx next build`) to verify build succeeds
2. Verify dialog component: `grep "SaveClipDialog" src/components/library/save-clip-dialog.tsx`
3. Verify integration: `grep "SaveClipDialog" src/app/\(app\)/create/create-page-client.tsx`
4. Verify save button: `grep "Save as Clip" src/app/\(app\)/create/create-page-client.tsx`
5. Verify correct code capture: `grep "editorCode" src/app/\(app\)/create/create-page-client.tsx` should show rawCode={editorCode}
6. Verify Input component exists: `ls src/components/ui/input.tsx`
  </verify>
  <done>
SaveClipDialog component exists with name input, save/cancel buttons, and Convex mutation call. Create page shows "Save as Clip" button in the render controls area (visible only when a generation exists). Clicking it opens the dialog, naming the clip saves it to Convex with correct code state, and a success toast appears.
  </done>
</task>

</tasks>

<verification>
1. On the create page, generate an animation
2. "Save as Clip" button appears in the controls area below the preview
3. Click "Save as Clip" -- dialog opens with name pre-filled from prompt
4. Type a name and click Save -- toast shows "Clip saved!", dialog closes
5. Verify in Convex dashboard: clips table has a new row with correct userId, name, code, rawCode, durationInFrames, fps
6. Edit code in Monaco editor, then save again -- the saved clip's rawCode should match the edited version, not the original generation
</verification>

<success_criteria>
- clips table exists in Convex with all required fields and indexes
- clips.ts has save, list, get, remove operations with auth
- Save button appears on create page when a generation exists
- Clicking Save opens dialog with name field
- Submitting saves clip to Convex with correct code state
- Success toast appears after save
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-app-shell-clip-library/09-02-SUMMARY.md`
</output>
