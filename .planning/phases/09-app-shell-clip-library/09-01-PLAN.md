---
phase: 09-app-shell-clip-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/layout.tsx
  - src/components/shell/sidebar.tsx
  - src/components/shell/app-header.tsx
  - src/app/(app)/create/page.tsx
  - src/app/(app)/create/create-page-client.tsx
  - src/app/(app)/templates/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a persistent sidebar with navigation links (Home, Create, Library, Templates) on the create page"
    - "User sees a persistent sidebar on the templates page"
    - "User sees a shared header with logo and user menu on all authenticated pages"
    - "Landing page (/) has NO sidebar -- it remains a standalone marketing page"
    - "Existing create page functionality (generation, preview, editing, export) works identically after migration"
    - "Existing templates page functionality works identically after migration"
    - "URLs /create and /templates remain unchanged (route group is transparent)"
  artifacts:
    - path: "src/app/(app)/layout.tsx"
      provides: "App shell layout wrapping sidebar + header + content area"
      min_lines: 15
    - path: "src/components/shell/sidebar.tsx"
      provides: "Client-side sidebar with navigation links and active state highlighting"
      exports: ["Sidebar"]
    - path: "src/components/shell/app-header.tsx"
      provides: "Shared header with logo link and UserMenu"
      exports: ["AppHeader"]
    - path: "src/app/(app)/create/page.tsx"
      provides: "Create page server component (moved from src/app/create/)"
    - path: "src/app/(app)/create/create-page-client.tsx"
      provides: "Create page client component (header removed, content preserved)"
    - path: "src/app/(app)/templates/page.tsx"
      provides: "Templates page (header removed, content preserved)"
  key_links:
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/shell/sidebar.tsx"
      via: "import and render"
      pattern: "import.*Sidebar.*from.*shell/sidebar"
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/shell/app-header.tsx"
      via: "import and render"
      pattern: "import.*AppHeader.*from.*shell/app-header"
    - from: "src/components/shell/sidebar.tsx"
      to: "next/navigation"
      via: "usePathname for active link highlighting"
      pattern: "usePathname"
---

<objective>
Create the app shell with persistent sidebar navigation and migrate existing pages into the (app) route group.

Purpose: Establishes the persistent navigation foundation (sidebar + header) that all authenticated pages share. This is the structural prerequisite for the Library page and all future v2.0 pages.
Output: Working app shell with sidebar navigation visible on /create and /templates. Landing page unchanged.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-app-shell-clip-library/09-RESEARCH.md

Key existing files to reference:
@src/app/layout.tsx (root layout -- DO NOT MODIFY, Providers stay here)
@src/app/page.tsx (landing page -- stays outside route group)
@src/app/create/page.tsx (server component -- MOVE to (app)/create/)
@src/app/create/create-page-client.tsx (client component -- MOVE and MODIFY)
@src/app/templates/page.tsx (MOVE and MODIFY)
@src/components/auth/user-menu.tsx (reused by AppHeader)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create app shell components (Sidebar + AppHeader)</name>
  <files>
    src/components/shell/sidebar.tsx
    src/components/shell/app-header.tsx
  </files>
  <action>
Create two new components in `src/components/shell/`:

**sidebar.tsx** -- Client component ("use client"):
- Import `Link` from "next/link", `usePathname` from "next/navigation"
- Import icons from "lucide-react": `Home`, `Plus`, `Library`, `Palette` (and `Film` for the Movie link placeholder -- include it now so it's ready for Phase 10)
- Define `navItems` array with objects: `{ href, label, icon }` for:
  - Home: href="/", icon=Home
  - Create: href="/create", icon=Plus
  - Library: href="/library", icon=Library
  - Movie: href="/movie", icon=Film
  - Templates: href="/templates", icon=Palette
- Render `<aside>` with className "w-56 border-r bg-muted/30 flex flex-col p-4"
- Map `navItems` to `<Link>` elements with:
  - Active state detection: `pathname === item.href || (item.href !== "/" && pathname.startsWith(item.href))`
  - Active class: "bg-primary/10 text-primary"
  - Inactive class: "text-muted-foreground hover:text-foreground hover:bg-muted"
  - Each link: "flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors"
  - Use `cn()` utility from "@/lib/utils" for conditional classnames

**app-header.tsx** -- Client component ("use client"):
- Import `Link` from "next/link", `UserMenu` from "@/components/auth/user-menu"
- Render `<header>` with className "flex items-center justify-between px-6 py-3 border-b bg-background"
- Left side: `<Link href="/">` with "text-xl font-bold" containing "RemotionLab"
- Right side: `<UserMenu />`

This replaces the per-page headers currently in create-page-client.tsx and templates/page.tsx.
  </action>
  <verify>
Check that both files exist and export their components:
- `grep "export function Sidebar" src/components/shell/sidebar.tsx`
- `grep "export function AppHeader" src/components/shell/app-header.tsx`
- `grep "usePathname" src/components/shell/sidebar.tsx` (active state detection is present)
- `grep "UserMenu" src/components/shell/app-header.tsx` (user menu is included)
  </verify>
  <done>
Sidebar component exists with 5 nav items (Home, Create, Library, Movie, Templates), active state detection via usePathname, and proper styling. AppHeader component exists with logo link and UserMenu.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create (app) route group layout and migrate pages</name>
  <files>
    src/app/(app)/layout.tsx
    src/app/(app)/create/page.tsx
    src/app/(app)/create/create-page-client.tsx
    src/app/(app)/templates/page.tsx
  </files>
  <action>
This task creates the route group layout and moves existing pages into it. The landing page (`src/app/page.tsx`) stays where it is.

**Step 1: Create `src/app/(app)/layout.tsx`** -- Server component:
- Import `Sidebar` from "@/components/shell/sidebar"
- Import `AppHeader` from "@/components/shell/app-header"
- Export default function `AppLayout({ children })` returning:
  ```
  <div className="h-screen flex flex-col">
    <AppHeader />
    <div className="flex-1 flex overflow-hidden">
      <Sidebar />
      <main className="flex-1 overflow-y-auto">
        {children}
      </main>
    </div>
  </div>
  ```
- This layout nests INSIDE the root layout.tsx (which provides Providers). Do NOT touch the root layout.

**Step 2: Move and modify create page files:**
- Copy `src/app/create/page.tsx` to `src/app/(app)/create/page.tsx`. Update it to also accept a `clipId` search param (needed for Plan 09-03):
  ```typescript
  export default async function CreatePage({
    searchParams,
  }: {
    searchParams: Promise<{ template?: string; clipId?: string }>;
  }) {
    const params = await searchParams;
    const templateId = params.template;
    const selectedTemplate = templateId ? getTemplateById(templateId) ?? null : null;
    return <CreatePageClient selectedTemplate={selectedTemplate} clipId={params.clipId} />;
  }
  ```
- Copy `src/app/create/create-page-client.tsx` to `src/app/(app)/create/create-page-client.tsx`. Modify it:
  - REMOVE the `<header>` block (lines ~398-403 in CreatePageClient: the `<header>` with Link to "/" and UserMenu). The app shell provides this now.
  - REMOVE the `<main className="min-h-screen flex flex-col">` wrapper from CreatePageClient. Replace with just `<div className="flex-1 flex flex-col">` (no min-h-screen since the app shell handles full height).
  - REMOVE the `import { UserMenu }` and `import Link from "next/link"` if they are no longer used after header removal. (Link is still used in the template context banner, so keep it. UserMenu import can be removed.)
  - Add `clipId?: string` to `CreatePageClientProps` interface (the prop is accepted but not yet used -- Plan 09-03 will wire it).
  - Keep ALL other functionality (generation, preview, editing, chat, export) exactly as-is.

**Step 3: Move and modify templates page:**
- Copy `src/app/templates/page.tsx` to `src/app/(app)/templates/page.tsx`. Modify it:
  - REMOVE the `"use client"` directive (it will still work because TemplateGallery is already a client component).
  - REMOVE the `<main>` wrapper with `min-h-screen`.
  - REMOVE the `<header>` block entirely (Link to "/" and UserMenu).
  - REMOVE imports for `Link` and `UserMenu` (no longer needed).
  - Keep the content area: the page title, description, TemplateGallery, and "Start from scratch" link. Wrap in a plain `<div>` with appropriate padding.

**Step 4: Delete the OLD page files:**
- Delete `src/app/create/page.tsx`
- Delete `src/app/create/create-page-client.tsx`
- Delete `src/app/templates/page.tsx`
- Remove the now-empty `src/app/create/` and `src/app/templates/` directories.

**CRITICAL: Do NOT modify:**
- `src/app/layout.tsx` (root layout with Providers and Toaster)
- `src/app/page.tsx` (landing page stays outside route group, keeps its own header)
  </action>
  <verify>
1. Run `npx next build` (or `npm run build`) to verify the build succeeds with the new route structure.
2. Verify old files are gone: `ls src/app/create/ 2>&1` should show "No such file or directory"
3. Verify new files exist: `ls src/app/\(app\)/create/page.tsx src/app/\(app\)/create/create-page-client.tsx src/app/\(app\)/templates/page.tsx src/app/\(app\)/layout.tsx`
4. Verify no duplicate headers: `grep -r "UserMenu" src/app/\(app\)/create/create-page-client.tsx` should return nothing (header removed)
5. Verify no duplicate headers: `grep "header" src/app/\(app\)/templates/page.tsx` should return nothing
6. Verify root layout untouched: `grep "Providers" src/app/layout.tsx` should still show Providers wrapper
7. Verify landing page untouched: `grep "min-h-screen" src/app/page.tsx` should still show landing page structure
  </verify>
  <done>
The (app) route group exists with layout.tsx providing sidebar + header. Create page and templates page live inside (app)/ with per-page headers removed. Old page locations are deleted. Landing page is unaffected. URLs /create and /templates work unchanged. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/create` in browser -- sidebar is visible on the left with 5 links, header at top with logo and user menu
2. Navigate to `/templates` -- same sidebar and header appear
3. Navigate to `/` -- NO sidebar, landing page looks exactly as before
4. Click sidebar links -- active state highlights correctly for current page
5. Generate an animation on /create -- full flow works (prompt, generation, preview, edit, export)
6. Browse templates on /templates -- gallery works, clicking "Use this template" navigates to /create with template param
</verification>

<success_criteria>
- App shell layout renders sidebar + header on /create and /templates
- Sidebar shows 5 navigation links with active state highlighting
- Landing page (/) has NO sidebar
- All existing create page functionality works: generate, preview, edit, chat, export
- Templates page works: gallery, template selection
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-app-shell-clip-library/09-01-SUMMARY.md`
</output>
