---
phase: 24-route-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/generations.ts
  - src/components/generation/generation-row.tsx
  - src/components/generation/generation-feed.tsx
  - src/app/(app)/create/create-page-client.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a creation in the feed navigates to /create/[id] and URL updates"
    - "Sidebar remains visible when the modal is open"
    - "Refreshing the page at /create/[id] loads the creation detail (not 404)"
    - "Bookmarking and sharing /create/[id] URLs works correctly"
  artifacts:
    - path: "convex/generations.ts"
      provides: "listByParent query for variation children"
      contains: "listByParent"
    - path: "src/components/generation/generation-row.tsx"
      provides: "Link-based navigation to /create/[id]"
      contains: "href={`/create/${generation._id}`}"
    - path: "src/app/(app)/@modal/(.)create/[id]/page.tsx"
      provides: "Intercepting route for soft navigation"
    - path: "src/app/(app)/create/[id]/page.tsx"
      provides: "Full-page fallback for hard navigation"
  key_links:
    - from: "src/components/generation/generation-row.tsx"
      to: "/create/[id] route"
      via: "Next.js Link component with scroll={false}"
      pattern: 'href={`/create/'
    - from: "src/app/(app)/@modal/(.)create/[id]/page.tsx"
      to: "CreationModal component"
      via: "import and render"
      pattern: '<CreationModal'
---

<objective>
Wire the generation feed to use Link-based navigation to `/create/[id]` and add the missing listByParent query for variation support.

Purpose: Complete the route infrastructure so clicking a creation opens the modal while preserving feed context and URL shareability.

Output: Feed cards navigate via Link, listByParent query exists, all 4 success criteria pass.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-route-infrastructure/24-RESEARCH.md
@src/app/(app)/@modal/default.tsx
@src/app/(app)/@modal/(.)create/[id]/page.tsx
@src/app/(app)/create/[id]/page.tsx
@src/components/creation/creation-modal.tsx
@convex/generations.ts
@src/components/generation/generation-row.tsx
@src/components/generation/generation-feed.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add listByParent query to generations</name>
  <files>convex/generations.ts</files>
  <action>
Add a new query `listByParent` to `convex/generations.ts` that returns all generations with a given `parentGenerationId`.

The query should:
1. Accept `parentId: v.id("generations")` as argument
2. Query generations table filtering by `parentGenerationId` field
3. Order by `createdAt` descending (newest first)
4. Take max 20 results (pagination limit for memory safety)
5. Require authentication (match pattern of other queries)

NOTE: The `parentGenerationId` field and `by_parent` index will be added in Phase 27. For now, create the query with a filter-based approach that will work once the field exists. The query should gracefully return an empty array if no generations have the field set yet.

```typescript
export const listByParent = query({
  args: {
    parentId: v.id("generations"),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Must be logged in to view variations");
    }

    // Filter by parentGenerationId (field added in Phase 27)
    // For now, returns empty until schema is updated
    const generations = await ctx.db
      .query("generations")
      .filter((q) => q.eq(q.field("parentGenerationId"), args.parentId))
      .order("desc")
      .take(20);

    return generations;
  },
});
```
  </action>
  <verify>
Run `npx convex dev` and check that:
1. No TypeScript errors in generations.ts
2. The query is registered and available in `api.generations.listByParent`
  </verify>
  <done>
`listByParent` query exists and compiles without errors. Returns empty array until Phase 27 adds the field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire GenerationRow to use Link navigation</name>
  <files>
src/components/generation/generation-row.tsx
src/components/generation/generation-feed.tsx
src/app/(app)/create/create-page-client.tsx
  </files>
  <action>
Convert the GenerationRow component from callback-based selection to Link-based navigation.

**In generation-row.tsx:**

1. Import `Link` from "next/link"

2. Remove `onSelect` from props interface (no longer needed)

3. Wrap the thumbnail/card area with a Next.js Link:
   - Use `href={`/create/${generation._id}`}` for the route
   - Add `scroll={false}` to preserve scroll position
   - Move click handling to the Link
   - Keep action buttons click handlers with `e.stopPropagation()` and `e.preventDefault()` so they don't trigger navigation

4. The row structure should be:
```tsx
<Link
  href={`/create/${generation._id}`}
  scroll={false}
  className={`group relative w-full overflow-hidden block ${isDeleting ? "animate-pulse opacity-60 pointer-events-none" : ""} ${isDeleting || isPending ? "pointer-events-none" : ""}`}
  style={{ aspectRatio: `${preset.width} / ${preset.height}` }}
>
  {/* Thumbnail content */}
  {/* Hover overlay with actions */}
</Link>
```

**In generation-feed.tsx:**

1. Remove `onSelectGeneration` from props interface
2. Remove the prop from GenerationRow usage
3. Keep all other action handlers (onSave, onDelete, etc.)

**In create-page-client.tsx:**

1. Remove `handleSelectGeneration` callback function
2. Remove `onSelectGeneration` prop from GenerationFeed component
3. Keep all other handlers and state (the preview panel and editor will be removed in a future phase - for now they can stay as legacy code that shows when a clip is loaded via URL params)
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify no TypeScript errors
2. Start dev server with `npm run dev`
3. Click a generation card in the feed - should navigate to `/create/[id]` and open modal
4. URL should update to `/create/[id]`
5. Sidebar should remain visible behind the modal
  </verify>
  <done>
Clicking a generation card navigates to `/create/[id]`, URL updates, modal opens, and sidebar remains visible.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all success criteria</name>
  <files>None (verification only)</files>
  <action>
Manually test all 4 success criteria from the phase definition:

1. **Soft navigation (NAV-01):**
   - Go to `/create`
   - Click any generation card
   - Verify URL changes to `/create/[id]`
   - Verify modal opens with generation details
   - Verify sidebar is still visible

2. **Sidebar visibility:**
   - With modal open, verify sidebar navigation links are visible
   - Click a sidebar link (e.g., Library) - should close modal and navigate

3. **Hard navigation (NAV-02):**
   - Copy the `/create/[id]` URL from browser
   - Open a new tab and paste the URL
   - Verify the page loads (not 404)
   - Verify it shows the full-page creation detail (not modal)
   - Verify back button works

4. **Bookmark/share:**
   - Bookmark a `/create/[id]` URL
   - Open the bookmark
   - Verify it loads correctly
   - Try sharing the URL (open in incognito) - should show auth wall or the generation

If any test fails, fix the issue before marking complete.
  </action>
  <verify>
All 4 success criteria pass:
- [x] Clicking a creation navigates to `/create/[id]` and URL updates
- [x] Sidebar remains visible when modal is open
- [x] Refreshing `/create/[id]` loads the creation (not 404)
- [x] Bookmarking and sharing URLs works
  </verify>
  <done>
All Phase 24 success criteria verified and passing.
  </done>
</task>

</tasks>

<verification>
**Route infrastructure verification:**

1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Convex dev server starts: `npx convex dev`
3. Next.js dev server starts: `npm run dev`
4. Click generation card -> URL updates to `/create/[id]`
5. Modal opens with preview player and details
6. Sidebar visible behind modal
7. Press Escape -> modal closes, URL returns to `/create`
8. Hard refresh on `/create/[id]` -> full page loads (not 404)
9. Arrow keys navigate between generations in modal
</verification>

<success_criteria>
Phase 24 is complete when:
1. Generation feed cards use Link navigation to `/create/[id]`
2. Soft navigation opens modal while preserving sidebar
3. Hard navigation shows full-page fallback
4. URLs are bookmarkable and shareable
5. No TypeScript errors
6. All existing functionality preserved (feed actions, generation, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/24-route-infrastructure/24-01-SUMMARY.md`
</output>
