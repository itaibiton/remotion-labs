---
phase: 02-generation-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/generations.ts
  - convex/generateAnimation.ts
  - convex/lib/validation.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for animation generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API keys -> Create key"
    account_setup:
      - task: "Create Anthropic account"
        location: "https://console.anthropic.com"

must_haves:
  truths:
    - "Convex action calls Claude API successfully"
    - "Generated animation props are validated before storage"
    - "Generations are stored with user association"
  artifacts:
    - path: "convex/schema.ts"
      provides: "generations table definition"
      contains: "generations: defineTable"
    - path: "convex/generateAnimation.ts"
      provides: "Claude API action"
      exports: ["generate"]
    - path: "convex/generations.ts"
      provides: "Generation CRUD mutations"
      exports: ["store", "list"]
    - path: "convex/lib/validation.ts"
      provides: "Zod schemas for animation props"
      exports: ["textAnimationSchema"]
  key_links:
    - from: "convex/generateAnimation.ts"
      to: "convex/generations.ts"
      via: "ctx.runMutation for storage"
      pattern: "ctx\\.runMutation.*generations\\.store"
    - from: "convex/generateAnimation.ts"
      to: "convex/lib/validation.ts"
      via: "Zod validation"
      pattern: "textAnimationSchema\\.safeParse"
---

<objective>
Create the Convex backend for animation generation: database schema, Claude API action, and storage mutations.

Purpose: Establishes the backend foundation for the generation pipeline. Claude API calls and data storage must work before the frontend can be wired up.

Output: Working Convex functions that can generate text animations via Claude API and store validated results in the database.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-generation-pipeline/02-RESEARCH.md
@.planning/phases/02-generation-pipeline/02-CONTEXT.md
@convex/schema.ts
@convex/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generations table and validation schemas</name>
  <files>
    convex/schema.ts
    convex/lib/validation.ts
  </files>
  <action>
1. Update convex/schema.ts to add generations table:
   - userId: v.string() (tokenIdentifier from Clerk)
   - prompt: v.string()
   - animationProps: v.object with text, style, fontSize, color, backgroundColor (optional), durationInFrames, fps
   - status: v.union(v.literal("success"), v.literal("failed"))
   - errorMessage: v.optional(v.string())
   - createdAt: v.number()
   - Add indexes: by_user (userId), by_user_created (userId, createdAt)

2. Create convex/lib/validation.ts with Zod schemas:
   - textAnimationSchema: text (string 1-500), style (enum: fade-in, typewriter, slide-up, scale), fontFamily (string, default Inter), fontSize (12-200, default 48), color (hex format), backgroundColor (optional hex), durationInFrames (30-600, default 90), fps (literal 30)
   - Export type TextAnimationProps = z.infer<typeof textAnimationSchema>

Note: Create convex/lib/ directory if it doesn't exist.
  </action>
  <verify>
Run `npx convex dev` - schema should sync without errors, no type errors in validation.ts
  </verify>
  <done>
Generations table defined in schema with proper indexes. Zod validation schema ready for use in action.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create generation mutations</name>
  <files>
    convex/generations.ts
  </files>
  <action>
Create convex/generations.ts with these functions:

1. Internal mutation `store` (used by action):
   - Args: userId (string), prompt (string), animationProps (object matching schema), status (union), errorMessage (optional string), createdAt (number)
   - Insert into generations table
   - Return the generated ID

2. Query `list` (for future history feature):
   - Takes no args (uses authenticated user)
   - Get user identity, throw if not authenticated
   - Query generations by userId, ordered by createdAt descending
   - Limit to 50 most recent

3. Query `get` (for retrieving single generation):
   - Args: id (Id<"generations">)
   - Return the generation document

Mark `store` as internal mutation (import from ./_generated/server for internalMutation).
  </action>
  <verify>
TypeScript compiles without errors. `npx convex dev` syncs functions.
  </verify>
  <done>
Generations CRUD functions ready. Store mutation internal-only, list/get queries public with auth check.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Claude API generation action</name>
  <files>
    convex/generateAnimation.ts
  </files>
  <action>
Create convex/generateAnimation.ts as a Node.js action:

1. Add "use node"; at top (required for external API calls)

2. Import: action from ./_generated/server, v from convex/values, Anthropic from @anthropic-ai/sdk, internal from ./_generated/api, textAnimationSchema from ./lib/validation

3. Create SYSTEM_PROMPT constant:
   - Instruct Claude to output ONLY valid JSON matching the textAnimationSchema
   - List available animation styles with descriptions:
     - fade-in: Opacity 0 to 1 over duration
     - typewriter: Text appears character by character
     - slide-up: Text slides up from below
     - scale: Text scales from 0 to 1
   - Rules: JSON only (no markdown), hex colors (#RRGGBB), durationInFrames 60-180 typical, choose style based on prompt mood
   - Include example output

4. Export `generate` action:
   - Args: prompt (v.string())
   - Check auth: await ctx.auth.getUserIdentity(), throw "You must be logged in to generate animations" if null
   - Validate input: if prompt.length > 2000, throw "Prompt too long. Please use 2000 characters or less."
   - Create Anthropic client with process.env.ANTHROPIC_API_KEY
   - Call client.messages.create:
     - model: "claude-sonnet-4-5-20250929"
     - max_tokens: 4096
     - system: SYSTEM_PROMPT
     - messages: [{ role: "user", content: prompt }]
   - Extract text content from response
   - Parse JSON with try/catch, throw user-friendly error on parse failure
   - Validate with textAnimationSchema.safeParse(), throw specific error on validation failure
   - Store via ctx.runMutation(internal.generations.store, { userId: identity.tokenIdentifier, prompt, animationProps: result.data, status: "success", createdAt: Date.now() })
   - Return { id: generationId, animationProps: result.data }

5. Install @anthropic-ai/sdk: `npm install @anthropic-ai/sdk`
  </action>
  <verify>
`npm run build` (or `npx convex dev`) succeeds. Action appears in Convex dashboard functions list.
Manual test requires ANTHROPIC_API_KEY to be set.
  </verify>
  <done>
Generation action complete. Claude API integration with Zod validation and database storage. Ready for frontend integration.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. Schema shows generations table with correct fields and indexes
3. Functions appear in Convex dashboard: generateAnimation.generate (action), generations.store (internal), generations.list (query), generations.get (query)
4. TypeScript has no errors across all convex files
</verification>

<success_criteria>
- Convex schema includes generations table with indexes
- Zod validation schema exports textAnimationSchema and TextAnimationProps
- generateAnimation action is a Node.js action with Claude API integration
- generations.store is an internal mutation
- All functions compile and sync to Convex
</success_criteria>

<output>
After completion, create `.planning/phases/02-generation-pipeline/02-01-SUMMARY.md`
</output>
