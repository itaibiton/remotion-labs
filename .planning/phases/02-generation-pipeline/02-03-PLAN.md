---
phase: 02-generation-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/create/page.tsx
  - src/components/ui/sonner.tsx
  - src/app/layout.tsx
autonomous: false

must_haves:
  truths:
    - "User can type prompt and click Generate"
    - "Progress steps show during generation"
    - "Successful generation stores in database"
    - "Failed generation shows error with retry"
    - "Toast notifications appear for feedback"
  artifacts:
    - path: "src/app/create/page.tsx"
      provides: "Complete generation flow"
      min_lines: 100
    - path: "src/components/ui/sonner.tsx"
      provides: "Toast notification provider"
  key_links:
    - from: "src/app/create/page.tsx"
      to: "convex/generateAnimation.ts"
      via: "useAction hook"
      pattern: "useAction.*generateAnimation"
    - from: "src/app/create/page.tsx"
      to: "src/components/generation/prompt-input.tsx"
      via: "component import and onSubmit prop"
      pattern: "PromptInput.*onSubmit"
    - from: "src/app/create/page.tsx"
      to: "src/components/generation/generation-status.tsx"
      via: "conditional rendering during generation"
      pattern: "GenerationStatus.*currentStep"
    - from: "src/app/create/page.tsx"
      to: "src/components/generation/error-display.tsx"
      via: "conditional rendering on error"
      pattern: "ErrorDisplay.*error"
---

<objective>
Integrate all generation components into the create page with full flow: prompt input, generation via Convex action, progress feedback, error handling with retry, and toast notifications.

Purpose: This is the integration plan that wires frontend components to the backend action. Requires both backend (02-01) and components (02-02) to be complete.

Output: Working generation flow where users can enter prompts, see progress, and receive results or errors with retry capability.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-generation-pipeline/02-RESEARCH.md
@.planning/phases/02-generation-pipeline/02-CONTEXT.md
@.planning/phases/02-generation-pipeline/02-01-SUMMARY.md
@.planning/phases/02-generation-pipeline/02-02-SUMMARY.md
@src/app/create/page.tsx
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toast notification system</name>
  <files>
    src/components/ui/sonner.tsx
    src/app/layout.tsx
  </files>
  <action>
1. Install sonner: `npm install sonner`

2. Create src/components/ui/sonner.tsx:
   - "use client" directive
   - Import { Toaster as SonnerToaster } from "sonner"
   - Export Toaster component that renders SonnerToaster with:
     - position="top-center"
     - richColors (for success/error styling)
     - closeButton

3. Update src/app/layout.tsx:
   - Import Toaster from @/components/ui/sonner
   - Add <Toaster /> inside the Providers component, after {children}
   - Place it as a sibling to children, not wrapping it
  </action>
  <verify>
Toast can be triggered from any page. `npm run dev` shows no errors.
  </verify>
  <done>
Toast notification system available app-wide via sonner.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire up generation flow in create page</name>
  <files>
    src/app/create/page.tsx
  </files>
  <action>
Rewrite src/app/create/page.tsx to integrate the generation flow:

1. Imports:
   - "use client"
   - React: useState, useCallback
   - Convex: useAction, useMutation from "convex/react"
   - Convex: Authenticated, Unauthenticated, AuthLoading from "convex/react"
   - API: api from convex/_generated/api
   - Components: UserMenu, PromptInput, GenerationStatus, ErrorDisplay
   - Next: Link
   - Sonner: toast

2. Define generation step type: "analyzing" | "generating" | "validating" | null

3. CreateContent component state:
   - isGenerating: boolean (false)
   - currentStep: step type (null)
   - error: { message: string, retryCount: number } | null
   - lastGeneration: { id: string, animationProps: object } | null

4. Hooks:
   - const storeUser = useMutation(api.users.storeUser)
   - const generate = useAction(api.generateAnimation.generate)
   - useEffect for storeUser on mount (keep existing behavior)

5. handleGenerate function (async, takes prompt: string):
   - Reset error to null
   - Set isGenerating true
   - Step through: setCurrentStep("analyzing") -> wait 500ms -> setCurrentStep("generating")
   - try:
     - const result = await generate({ prompt })
     - setCurrentStep("validating") -> wait 300ms
     - setLastGeneration(result)
     - toast.success("Animation generated successfully!")
   - catch (e):
     - setError({ message: e.message || "Generation failed", retryCount: (error?.retryCount ?? 0) + 1 })
     - toast.error("Generation failed")
   - finally:
     - setIsGenerating(false)
     - setCurrentStep(null)

6. handleRetry function:
   - Call handleGenerate with preserved prompt (need to store prompt in state or get from ref)
   - Note: Store lastPrompt in state alongside error

7. JSX structure for CreateContent:
   - Container: flex-1 flex flex-col items-center justify-center p-6
   - If error AND not generating: show ErrorDisplay with onRetry={handleRetry}
   - Else if isGenerating: show GenerationStatus with currentStep
   - Else if lastGeneration:
     - Success message: "Animation generated!"
     - Show animation props summary (text, style, duration)
     - "Regenerate" button (calls handleGenerate with last prompt)
     - Placeholder text: "Preview will be available in Phase 3"
   - Always show PromptInput (below success/error) unless generating:
     - onSubmit={handleGenerate}
     - isGenerating={isGenerating}
     - disabled={false}

8. Keep existing page structure:
   - Header with RemotionLab logo and UserMenu
   - AuthLoading/Unauthenticated/Authenticated guards
   - CreateContent inside Authenticated
  </action>
  <verify>
`npm run dev` - page loads, prompt input visible, can type text. Generation attempt shows progress steps (will fail without API key, which is expected).
  </verify>
  <done>
Create page fully integrated with generation flow, progress feedback, error handling, and retry capability.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete generation pipeline: prompt input, Claude API generation, validation, storage, progress feedback, error handling with retry, and toast notifications.
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Ensure ANTHROPIC_API_KEY is set in Convex Dashboard -> Settings -> Environment Variables
2. Run `npm run dev` and `npx convex dev` in separate terminals

**Test the generation flow:**
1. Navigate to http://localhost:3000 (or current port)
2. Sign in if not already authenticated
3. Click "Create" or navigate to /create
4. Verify prompt input is visible with:
   - Placeholder text in textarea
   - Character count (should show 0/2000)
   - Example prompts below textarea
   - "Generate Animation" button (disabled when empty)

5. Click an example prompt - verify it fills the textarea
6. Type additional text - verify character count updates
7. Click "Generate Animation"
8. Verify progress steps appear: "Analyzing prompt..." -> "Generating animation..." -> "Validating..."
9. Wait for generation to complete (10-30 seconds)

**Success case:**
- Toast notification: "Animation generated successfully!"
- Animation props displayed (text, style, duration)
- "Regenerate" button visible
- "Preview will be available in Phase 3" message

**Error case (if generation fails):**
- Toast notification: "Generation failed"
- Error display with message and "Try Again" button
- Retry count shown
- After 3 retries, suggestion to simplify prompt

**Verify database storage:**
1. Open Convex Dashboard -> Data -> generations table
2. Confirm new record exists with prompt, animationProps, status, userId, createdAt

**Edge cases to check:**
- Empty prompt cannot be submitted (button disabled)
- Very long prompt shows warning color for character count
- Navigating away and back preserves auth state
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. Sonner toasts appear when triggered
3. Create page shows prompt input for authenticated users
4. Generation flow progresses through all steps
5. Success/error states render correctly
6. Retry functionality works
7. Database stores generations
</verification>

<success_criteria>
- User can type prompt and submit
- Progress steps display during generation
- Successful generation shows result and stores in database
- Failed generation shows error with retry (up to 3 times)
- Toast notifications provide feedback
- Human verifier approves the complete flow
</success_criteria>

<output>
After completion, create `.planning/phases/02-generation-pipeline/02-03-SUMMARY.md`
</output>
