---
phase: 06-code-generation-safe-execution
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - convex/generateAnimation.ts
  - convex/schema.ts
  - convex/lib/validation.ts
autonomous: true

must_haves:
  truths:
    - "Claude generates complete Remotion JSX (not JSON props)"
    - "System prompt uses Remotion's llms.txt patterns"
    - "Generated code is validated before storage"
    - "Schema stores full code string, not props object"
  artifacts:
    - path: "convex/generateAnimation.ts"
      provides: "Updated generation action with JSX output"
      exports: ["generate"]
    - path: "convex/schema.ts"
      provides: "Updated schema with code field"
      contains: "code: v.string()"
    - path: "convex/lib/validation.ts"
      provides: "Updated validation for code output"
  key_links:
    - from: "convex/generateAnimation.ts"
      to: "src/lib/code-validator.ts"
      via: "validates generated code"
      pattern: "validateRemotionCode"
---

<objective>
Update Claude prompt to generate full Remotion JSX code and update Convex schema to store code instead of props.

Purpose: Replace the props-based generation with full code generation. Claude now outputs complete Remotion compositions that can create any animation type.
Output: Updated generation action, schema, and validation that work with JSX code.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-generation-safe-execution/06-CONTEXT.md
@.planning/phases/06-code-generation-safe-execution/06-01-SUMMARY.md
@.planning/phases/06-code-generation-safe-execution/06-02-SUMMARY.md
@convex/generateAnimation.ts
@convex/schema.ts
@convex/lib/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema to store code instead of props</name>
  <files>convex/schema.ts</files>
  <action>
    Update the generations table in convex/schema.ts:

    1. Replace animationProps object with code string:
       ```typescript
       generations: defineTable({
         userId: v.string(),
         prompt: v.string(),
         code: v.string(),           // Full Remotion JSX code
         durationInFrames: v.number(), // Extracted from generation
         fps: v.number(),              // Always 30
         status: v.union(v.literal("success"), v.literal("failed")),
         errorMessage: v.optional(v.string()),
         createdAt: v.number(),
       })
       ```

    2. Keep existing indexes (by_user, by_user_created)

    3. Note: This is a schema change. Existing generations will need migration or can be ignored (dev environment).

    Why store code separately from durationInFrames/fps:
    - Preview player needs these values without parsing code
    - Lambda needs these for render setup
    - Code validation extracts these during generation
  </action>
  <verify>
    - npx convex dev shows schema synced without errors
    - Schema includes code field
  </verify>
  <done>
    generations table stores code, durationInFrames, fps instead of animationProps object
  </done>
</task>

<task type="auto">
  <name>Task 2: Create enhanced system prompt for full JSX generation</name>
  <files>convex/generateAnimation.ts</files>
  <action>
    Rewrite the SYSTEM_PROMPT in convex/generateAnimation.ts to generate full Remotion JSX:

    ```typescript
    const SYSTEM_PROMPT = `You are a Remotion animation code generator. You create complete, self-contained Remotion compositions.

IMPORTANT: Output ONLY valid JSX code. No markdown, no explanations, no code blocks.

Your output must:
1. Define a component named "MyComposition"
2. Use only these imports (already available, don't write import statements):
   - React, useState, useEffect, useMemo, useCallback
   - AbsoluteFill, useCurrentFrame, useVideoConfig, interpolate, spring, Sequence, Easing, random
   - Audio, Img, staticFile, Video, OffthreadVideo
   - Composition, Still, Series, Loop, Freeze

3. Set duration and fps via comments at the top:
   // DURATION: 90
   // FPS: 30

4. Create visually interesting animations using Remotion's features

ALLOWED PATTERNS:
- interpolate(frame, [0, 30], [0, 1]) for smooth transitions
- spring({ frame, fps, config: { damping: 10 } }) for physics-based motion
- useCurrentFrame() to get current frame
- useVideoConfig() for { fps, durationInFrames, width, height }
- <AbsoluteFill> for full-screen containers
- <Sequence from={30}> for timed sequences
- Inline styles with transform, opacity, scale

EXAMPLE OUTPUT:
// DURATION: 90
// FPS: 30

const MyComposition = () => {
  const frame = useCurrentFrame();
  const { fps } = useVideoConfig();

  const opacity = interpolate(frame, [0, 30], [0, 1], {
    extrapolateRight: 'clamp',
  });

  const scale = spring({
    frame,
    fps,
    config: { damping: 10, stiffness: 100 },
  });

  return (
    <AbsoluteFill style={{ backgroundColor: '#1a1a2e' }}>
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100%',
        opacity,
        transform: \`scale(\${scale})\`,
      }}>
        <h1 style={{ color: '#eee', fontSize: 80 }}>Hello World</h1>
      </div>
    </AbsoluteFill>
  );
};

FORBIDDEN:
- import/require statements (APIs are pre-injected)
- eval, Function, setTimeout, setInterval
- fetch, XMLHttpRequest, WebSocket
- document, window, process
- while(true) or infinite loops

Now generate a Remotion composition based on the user's request.`;
    ```

    Key changes from old prompt:
    - Outputs code, not JSON
    - Uses // DURATION and // FPS comments for metadata extraction
    - Explicitly lists allowed Remotion APIs
    - Shows complete example
    - Lists forbidden patterns
  </action>
  <verify>
    - File contains updated SYSTEM_PROMPT
    - Prompt instructs JSX output, not JSON
  </verify>
  <done>
    SYSTEM_PROMPT generates full Remotion JSX with metadata comments
  </done>
</task>

<task type="auto">
  <name>Task 3: Update generation handler with validation pipeline</name>
  <files>
    convex/generateAnimation.ts
    convex/lib/validation.ts
  </files>
  <action>
    Update the generate action handler in convex/generateAnimation.ts:

    1. After receiving Claude's response, extract code and metadata:
       ```typescript
       // Extract metadata from comments
       const durationMatch = code.match(/\/\/\s*DURATION:\s*(\d+)/);
       const fpsMatch = code.match(/\/\/\s*FPS:\s*(\d+)/);

       const durationInFrames = durationMatch ? parseInt(durationMatch[1]) : 90;
       const fps = fpsMatch ? parseInt(fpsMatch[1]) : 30;

       // Clamp values for safety
       const clampedDuration = Math.min(Math.max(durationInFrames, 30), 600);
       const clampedFps = 30; // Always 30 fps
       ```

    2. Validate the code using the validator (import from src/lib):
       ```typescript
       import { validateRemotionCode } from "@/lib/code-validator";
       import { transformJSX } from "@/lib/code-transformer";

       // Note: Convex actions run in Node, so we can import these directly
       // They'll be bundled with the action

       const validation = validateRemotionCode(code);
       if (!validation.valid) {
         throw new Error(`Code validation failed: ${validation.errors[0]?.message || 'Invalid code'}`);
       }

       // Transform JSX for storage
       const transformed = transformJSX(code);
       if (!transformed.success) {
         throw new Error(`Code transformation failed: ${transformed.error}`);
       }
       ```

    3. Store the validated code:
       ```typescript
       const generationId = await ctx.runMutation(internal.generations.store, {
         userId: identity.tokenIdentifier,
         prompt: args.prompt,
         code: transformed.code,  // Store transformed code
         durationInFrames: clampedDuration,
         fps: clampedFps,
         status: "success",
         createdAt: Date.now(),
       });
       ```

    4. Update convex/lib/validation.ts to remove the old textAnimationSchema (no longer needed) or keep for backwards compatibility during transition.

    5. Return the code and metadata to client:
       ```typescript
       return {
         id: generationId,
         code: transformed.code,
         durationInFrames: clampedDuration,
         fps: clampedFps,
       };
       ```

    Important: The validator and transformer run in the Convex Node.js action environment.
    This means we need to ensure the imports work in that context.
    If bundling issues arise, inline the validation logic directly in the action.
  </action>
  <verify>
    - npx convex dev runs without errors
    - npm run build passes
    - Generation action returns { id, code, durationInFrames, fps }
  </verify>
  <done>
    Generate action outputs validated, transformed JSX code
    Schema stores code string instead of props object
    Client receives code ready for DynamicCode composition
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx convex dev` runs and syncs schema
2. `npm run build` succeeds
3. Generation action signature changed:
   - Input: { prompt: string }
   - Output: { id, code, durationInFrames, fps }
4. Schema updated to store code field
</verification>

<success_criteria>
- Claude generates full Remotion JSX code (not JSON props)
- Code is validated before storage
- Schema stores code with extracted metadata
- Generation returns everything needed for preview and render
- Ready for UI integration (Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-generation-safe-execution/06-03-SUMMARY.md`
</output>
