---
phase: 06-code-generation-safe-execution
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - src/components/code-editor/code-display.tsx
  - src/components/preview/preview-player.tsx
  - src/app/create/create-page-client.tsx
autonomous: false

must_haves:
  truths:
    - "User can view generated code in Monaco editor (read-only)"
    - "Preview renders DynamicCode composition with generated code"
    - "Validation errors show inline in editor with red squiggles"
    - "User can copy code to clipboard with prominent button"
  artifacts:
    - path: "src/components/code-editor/code-display.tsx"
      provides: "Monaco-based read-only code display"
      exports: ["CodeDisplay", "CodeDisplayProps"]
    - path: "src/components/preview/preview-player.tsx"
      provides: "Updated preview using DynamicCode"
    - path: "src/app/create/create-page-client.tsx"
      provides: "Updated create page with code panel"
  key_links:
    - from: "src/components/code-editor/code-display.tsx"
      to: "@monaco-editor/react"
      via: "Monaco Editor component"
      pattern: "import.*Editor.*from.*@monaco-editor/react"
    - from: "src/components/preview/preview-player.tsx"
      to: "src/remotion/compositions/DynamicCode.tsx"
      via: "renders dynamic code"
      pattern: "import.*DynamicCode.*from"
---

<objective>
Integrate Monaco editor for code display and update create page to show generated code alongside preview.

Purpose: User can see the generated source code in a professional editor UI. This completes the Phase 6 user-facing features.
Output: Monaco-based code display component, updated preview player, and integrated create page.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-generation-safe-execution/06-CONTEXT.md
@.planning/phases/06-code-generation-safe-execution/06-03-SUMMARY.md
@src/components/preview/preview-player.tsx
@src/app/create/create-page-client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Monaco and create CodeDisplay component</name>
  <files>
    package.json
    src/components/code-editor/code-display.tsx
  </files>
  <action>
    1. Install Monaco Editor:
       ```bash
       npm install @monaco-editor/react
       ```

    2. Create src/components/code-editor/code-display.tsx:
       ```typescript
       "use client";

       import { useState } from "react";
       import Editor from "@monaco-editor/react";
       import { Button } from "@/components/ui/button";
       import { Copy, Check } from "lucide-react";
       import { toast } from "sonner";

       export interface CodeDisplayProps {
         code: string;
         errors?: Array<{
           line: number;
           column: number;
           message: string;
         }>;
       }

       export function CodeDisplay({ code, errors = [] }: CodeDisplayProps) {
         const [copied, setCopied] = useState(false);

         const handleCopy = async () => {
           await navigator.clipboard.writeText(code);
           setCopied(true);
           toast.success("Code copied to clipboard");
           setTimeout(() => setCopied(false), 2000);
         };

         // Set up Monaco markers for inline errors
         const handleEditorMount = (editor, monaco) => {
           if (errors.length > 0) {
             const model = editor.getModel();
             const markers = errors.map(err => ({
               severity: monaco.MarkerSeverity.Error,
               startLineNumber: err.line,
               startColumn: err.column,
               endLineNumber: err.line,
               endColumn: err.column + 10,
               message: err.message,
             }));
             monaco.editor.setModelMarkers(model, "validation", markers);
           }
         };

         return (
           <div className="relative rounded-lg border overflow-hidden">
             {/* Header with copy button */}
             <div className="flex items-center justify-between px-4 py-2 bg-muted border-b">
               <span className="text-sm font-medium">Generated Code</span>
               <Button
                 variant="ghost"
                 size="sm"
                 onClick={handleCopy}
                 className="h-8"
               >
                 {copied ? (
                   <Check className="h-4 w-4 mr-2" />
                 ) : (
                   <Copy className="h-4 w-4 mr-2" />
                 )}
                 {copied ? "Copied" : "Copy"}
               </Button>
             </div>

             {/* Monaco Editor */}
             <Editor
               height="300px"
               language="typescript"
               theme="vs-dark"
               value={code}
               options={{
                 readOnly: true,
                 minimap: { enabled: false },
                 lineNumbers: "on",
                 scrollBeyondLastLine: false,
                 fontSize: 13,
                 wordWrap: "on",
               }}
               onMount={handleEditorMount}
             />
           </div>
         );
       }
       ```

    Key features per CONTEXT.md:
    - Line numbers always visible
    - Prominent copy button
    - Inline errors with red squiggles (via Monaco markers)
    - Read-only mode (editing comes in Phase 7)
    - Dark theme (vs-dark) for code readability
  </action>
  <verify>
    - npm run build passes
    - Monaco editor loads without errors
    - CodeDisplay component renders with code
  </verify>
  <done>
    CodeDisplay shows Monaco editor with line numbers, copy button, and inline errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PreviewPlayer for DynamicCode</name>
  <files>src/components/preview/preview-player.tsx</files>
  <action>
    Update src/components/preview/preview-player.tsx to support both:
    - Legacy TextAnimationProps (for existing templates)
    - New code-based generation via DynamicCode

    Create a new version or update existing:
    ```typescript
    "use client";

    import { useRef, useState, useEffect, useMemo, useCallback } from "react";
    import { Player, type PlayerRef } from "@remotion/player";
    import { Play, Pause, RotateCcw } from "lucide-react";
    import { Button } from "@/components/ui/button";
    import { DynamicCode, type DynamicCodeProps } from "@/remotion/compositions/DynamicCode";

    interface DynamicPreviewProps {
      code: string;
      durationInFrames: number;
      fps: number;
    }

    function PreviewPlayerInner({ code, durationInFrames, fps }: DynamicPreviewProps) {
      const playerRef = useRef<PlayerRef>(null);
      const [isPlaying, setIsPlaying] = useState(true);

      // Memoize inputProps
      const inputProps: DynamicCodeProps = useMemo(() => ({
        code,
        durationInFrames,
        fps,
      }), [code, durationInFrames, fps]);

      // ... existing play/pause/replay handlers ...

      return (
        <div className="w-full space-y-4">
          <div className="rounded-lg overflow-hidden shadow-lg border">
            <Player
              ref={playerRef}
              component={DynamicCode}
              inputProps={inputProps}
              durationInFrames={durationInFrames}
              fps={fps}
              compositionWidth={1920}
              compositionHeight={1080}
              style={{ width: "100%" }}
              controls={false}
              loop={true}
              autoPlay={true}
            />
          </div>
          {/* Custom controls - same as before */}
        </div>
      );
    }

    // Keep existing PreviewPlayer for backwards compatibility with templates
    // Add new DynamicPreviewPlayer for code-based preview

    export function DynamicPreviewPlayer(props: DynamicPreviewProps) {
      const [isMounted, setIsMounted] = useState(false);

      useEffect(() => {
        setIsMounted(true);
      }, []);

      if (!isMounted) {
        return <LoadingPlaceholder />;
      }

      return <PreviewPlayerInner {...props} />;
    }
    ```

    Keep the existing PreviewPlayer export for templates (backwards compatibility).
    Add new DynamicPreviewPlayer export for code-based generation.
  </action>
  <verify>
    - npm run build passes
    - Both PreviewPlayer and DynamicPreviewPlayer exported
    - DynamicPreviewPlayer renders with code prop
  </verify>
  <done>
    DynamicPreviewPlayer renders AI-generated code via DynamicCode composition
    Original PreviewPlayer still works for templates
  </done>
</task>

<task type="auto">
  <name>Task 3: Update create page with code panel</name>
  <files>src/app/create/create-page-client.tsx</files>
  <action>
    Update src/app/create/create-page-client.tsx to:

    1. Import new components:
       ```typescript
       import { CodeDisplay } from "@/components/code-editor/code-display";
       import { DynamicPreviewPlayer } from "@/components/preview/preview-player";
       ```

    2. Update state to hold code result:
       ```typescript
       interface GenerationResult {
         id: string;
         code: string;
         durationInFrames: number;
         fps: number;
       }
       ```

    3. Update success state rendering to show both preview and code:
       ```typescript
       {lastGeneration && !isGenerating && !error && (
         <div className="w-full max-w-4xl mb-6">
           {/* Two-column layout: Preview | Code */}
           <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
             {/* Preview */}
             <div>
               <DynamicPreviewPlayer
                 code={lastGeneration.code}
                 durationInFrames={lastGeneration.durationInFrames}
                 fps={lastGeneration.fps}
               />
             </div>

             {/* Code */}
             <div>
               <CodeDisplay code={lastGeneration.code} />
             </div>
           </div>

           {/* Render section - same as before but update RenderButton props */}
           <div className="mt-4 p-4 bg-muted/50 rounded-lg space-y-4">
             {/* ... existing render controls ... */}
           </div>
         </div>
       )}
       ```

    4. Update RenderButton integration:
       - RenderButton will need to be updated to pass code instead of animationProps
       - For now, keep both working - render pipeline update is separate

    Layout decision (per CONTEXT.md, Claude's discretion):
    - Use side-by-side on large screens (lg:grid-cols-2)
    - Stack on mobile (grid-cols-1)
    - Preview on left, code on right (natural flow)
  </action>
  <verify>
    - npm run build passes
    - Create page shows preview and code side by side
    - Code can be copied from editor
  </verify>
  <done>
    Create page displays generated code in Monaco editor alongside preview
    Two-column layout on desktop, stacked on mobile
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 6 implementation:
    - Code validation infrastructure (AST parsing, whitelist, transformation)
    - DynamicCode composition for runtime code execution
    - Updated Claude prompt for full JSX generation
    - Monaco editor for code display
    - Integrated create page with preview + code view
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Navigate to /create
    3. Enter a prompt like: "Create a bouncing ball animation with a red circle moving up and down"
    4. Wait for generation to complete
    5. Verify:
       - Preview shows animation (may be simple at first, Claude needs prompt tuning)
       - Code appears in Monaco editor on the right
       - Line numbers are visible
       - Copy button works
       - If validation fails, error shows in editor
    6. Try another prompt: "Animated text that fades in and scales up"
    7. Verify animation renders and code updates
  </how-to-verify>
  <resume-signal>Type "approved" if the flow works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` starts without errors
2. Generation produces viewable preview + copyable code
3. Monaco editor shows line numbers and copy button
4. Phase 6 requirements satisfied:
   - CODE-01: Full code generation
   - CODE-02: AST validation
   - CODE-03: Sandboxed execution
   - CODE-04: Read-only code view
</verification>

<success_criteria>
- User can generate any animation type via prompt
- System generates complete Remotion JSX
- Code is validated and executed safely
- User can view code in Monaco editor
- User can copy generated code
- Preview and code display side by side
- End-to-end flow works from prompt to preview
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-generation-safe-execution/06-04-SUMMARY.md`
</output>
