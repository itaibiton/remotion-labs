---
phase: 06-code-generation-safe-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/code-validator.ts
  - src/lib/code-transformer.ts
  - src/lib/remotion-allowlist.ts
autonomous: true

must_haves:
  truths:
    - "AST parser rejects code with disallowed patterns (eval, Function, import)"
    - "AST parser accepts valid Remotion code (AbsoluteFill, useCurrentFrame, interpolate)"
    - "JSX transformation produces executable JavaScript"
  artifacts:
    - path: "src/lib/remotion-allowlist.ts"
      provides: "Whitelist of allowed identifiers, APIs, imports"
      exports: ["ALLOWED_IMPORTS", "ALLOWED_GLOBALS", "BLOCKED_PATTERNS"]
    - path: "src/lib/code-validator.ts"
      provides: "AST-based code validation"
      exports: ["validateRemotionCode", "ValidationResult"]
    - path: "src/lib/code-transformer.ts"
      provides: "JSX to JS transformation via sucrase"
      exports: ["transformJSX", "TransformResult"]
  key_links:
    - from: "src/lib/code-validator.ts"
      to: "src/lib/remotion-allowlist.ts"
      via: "import allowlist for validation"
      pattern: "import.*ALLOWED.*from.*remotion-allowlist"
---

<objective>
Build code validation infrastructure: AST parsing with acorn + acorn-jsx, whitelist validation, and JSX transformation via sucrase.

Purpose: Security foundation - all AI-generated code must pass validation before execution. This is the first line of defense against malicious patterns.
Output: Three modules that form the validation pipeline: allowlist definition, AST validator, and JSX transformer.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-code-generation-safe-execution/06-CONTEXT.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Remotion allowlist</name>
  <files>
    package.json
    src/lib/remotion-allowlist.ts
  </files>
  <action>
    1. Install AST parsing and transformation packages:
       - acorn (JavaScript parser)
       - acorn-jsx (JSX parsing extension)
       - sucrase (fast JSX-to-JS transformation)

    2. Create src/lib/remotion-allowlist.ts defining:
       - ALLOWED_IMPORTS: Only "remotion", "@remotion/*", "react" packages
       - ALLOWED_GLOBALS: React, AbsoluteFill, useCurrentFrame, useVideoConfig, interpolate, spring, Sequence, Audio, Img, staticFile, random, Easing, etc.
       - BLOCKED_PATTERNS: List of dangerous identifiers to reject (eval, Function, import, require, fetch, XMLHttpRequest, WebSocket, document, window, process, globalThis, __dirname, __filename)

    Key decisions:
    - Use explicit whitelist (not blocklist) for imports - only allow known safe packages
    - Block ALL dynamic code execution (eval, new Function, import())
    - Block ALL network access (fetch, XMLHttpRequest, WebSocket)
    - Block ALL DOM access (document, window)
    - Block ALL Node.js globals (process, __dirname, etc.)
  </action>
  <verify>
    - npm install completes without errors
    - src/lib/remotion-allowlist.ts exists with exports
    - npm run build passes (TypeScript compiles)
  </verify>
  <done>
    Allowlist module exports ALLOWED_IMPORTS, ALLOWED_GLOBALS, and BLOCKED_PATTERNS arrays/sets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AST validator with acorn</name>
  <files>src/lib/code-validator.ts</files>
  <action>
    Create src/lib/code-validator.ts that:

    1. Parses JSX code using acorn with acorn-jsx plugin
    2. Walks the AST to validate against allowlist:
       - ImportDeclaration: source must be in ALLOWED_IMPORTS
       - Identifier: reject if in BLOCKED_PATTERNS (eval, Function, etc.)
       - CallExpression: reject import(), require(), eval()
       - MemberExpression: reject document.*, window.*, process.*
       - NewExpression: reject new Function(), new WebSocket(), etc.

    3. Returns ValidationResult type:
       ```typescript
       interface ValidationResult {
         valid: boolean;
         errors: Array<{
           line: number;
           column: number;
           message: string;  // Generic message, no blocklist details
         }>;
       }
       ```

    4. Error messages must be GENERIC per CONTEXT.md:
       - "Code contains unsafe patterns" (don't reveal what was blocked)
       - Include line/column for Monaco inline errors

    Implementation notes:
    - Use acorn's ecmaVersion: "latest" with sourceType: "module"
    - acorn-jsx extends acorn.Parser
    - Walk AST with simple recursive function (no need for estree-walker dependency)
    - Catch parse errors and return as validation errors
  </action>
  <verify>
    - npm run build passes
    - File exports validateRemotionCode function and ValidationResult type
  </verify>
  <done>
    validateRemotionCode("const x = eval('code')") returns { valid: false, errors: [...] }
    validateRemotionCode("import { AbsoluteFill } from 'remotion'") returns { valid: true, errors: [] }
  </done>
</task>

<task type="auto">
  <name>Task 3: Create JSX transformer with sucrase</name>
  <files>src/lib/code-transformer.ts</files>
  <action>
    Create src/lib/code-transformer.ts that:

    1. Uses sucrase to transform JSX to JavaScript:
       - transforms: ["jsx", "typescript"] (handle both)
       - jsxRuntime: "classic" (React.createElement style, compatible with Remotion)

    2. Returns TransformResult type:
       ```typescript
       interface TransformResult {
         success: boolean;
         code?: string;  // Transformed JS code
         error?: string; // Error message if transformation failed
       }
       ```

    3. Handle transformation errors gracefully:
       - Catch sucrase errors
       - Return descriptive error message with line info if available

    Why sucrase over Babel:
    - 10x faster (we're transforming per-generation)
    - Simpler API, single purpose
    - Good enough for JSX -> JS (we don't need polyfills or complex transforms)
  </action>
  <verify>
    - npm run build passes
    - File exports transformJSX function and TransformResult type
  </verify>
  <done>
    transformJSX("<div>hello</div>") returns { success: true, code: "React.createElement(...)" }
    transformJSX("<invalid") returns { success: false, error: "..." }
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `npm run lint` passes (or has only pre-existing warnings)
3. All three files exist with correct exports:
   - src/lib/remotion-allowlist.ts
   - src/lib/code-validator.ts
   - src/lib/code-transformer.ts
</verification>

<success_criteria>
- Validation module correctly rejects dangerous patterns (eval, fetch, import())
- Validation module correctly accepts valid Remotion code
- Transformer converts JSX to executable JavaScript
- All TypeScript compiles without errors
- Foundation ready for code executor (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/06-code-generation-safe-execution/06-01-SUMMARY.md`
</output>
