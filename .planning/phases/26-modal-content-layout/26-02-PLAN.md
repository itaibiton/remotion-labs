---
phase: 26-modal-content-layout
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - src/components/creation/creation-modal.tsx
autonomous: false

must_haves:
  truths:
    - "Modal displays large preview player in center area"
    - "Clicking Save in detail panel saves generation to clip library"
    - "Clicking Delete in detail panel deletes generation (with confirmation)"
    - "Clicking Rerun regenerates with same prompt"
    - "Clicking Extend Next/Previous initiates continuation/prequel"
    - "Submitting refinement prompt updates the animation preview"
  artifacts:
    - path: "src/components/creation/creation-modal.tsx"
      provides: "Fully wired modal with action handlers and refinement"
      min_lines: 200
  key_links:
    - from: "src/components/creation/creation-modal.tsx"
      to: "api.clips.save"
      via: "useMutation for save action"
      pattern: "useMutation.*api\\.clips\\.save"
    - from: "src/components/creation/creation-modal.tsx"
      to: "api.generations.remove"
      via: "useMutation for delete action"
      pattern: "useMutation.*api\\.generations\\.remove"
    - from: "src/components/creation/creation-modal.tsx"
      to: "api.generateAnimation.refine"
      via: "useAction for refinement"
      pattern: "useAction.*api\\.generateAnimation\\.refine"
---

<objective>
Wire up action handlers and refinement callback in CreationModal to make the UI fully functional.

Purpose: UI-01, UI-02, UI-03, UI-04 require the modal to coordinate actions between components. Plan 01 created the UI components; this plan connects them to the backend.
Output: Fully functional creation detail modal where all buttons work and refinement updates the preview.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-modal-content-layout/26-RESEARCH.md

# Prior plan summary (required - uses components from this plan)
@.planning/phases/26-modal-content-layout/26-01-SUMMARY.md

# Key source files
@src/components/creation/creation-modal.tsx
@src/app/(app)/create/create-page-client.tsx
@convex/generateAnimation.ts
@convex/clips.ts
@convex/generations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire action handlers and refinement in CreationModal</name>
  <files>src/components/creation/creation-modal.tsx</files>
  <action>
Update CreationModal to:

**1. Add mutations and actions:**
```typescript
const saveClip = useMutation(api.clips.save);
const removeGeneration = useMutation(api.generations.remove);
const refineAction = useAction(api.generateAnimation.refine);
```

**2. Add local state for refinement:**
```typescript
const [isRefining, setIsRefining] = useState(false);
const [refinedCode, setRefinedCode] = useState<{
  rawCode: string;
  code: string;
  durationInFrames: number;
  fps: number;
} | null>(null);
```

**3. Implement action handlers:**

**handleSave:**
```typescript
const handleSave = useCallback(async () => {
  if (!generation?.code || !generation?.rawCode) {
    toast.error("Cannot save: generation has no code");
    return;
  }
  try {
    await saveClip({
      name: generation.prompt.slice(0, 50) || "Untitled",
      code: generation.code,
      rawCode: generation.rawCode,
      durationInFrames: generation.durationInFrames ?? 90,
      fps: generation.fps ?? 30,
    });
    toast.success("Saved to clip library!");
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to save clip");
  }
}, [generation, saveClip]);
```

**handleDelete:**
```typescript
const handleDelete = useCallback(async () => {
  if (!generation) return;
  try {
    await removeGeneration({ id: generation._id });
    toast.success("Generation deleted");
    handleClose(); // Close modal after delete
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to delete generation");
  }
}, [generation, removeGeneration, handleClose]);
```

**handleRerun:**
Navigate to create page with prompt query param to trigger regeneration:
```typescript
const handleRerun = useCallback(() => {
  if (!generation?.prompt) return;
  setIsOpen(false);
  setTimeout(() => {
    router.push(`/create?prompt=${encodeURIComponent(generation.prompt)}`);
  }, 150);
}, [generation, router]);
```

**handleExtendNext:**
Save as clip then navigate to continuation:
```typescript
const handleExtendNext = useCallback(async () => {
  if (!generation?.code || !generation?.rawCode) {
    toast.error("Cannot extend: generation has no code");
    return;
  }
  try {
    const clipId = await saveClip({
      name: generation.prompt.slice(0, 50) || "Untitled",
      code: generation.code,
      rawCode: generation.rawCode,
      durationInFrames: generation.durationInFrames ?? 90,
      fps: generation.fps ?? 30,
    });
    toast.success("Saved as clip -- opening continuation...");
    setIsOpen(false);
    setTimeout(() => {
      router.push(`/create?sourceClipId=${clipId}`);
    }, 150);
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to start continuation");
  }
}, [generation, saveClip, router]);
```

**handleExtendPrevious:**
Similar pattern with `sourceMode=prequel`:
```typescript
const handleExtendPrevious = useCallback(async () => {
  if (!generation?.code || !generation?.rawCode) {
    toast.error("Cannot extend: generation has no code");
    return;
  }
  try {
    const clipId = await saveClip({
      name: generation.prompt.slice(0, 50) || "Untitled",
      code: generation.code,
      rawCode: generation.rawCode,
      durationInFrames: generation.durationInFrames ?? 90,
      fps: generation.fps ?? 30,
    });
    toast.success("Saved as clip -- opening prequel mode...");
    setIsOpen(false);
    setTimeout(() => {
      router.push(`/create?sourceClipId=${clipId}&sourceMode=prequel`);
    }, 150);
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Failed to start prequel");
  }
}, [generation, saveClip, router]);
```

**handleRefine:**
```typescript
const handleRefine = useCallback(async (prompt: string) => {
  if (!generation?.rawCode) {
    toast.error("Cannot refine: no code to refine");
    return;
  }
  setIsRefining(true);
  try {
    const result = await refineAction({
      currentCode: generation.rawCode,
      refinementPrompt: prompt,
      conversationHistory: [],
    });
    setRefinedCode(result);
    toast.success("Animation refined!");
  } catch (e) {
    toast.error(e instanceof Error ? e.message : "Refinement failed");
  } finally {
    setIsRefining(false);
  }
}, [generation, refineAction]);
```

**4. Update PreviewPlayer to use refined code:**
```typescript
// Use refined code if available, otherwise original generation code
const previewCode = refinedCode?.code ?? generation?.code;
const previewDuration = refinedCode?.durationInFrames ?? generation?.durationInFrames ?? 90;
const previewFps = refinedCode?.fps ?? generation?.fps ?? 30;
```

**5. Pass props to components:**
```typescript
<CreationEditBar
  generationId={generationId}
  initialPrompt={generation.prompt}
  onRefine={handleRefine}
  isRefining={isRefining}
/>

<CreationDetailPanel
  generation={generation}
  onSave={handleSave}
  onDelete={handleDelete}
  onRerun={handleRerun}
  onExtendNext={handleExtendNext}
  onExtendPrevious={handleExtendPrevious}
/>
```

**6. Add toast import:**
```typescript
import { toast } from "sonner";
```

**7. Reset refinedCode when navigating to different generation:**
Add to existing effects or create new one:
```typescript
useEffect(() => {
  setRefinedCode(null);
}, [generationId]);
```
  </action>
  <verify>
- `npx tsc --noEmit` passes
- File imports useMutation, useAction from convex/react
- File imports toast from sonner
- File passes all 6 callbacks to CreationDetailPanel
- File passes onRefine and isRefining to CreationEditBar
  </verify>
  <done>
- All action buttons in detail panel are functional
- Refinement updates preview in real-time
- Navigation actions (rerun, extend) close modal and navigate
- Delete closes modal after successful deletion
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Full modal content layout with functional actions and inline refinement
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/create
3. If no generations exist, create one with any prompt
4. Click a successful generation in the feed to open the modal

**Verify UI-01 (Preview in center):**
- [ ] Large preview player visible in center/left area of modal
- [ ] Preview plays the animation correctly for all aspect ratios

**Verify UI-02 (Details panel with metadata):**
- [ ] Right panel shows "Prompt" section with full prompt text
- [ ] Thumbnail preview visible (shows mid-animation frame)
- [ ] Metadata shows: Aspect Ratio, Duration, FPS, Created time
- [ ] Created time shows relative format ("2h ago", "just now", etc.)

**Verify UI-03 (Action buttons):**
- [ ] "Save to Library" button saves and shows success toast
- [ ] "Delete" button shows confirmation dialog, then deletes and closes modal
- [ ] "Rerun" button closes modal and navigates to /create with prompt
- [ ] "Extend Next" saves as clip and navigates to continuation mode
- [ ] "Extend Previous" saves as clip and navigates to prequel mode

**Verify UI-04 (Edit bar refinement):**
- [ ] Textarea at top of modal accepts input
- [ ] Cmd/Ctrl+Enter submits refinement
- [ ] "Refine" button submits refinement
- [ ] Loading spinner appears during refinement
- [ ] After refinement, preview updates to show refined animation
- [ ] Textarea clears after successful refinement

**Edge cases:**
- [ ] Arrow key navigation still works (not blocked by edit bar focus)
- [ ] Escape still closes modal
- [ ] Clicking backdrop still closes modal
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. All 4 requirements (UI-01, UI-02, UI-03, UI-04) verified via checkpoint
</verification>

<success_criteria>
- Modal displays preview player, details panel, and edit bar (UI-01, UI-02, UI-04)
- All action buttons work (save, delete, rerun, extend next/prev) (UI-03)
- Refinement updates preview without page reload
- No TypeScript errors
- No console errors in browser
</success_criteria>

<output>
After completion, create `.planning/phases/26-modal-content-layout/26-02-SUMMARY.md`
</output>
