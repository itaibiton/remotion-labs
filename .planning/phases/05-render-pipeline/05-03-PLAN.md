---
phase: 05-render-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/render/render-button.tsx
  - src/components/render/render-progress.tsx
  - src/components/render/download-button.tsx
  - src/components/render/index.ts
autonomous: true

must_haves:
  truths:
    - "User can click button to trigger render"
    - "User sees real-time progress percentage"
    - "User can download completed video"
  artifacts:
    - path: "src/components/render/render-button.tsx"
      provides: "Render trigger button"
      exports: ["RenderButton"]
    - path: "src/components/render/render-progress.tsx"
      provides: "Real-time progress display"
      exports: ["RenderProgress"]
    - path: "src/components/render/download-button.tsx"
      provides: "Download MP4 button"
      exports: ["DownloadButton"]
  key_links:
    - from: "src/components/render/render-button.tsx"
      to: "convex/triggerRender.ts"
      via: "useAction hook"
      pattern: "useAction.*startRender"
    - from: "src/components/render/render-progress.tsx"
      to: "convex/renders.ts"
      via: "useQuery subscription"
      pattern: "useQuery.*renders\\.get"
---

<objective>
Create React components for render UI: trigger button, real-time progress display, and download button.

Purpose: These components provide the user interface for the render pipeline. They connect to Convex actions/queries to trigger renders and display progress via reactive subscriptions.

Output: RenderButton, RenderProgress, and DownloadButton components with Convex integration.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-render-pipeline/05-RESEARCH.md

# Schema for render state types
@convex/schema.ts

# UI pattern reference
@src/components/generation/generation-status.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RenderButton component</name>
  <files>
    src/components/render/render-button.tsx
  </files>
  <action>
Create src/components/render/render-button.tsx:

```typescript
"use client";

import { useState, useCallback } from "react";
import { useAction } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { Id } from "../../../convex/_generated/dataModel";
import { Button } from "@/components/ui/button";
import { Video, Loader2 } from "lucide-react";
import { toast } from "sonner";
import type { TextAnimationProps } from "@/remotion/compositions/TextAnimation";

interface RenderButtonProps {
  generationId: Id<"generations">;
  animationProps: TextAnimationProps;
  onRenderStarted: (renderJobId: Id<"renders">) => void;
  disabled?: boolean;
}

export function RenderButton({
  generationId,
  animationProps,
  onRenderStarted,
  disabled = false,
}: RenderButtonProps) {
  const startRender = useAction(api.triggerRender.startRender);
  const [isStarting, setIsStarting] = useState(false);

  const handleRender = useCallback(async () => {
    setIsStarting(true);
    try {
      const result = await startRender({
        generationId,
        animationProps,
      });
      toast.success("Render started!");
      onRenderStarted(result.renderJobId as Id<"renders">);
    } catch (error) {
      const message = error instanceof Error ? error.message : "Failed to start render";
      toast.error(message);
    } finally {
      setIsStarting(false);
    }
  }, [startRender, generationId, animationProps, onRenderStarted]);

  return (
    <Button
      onClick={handleRender}
      disabled={disabled || isStarting}
      className="gap-2"
    >
      {isStarting ? (
        <>
          <Loader2 className="h-4 w-4 animate-spin" />
          Starting...
        </>
      ) : (
        <>
          <Video className="h-4 w-4" />
          Render Video
        </>
      )}
    </Button>
  );
}
```

Key design decisions:
- Takes generationId and animationProps as props
- onRenderStarted callback to notify parent of render job ID
- Uses sonner for toast notifications (consistent with app)
- Shows loading state while starting
- Handles rate limit errors gracefully
  </action>
  <verify>
    - File exists: src/components/render/render-button.tsx
    - No TypeScript errors
    - Imports resolve correctly
  </verify>
  <done>
    - RenderButton component triggers startRender action
    - Loading state while starting
    - Error handling with toast
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RenderProgress component</name>
  <files>
    src/components/render/render-progress.tsx
  </files>
  <action>
Create src/components/render/render-progress.tsx:

```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { Id } from "../../../convex/_generated/dataModel";
import { Loader2, CheckCircle2, XCircle } from "lucide-react";
import { DownloadButton } from "./download-button";

interface RenderProgressProps {
  renderJobId: Id<"renders">;
}

export function RenderProgress({ renderJobId }: RenderProgressProps) {
  // Reactive subscription - automatically updates when render state changes
  const render = useQuery(api.renders.get, { id: renderJobId });

  if (!render) {
    return (
      <div className="flex items-center gap-2 text-muted-foreground">
        <Loader2 className="h-4 w-4 animate-spin" />
        <span>Loading...</span>
      </div>
    );
  }

  // Complete state
  if (render.status === "complete") {
    return (
      <div className="space-y-3">
        <div className="flex items-center gap-2 text-green-600">
          <CheckCircle2 className="h-5 w-5" />
          <span className="font-medium">Render complete!</span>
        </div>
        {render.outputUrl && (
          <DownloadButton url={render.outputUrl} />
        )}
        {render.outputSize && (
          <p className="text-xs text-muted-foreground">
            Size: {formatBytes(render.outputSize)}
          </p>
        )}
      </div>
    );
  }

  // Failed state
  if (render.status === "failed") {
    return (
      <div className="space-y-2">
        <div className="flex items-center gap-2 text-red-600">
          <XCircle className="h-5 w-5" />
          <span className="font-medium">Render failed</span>
        </div>
        {render.error && (
          <p className="text-sm text-muted-foreground">{render.error}</p>
        )}
      </div>
    );
  }

  // Rendering state - show progress bar
  return (
    <div className="w-full space-y-2">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Loader2 className="h-4 w-4 animate-spin text-primary" />
          <span className="text-sm font-medium">Rendering...</span>
        </div>
        <span className="text-sm text-muted-foreground">{render.progress}%</span>
      </div>
      <div className="w-full bg-muted rounded-full h-2 overflow-hidden">
        <div
          className="bg-primary h-full rounded-full transition-all duration-500 ease-out"
          style={{ width: `${render.progress}%` }}
        />
      </div>
      <p className="text-xs text-muted-foreground">
        This usually takes 30-60 seconds
      </p>
    </div>
  );
}

// Helper to format bytes
function formatBytes(bytes: number): string {
  if (bytes === 0) return "0 Bytes";
  const k = 1024;
  const sizes = ["Bytes", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
}
```

Key implementation notes:
- Uses useQuery for reactive subscription (auto-updates)
- Progress bar with smooth transition animation
- Shows different states: loading, rendering, complete, failed
- Displays file size when complete
- Includes DownloadButton when render is complete
  </action>
  <verify>
    - File exists: src/components/render/render-progress.tsx
    - No TypeScript errors
    - useQuery references correct Convex query
  </verify>
  <done>
    - RenderProgress subscribes to render state
    - Real-time progress bar updates
    - Complete/failed states handled
    - Download button shown when complete
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DownloadButton component and barrel export</name>
  <files>
    src/components/render/download-button.tsx
    src/components/render/index.ts
  </files>
  <action>
1. Create src/components/render/download-button.tsx:

```typescript
"use client";

import { Button } from "@/components/ui/button";
import { Download } from "lucide-react";

interface DownloadButtonProps {
  url: string;
  filename?: string;
}

export function DownloadButton({ url, filename = "animation.mp4" }: DownloadButtonProps) {
  const handleDownload = () => {
    // Create a temporary link and trigger download
    const link = document.createElement("a");
    link.href = url;
    link.download = filename;
    link.target = "_blank"; // Opens in new tab if download fails
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <Button onClick={handleDownload} className="gap-2">
      <Download className="h-4 w-4" />
      Download MP4
    </Button>
  );
}
```

2. Create src/components/render/index.ts (barrel export):

```typescript
export { RenderButton } from "./render-button";
export { RenderProgress } from "./render-progress";
export { DownloadButton } from "./download-button";
```

Design notes:
- DownloadButton creates a temp link for download
- Uses target="_blank" as fallback if download attribute not supported
- Barrel export for clean imports
  </action>
  <verify>
    - Files exist: src/components/render/download-button.tsx, src/components/render/index.ts
    - No TypeScript errors
    - All components importable from @/components/render
  </verify>
  <done>
    - DownloadButton triggers file download
    - Barrel export allows clean imports
    - All three render components complete
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. All files exist in src/components/render/
2. No TypeScript errors
3. Components import correctly: `import { RenderButton, RenderProgress } from "@/components/render"`
4. Convex hooks (useAction, useQuery) reference correct endpoints
</verification>

<success_criteria>
- RenderButton triggers render via action
- RenderProgress shows real-time progress via reactive query
- DownloadButton enables MP4 download
- All components follow existing design patterns
- Loading and error states handled
</success_criteria>

<output>
After completion, create `.planning/phases/05-render-pipeline/05-03-SUMMARY.md`
</output>
