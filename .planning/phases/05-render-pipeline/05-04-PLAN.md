---
phase: 05-render-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/app/create/create-page-client.tsx
autonomous: false

must_haves:
  truths:
    - "User can trigger render from preview screen"
    - "User sees render progress after clicking Render"
    - "User can download completed video"
    - "Full flow works end-to-end"
  artifacts:
    - path: "src/app/create/create-page-client.tsx"
      provides: "Integrated render flow in create page"
      contains: "RenderButton"
  key_links:
    - from: "src/app/create/create-page-client.tsx"
      to: "src/components/render/render-button.tsx"
      via: "component import"
      pattern: "import.*RenderButton"
    - from: "src/app/create/create-page-client.tsx"
      to: "src/components/render/render-progress.tsx"
      via: "component import"
      pattern: "import.*RenderProgress"
---

<objective>
Integrate render components into the create page flow and verify the complete end-to-end render pipeline.

Purpose: This final plan wires the render button and progress components into the existing create page, completing the v1.0 feature set. Users will be able to generate -> preview -> render -> download in a single flow.

Output: Updated create-page-client.tsx with render integration, verified working end-to-end flow.
</objective>

<execution_context>
@/Users/Kohelet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Kohelet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-render-pipeline/05-RESEARCH.md

# Existing create page to modify
@src/app/create/create-page-client.tsx

# Render components from Plan 03
@src/components/render/render-button.tsx
@src/components/render/render-progress.tsx

# Preview player for context
@src/components/preview/preview-player.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate render components into create page</name>
  <files>
    src/app/create/create-page-client.tsx
  </files>
  <action>
Modify src/app/create/create-page-client.tsx to add render functionality after successful generation.

Changes needed:

1. Add imports at the top:
```typescript
import { RenderButton, RenderProgress } from "@/components/render";
import { Id } from "../../../convex/_generated/dataModel";
```

2. Add state for render tracking in CreateContent:
```typescript
const [currentRenderJobId, setCurrentRenderJobId] = useState<Id<"renders"> | null>(null);
```

3. Add handler for render started:
```typescript
const handleRenderStarted = useCallback((renderJobId: Id<"renders">) => {
  setCurrentRenderJobId(renderJobId);
}, []);
```

4. Reset render state when generating new animation (in handleGenerate, after setError(null)):
```typescript
setCurrentRenderJobId(null);
```

5. Update the success state section (where PreviewPlayer is shown) to include render UI:
Replace the existing success state block:
```typescript
{/* Success state */}
{lastGeneration && !isGenerating && !error && (
  <div className="w-full max-w-2xl mb-6">
    <PreviewPlayer animationProps={lastGeneration.animationProps} />

    {/* Render section */}
    <div className="mt-4 p-4 bg-muted/50 rounded-lg space-y-4">
      {/* Animation info */}
      <div className="flex items-center justify-between">
        <div className="text-sm text-muted-foreground">
          <p>
            <span className="font-medium">Text:</span>{" "}
            {lastGeneration.animationProps.text}
          </p>
          <p>
            <span className="font-medium">Style:</span>{" "}
            {lastGeneration.animationProps.style}
          </p>
        </div>
        <button
          onClick={handleRetry}
          className="text-sm text-primary underline hover:no-underline"
        >
          Regenerate
        </button>
      </div>

      {/* Render controls */}
      <div className="pt-2 border-t">
        {currentRenderJobId ? (
          <RenderProgress renderJobId={currentRenderJobId} />
        ) : (
          <div className="flex items-center justify-between">
            <p className="text-sm text-muted-foreground">
              Happy with the preview? Render to download as MP4.
            </p>
            <RenderButton
              generationId={lastGeneration.id as Id<"generations">}
              animationProps={lastGeneration.animationProps}
              onRenderStarted={handleRenderStarted}
            />
          </div>
        )}
      </div>
    </div>
  </div>
)}
```

Key integration notes:
- RenderButton shown when no render in progress
- RenderProgress shown once render starts
- Render state resets on new generation
- Layout consistent with existing design
  </action>
  <verify>
    - No TypeScript errors in create-page-client.tsx
    - `npm run build` succeeds
    - Dev server runs: `npm run dev`
  </verify>
  <done>
    - RenderButton integrated into success state
    - RenderProgress shows when render active
    - State management for render flow complete
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete render flow</name>
  <what-built>
Complete render pipeline:
- Backend: renders table, rate limiting, triggerRender action, polling
- UI: RenderButton, RenderProgress, DownloadButton
- Integration: create page with render flow
  </what-built>
  <how-to-verify>
**Prerequisites:**
Before testing, ensure AWS/Remotion Lambda is configured:
1. Check env vars are set in Convex dashboard:
   - REMOTION_AWS_ACCESS_KEY_ID
   - REMOTION_AWS_SECRET_ACCESS_KEY
   - REMOTION_LAMBDA_FUNCTION_NAME
   - REMOTION_SERVE_URL

2. If not configured, Lambda calls will fail with "Render service not configured" error.

**Test the flow:**
1. Go to http://localhost:3000/create
2. Generate an animation (e.g., "Hello world with fade in effect")
3. Wait for preview to appear
4. Click "Render Video" button
5. Observe:
   - Button shows "Starting..." then progress bar appears
   - Progress percentage updates (may take 30-60 seconds)
   - When complete, "Download MP4" button appears
6. Click "Download MP4" - file should download

**Rate limiting test:**
1. Render 5 times within an hour
2. 6th render should fail with quota exceeded message

**Error handling test:**
1. If Lambda not configured, should see "Render service not configured" error
2. Error should display in toast notification
  </how-to-verify>
  <resume-signal>
Type "approved" if render flow works end-to-end, or describe any issues encountered.

Note: If AWS/Lambda not yet configured, type "skip-aws" to approve the code integration without testing Lambda. AWS setup can be done later.
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Create page shows Render Video button after generation
2. Progress bar updates in real-time during render
3. Download button appears when complete
4. Rate limiting enforced (5/hour)
5. Error states handled gracefully
</verification>

<success_criteria>
- User can trigger render from create page
- User sees real-time progress during render
- User can download MP4 when complete
- Rate limiting works (5 renders/hour)
- Error handling provides clear feedback
- Full end-to-end flow verified
</success_criteria>

<output>
After completion, create `.planning/phases/05-render-pipeline/05-04-SUMMARY.md`
</output>
